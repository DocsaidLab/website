<!doctype html><html lang=zh-hant dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-nginx-notes/monitoring" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.8.0"><title data-rh=true>Nginx 日誌與監控 | DOCSAID</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://docsaid.org/img/docsaid-social-card.jpg><meta data-rh=true name=twitter:image content=https://docsaid.org/img/docsaid-social-card.jpg><meta data-rh=true property=og:url content=https://docsaid.org/docs/nginx-notes/monitoring><meta data-rh=true property=og:locale content=zh_hant><meta data-rh=true property=og:locale:alternate content=en><meta data-rh=true property=og:locale:alternate content=ja><meta data-rh=true name=docusaurus_locale content=zh-hant><meta data-rh=true name=docsearch:language content=zh-hant><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Nginx 日誌與監控 | DOCSAID"><meta data-rh=true name=description content="將 API 對外開放之後，我們立刻就會收到來自四面八方的惡意請求。"><meta data-rh=true property=og:description content="將 API 對外開放之後，我們立刻就會收到來自四面八方的惡意請求。"><link data-rh=true rel=icon href=/img/favicon.ico><link data-rh=true rel=canonical href=https://docsaid.org/docs/nginx-notes/monitoring><link data-rh=true rel=alternate href=https://docsaid.org/docs/nginx-notes/monitoring hreflang=zh-hant><link data-rh=true rel=alternate href=https://docsaid.org/en/docs/nginx-notes/monitoring hreflang=en><link data-rh=true rel=alternate href=https://docsaid.org/ja/docs/nginx-notes/monitoring hreflang=ja><link data-rh=true rel=alternate href=https://docsaid.org/docs/nginx-notes/monitoring hreflang=x-default><link data-rh=true rel=preconnect href=https://S9NC0RYCHF-dsn.algolia.net crossorigin=anonymous><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://docsaid.org/docs/nginx-notes/","name":"Nginx Notes","position":1},{"@type":"ListItem","item":"https://docsaid.org/docs/nginx-notes/monitoring","name":"Nginx 日誌與監控","position":2}]}</script><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="DOCSAID RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="DOCSAID Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-RDF83L9R4M"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RDF83L9R4M",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=DOCSAID href=/opensearch.xml><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><link rel=stylesheet href=/assets/css/styles.8e7b88e9.css><script src=/assets/js/runtime~main.89e7d1c6.js defer></script><script src=/assets/js/main.b9022380.js defer></script><body class=navigation-with-keyboard><svg xmlns=http://www.w3.org/2000/svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light",e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label=跳至主要内容><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>跳至主要内容</a></div><nav aria-label=主導航 class="navbar navbar--fixed-top navbarHideable_jvwV"><div class=navbar__inner><div class=navbar__items><button aria-label=切換導覽列 aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/docsaid_logo.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/docsaid_logo_white.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/docs/>開源專案</a><a class="navbar__item navbar__link" href=/papers/intro>論文筆記</a><a class="navbar__item navbar__link" href=/blog>部落格</a><a class="navbar__item navbar__link" href=/playground/intro>遊樂場</a><a class="navbar__item navbar__link" href=/services>技術服務</a><a class="navbar__item navbar__link" href=/aboutus>關於我們</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>繁體中文</a><ul class=dropdown__menu><li><a href=/docs/nginx-notes/monitoring target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=zh-hant>繁體中文</a><li><a href=/en/docs/nginx-notes/monitoring target=_self rel="noopener noreferrer" class=dropdown__link lang=en>English</a><li><a href=/ja/docs/nginx-notes/monitoring target=_self rel="noopener noreferrer" class=dropdown__link lang=ja>日本語</a></ul></div><div class=navbarSearchContainer_dCNk><button type=button class="DocSearch DocSearch-Button" aria-label="搜尋 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>搜尋</span></span><span class=DocSearch-Button-Keys></span></button></div><button type=button class="ant-btn css-5uvb3z ant-btn-circle ant-btn-default ant-btn-color-default ant-btn-variant-outlined ant-btn-icon-only"><span class=ant-btn-icon><span role=img aria-label=user style=font-size:18px class="anticon anticon-user"><svg viewBox="64 64 896 896" focusable=false data-icon=user width=1em height=1em fill=currentColor aria-hidden=true><path d="M858.5 763.6a374 374 0 00-80.6-119.5 375.63 375.63 0 00-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 00-80.6 119.5A371.7 371.7 0 00136 901.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 008-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"/></svg></span></span></button></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_eExm"><div class=docsWrapper_hBAB><button aria-label=回到頂部 class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex=-1 class=sidebarLogo_isFc href=/><img src=/img/docsaid_logo.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/img/docsaid_logo_white.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label=文件側邊欄 class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/docs/>開源專案</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/model-training-guide/>模型訓練指南</a><button aria-label="展開側邊欄分類 '模型訓練指南'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/autotraderx/>AutoTraderX</a><button aria-label="展開側邊欄分類 'AutoTraderX'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/capybara/>Capybara</a><button aria-label="展開側邊欄分類 'Capybara'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/docaligner/>DocAligner</a><button aria-label="展開側邊欄分類 'DocAligner'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/docclassifier/>DocClassifier</a><button aria-label="展開側邊欄分類 'DocClassifier'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/gmailsummary/>GmailSummary</a><button aria-label="展開側邊欄分類 'GmailSummary'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/mrzscanner/>MRZScanner</a><button aria-label="展開側邊欄分類 'MRZScanner'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/docs/nginx-notes/>Nginx Notes</a><button aria-label="收起側邊欄分類 'Nginx Notes'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/nginx-notes/intro>Nginx 介紹</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/nginx-notes/install-and-settings>Nginx 安裝與配置</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/nginx-notes/https-settings>Nginx HTTPS 設定</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/nginx-notes/security>Nginx 安全強化</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/docs/nginx-notes/monitoring>Nginx 日誌與監控</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/docs/nginx-notes/static-file-server>Nginx 提供靜態資源</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/docs/category/補充資料>補充資料</a><button aria-label="展開側邊欄分類 '補充資料'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/docs/wordcanvas/>WordCanvas</a><button aria-label="展開側邊欄分類 'WordCanvas'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav><button type=button title=收起側邊欄 aria-label=收起側邊欄 class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=頁面路徑><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label=主頁面 class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/docs/nginx-notes/><span>Nginx Notes</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Nginx 日誌與監控</span></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">本頁導覽</button></div><div class="theme-doc-markdown markdown"><header><h1>Nginx 日誌與監控</h1></header>
<p>將 API 對外開放之後，我們立刻就會收到來自四面八方的惡意請求。</p>
<p>如果你有看去過日誌記錄，應該不難發現有各種 IP 一直嘗試使用不同的用戶名和密碼登入你的伺服器。這是一種常見的暴力破解攻擊，攻擊者會使用自動化工具不斷嘗試登入，直到找到正確的密碼。</p>
<p>雖然我們可以讓密碼的複雜度突破天際，但是總是這樣讓人惦記著也不是辦法。</p>
<p>所以我們用 Fail2ban 這個工具，把那些 IP 通通封鎖掉。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=什麼是-fail2ban>什麼是 Fail2ban？<a href=#什麼是-fail2ban class=hash-link aria-label="什麼是 Fail2ban？的直接連結" title="什麼是 Fail2ban？的直接連結">​</a></h2>
<p>Fail2ban 是一款開源的入侵防禦工具，主要用於監控伺服器日誌並根據規則封鎖惡意 IP。它能有效防禦暴力破解攻擊，例如針對 SSH、HTTP 和其他網路服務的惡意行為。</p>
<p>Fail2ban 的運作基礎是「過濾器」（filters）和「監獄」（jails）兩大概念：</p>
<ul>
<li><strong>過濾器</strong>：用於定義應在日誌中尋找的可疑行為模式</li>
<li><strong>監獄</strong>： 則負責將過濾器與封鎖機制結合，當偵測到異常行為時自動執行對應動作。</li>
</ul>
<p>在 Nginx 的應用場景中，Fail2ban 可透過監視 Nginx 的訪問日誌（access log）與錯誤日誌（error log），辨識可疑請求，例如：</p>
<ul>
<li><strong>頻繁的 404 錯誤</strong>（潛在的掃描攻擊）</li>
<li><strong>連續的登入失敗</strong>（暴力破解攻擊）</li>
<li><strong>短時間內的高頻請求</strong>（DDoS 或惡意爬蟲）</li>
</ul>
<p>一旦偵測到異常，Fail2ban 會根據設定，透過 iptables 或 nftables 自動封鎖來源 IP，使其無法繼續攻擊 Nginx 伺服器。</p>
<p>在 Ubuntu 環境中，Nginx 的日誌預設存放於：</p>
<ul>
<li><strong>訪問日誌</strong>：<code>/var/log/nginx/access.log</code></li>
<li><strong>錯誤日誌</strong>：<code>/var/log/nginx/error.log</code></li>
</ul>
<p>Fail2ban 可透過設定監控這些日誌，並根據預設或自訂的過濾規則範本來比對日誌內容。當日誌記錄與惡意行為模式匹配時，Fail2ban 會將相關 IP 加入封鎖清單。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>資訊</div><div class=admonitionContent_BuS1><p>規則範本通常位於 <code>/etc/fail2ban/filter.d/</code></div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>除了保護 Nginx 之外，Fail2ban 也能應用於 SSH、FTP、郵件伺服器等多種服務，提供廣泛的伺服器安全防護功能。本指南主要聚焦於 Nginx 相關的防禦配置。</div></div>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=fail2ban-基本設定>Fail2ban 基本設定<a href=#fail2ban-基本設定 class=hash-link aria-label="Fail2ban 基本設定的直接連結" title="Fail2ban 基本設定的直接連結">​</a></h2>
<p>在 Ubuntu 上，Fail2ban 可以直接透過 APT 套件管理器安裝，因為它已包含在官方的軟體庫中。請依照以下步驟進行安裝與啟動：</p>
<ol>
<li>
<p><strong>更新系統套件庫</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo apt update</span><br></span></code></pre></div></div>
</li>
<li>
<p><strong>安裝 Fail2ban</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo apt install -y fail2ban</span><br></span></code></pre></div></div>
<p>這將自動下載並安裝 Fail2ban 及其相依套件。安裝完成後，Fail2ban 會自動啟動並設定為開機自動執行。</p>
</li>
<li>
<p><strong>確認 Fail2ban 服務狀態</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo systemctl status fail2ban</span><br></span></code></pre></div></div>
<p>若安裝成功，應會顯示 <code>active (running)</code>，代表 Fail2ban 已正常運行。</p>
</li>
<li>
<p><strong>檢查 Fail2ban 版本與狀態</strong>：</p>
<ul>
<li>
<p>顯示目前安裝的 Fail2ban 版本：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">fail2ban-client --version</span><br></span></code></pre></div></div>
</li>
<li>
<p>檢查目前已啟用的監獄們
：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status</span><br></span></code></pre></div></div>
<p>預設情況下，Fail2ban 可能僅啟用 SSH 的保護機制，Nginx 相關的防禦則需要額外設定。</p>
</li>
</ul>
</li>
</ol>
<hr>
<p>Fail2ban 的主要設定檔案為 <code>/etc/fail2ban/jail.conf</code>，但官方建議：「不要直接修改這個檔案」，以避免日後軟體更新時覆寫你的設定。</p>
<p>因此，我們建立本地設定檔 <code>jail.local</code> 來覆蓋預設值。</p>
<ol>
<li>
<p><strong>複製 <code>jail.conf</code> 為 <code>jail.local</code></strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br></span></code></pre></div></div>
</li>
<li>
<p><strong>編輯 <code>jail.local</code></strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/jail.local</span><br></span></code></pre></div></div>
</li>
</ol>
<p>找到 <code>[DEFAULT]</code> 區段，設定一些關鍵參數，例如：忽略的 IP、封鎖時間、觀察時間及最大重試次數等相關設定：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[DEFAULT]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreip = 127.0.0.1/8 ::1    # 設定信任的 IP 地址，這些 IP 不會被封鎖</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 1h                 # 預設封鎖時間，可設為秒數或時間單位 (如 1h, 10m)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 10m                # 在此時間內…</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 5                  # 超過 maxretry 次失敗則封鎖該 IP</span><br></span></code></pre></div></div>
<p>這些設定的含義如下：</p>
<ul>
<li><strong>ignoreip</strong>：指定哪些 IP 不會被封鎖，例如本機 (<code>127.0.0.1</code>) 或其他管理用 IP。</li>
<li><strong>bantime</strong>：封鎖時長，預設為 1 小時（<code>1h</code>）。此時間內該 IP 會被禁止存取。</li>
<li><strong>findtime</strong>：觀察時間範圍，例如設定 <code>10m</code> 代表 10 分鐘內累積的失敗行為將被計算。</li>
<li><strong>maxretry</strong>：最大重試次數，例如設定 <code>5</code> 代表同一個 IP 在 <code>findtime</code> 內觸發 5 次規則後會被封鎖。</li>
</ul>
<p>這些參數為全域設定，適用於所有監獄。我們稍後必須針對 Nginx 設定單獨的封鎖策略，確保惡意攻擊能被更有效地攔截。</p>
<p>完成設定後，重新啟動 Fail2ban 以套用新設定：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo systemctl restart fail2ban</span><br></span></code></pre></div></div>
<p>至此，Fail2ban 的基本安裝與全域設定已完成。</p>
<p>接下來，我們將進一步配置 Fail2ban 來監控 Nginx 日誌，以防止惡意請求。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=監控常見攻擊類型>監控常見攻擊類型<a href=#監控常見攻擊類型 class=hash-link aria-label=監��控常見攻擊類型的直接連結 title=監控常見攻擊類型的直接連結>​</a></h2>
<p>這裡我們將針對幾種常見的 Nginx 攻擊類型，設定 Fail2ban 進行監控與自動封鎖。每種攻擊行為在 Nginx 日誌中通常會有明確的特徵，因此我們先制定「過濾規則」來偵測，並套用對應的封鎖策略。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=防止惡意爬蟲>防止惡意爬蟲<a href=#防止惡意爬蟲 class=hash-link aria-label=防止惡意爬蟲的直接連結 title=防止惡意爬蟲的直接連結>​</a></h3>
<p>許多惡意爬蟲或攻擊工具會使用特定的 User-Agent，例如：</p>
<ul>
<li><code>Java</code></li>
<li><code>Python-urllib</code></li>
<li><code>Curl</code></li>
<li><code>sqlmap</code></li>
<li><code>Wget</code></li>
<li><code>360Spider</code></li>
<li><code>MJ12bot</code></li>
</ul>
<p>這些 User-Agent 多數來自自動化掃描工具，並不屬於正常用戶。因此，我們可以針對這類 User-Agent 進行即時封鎖。</p>
<p>首先，在 <code>/etc/fail2ban/filter.d/</code> 目錄下建立一個新的過濾器檔案：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-badbots.conf</span><br></span></code></pre></div></div>
<p>填入以下內容：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(GET|POST).*HTTP.*" .* "(?:Java|Python-urllib|Curl|sqlmap|Wget|360Spider|MJ12bot)"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex 用於匹配惡意請求的正則表達式</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> 代表 IP 地址，占位符會被 Fail2Ban 解析</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(GET|POST).*HTTP.*" 限定為 HTTP GET 或 POST 請求</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - .* 用於匹配請求內容</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(?:Java|Python-urllib|Curl|sqlmap|Wget|360Spider|MJ12bot)"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - 這些是常見的爬蟲、掃描器或攻擊工具：</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Java: 一般來自 Java-based 爬蟲</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Python-urllib: Python 內建的 URL 請求庫</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Curl: 命令行 HTTP 請求工具</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - sqlmap: 自動化 SQL 注入工具</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Wget: 下載工具，也可用於爬取網站</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - 360Spider: 360 搜索引擎的爬蟲</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - MJ12bot: Majestic SEO 爬蟲</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex 是用來排除某些請求的正則表達式</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - 這裡留空，表示不排除任何請求</span><br></span></code></pre></div></div>
<p>接著設定 Jail，在 <code>jail.local</code> 檔案中加入：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-badbots]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-badbots</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre></div></div>
<p>這樣一來，任何使用這些 User-Agent 的請求都會被立即封鎖 24 小時。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=防止-404-掃描攻擊>防止 404 掃描攻擊<a href=#防止-404-掃描攻擊 class=hash-link aria-label="防止 404 掃描攻擊的直接連結" title="防止 404 掃描攻擊的直接連結">​</a></h3>
<p>這種攻擊方式會暴力探測不存在頁面，通常會在短時間內對網站進行大量請求。</p>
<p>攻擊者可能會透過腳本不斷存取網站不存在的頁面，以嘗試發現漏洞或敏感檔案，並產生大量 HTTP 404 錯誤。</p>
<p>建立一個新的過濾器檔案：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-404.conf</span><br></span></code></pre></div></div>
<p>填入以下內容：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(GET|POST).*HTTP.*" 404</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex 用於匹配特定的日誌模式</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> 代表 IP 地址（Fail2Ban 會自動替換為實際的來源 IP）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(GET|POST).*HTTP.*"：</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - 限定請求方法為 GET 或 POST</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - .* 用於匹配 URL 及 HTTP 協議版本（如 HTTP/1.1）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "404" 指定匹配 HTTP 404 狀態碼（表示請求的資源未找到）</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># 這條規則用來封鎖頻繁觸發 404 錯誤的 IP，例如掃描不存在頁面的惡意爬蟲或攻擊者</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># 適用於 Web 伺服器（如 Nginx、Apache）的日誌分析</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex 是用來排除某些請求的匹配規則</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - 這裡留空，表示不排除任何請求</span><br></span></code></pre></div></div>
<p>接著設定 Jail，在 <code>jail.local</code> 檔案中加入：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-404]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-404</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 10m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre></div></div>
<p>這將在 10 分鐘內觸發 5 次 404 錯誤 的 IP 封鎖 24 小時。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=防止-ddos-攻擊>防止 DDoS 攻擊<a href=#防止-ddos-攻擊 class=hash-link aria-label="防止 DDoS 攻擊的直接連結" title="防止 DDoS 攻擊的直接連結">​</a></h3>
<p>當某個 IP 在短時間內發送大量請求，可能是 DDoS 攻擊或惡意爬取。</p>
<p>建立一個新的過濾器檔案：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-limitreq.conf</span><br></span></code></pre></div></div>
<p>填入以下內容：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = limiting requests, excess: .* by zone .* client: &lt;HOST></span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex 用於匹配 Nginx 日誌中的請求限流（Rate Limiting）事件</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "limiting requests, excess: .* by zone .* client: &lt;HOST>"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "limiting requests, excess:" 表示請求超過了設置的限制（如 Nginx 的 limit_req_zone 限制）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - .* 允許匹配任意數據（如請求數量或超出的詳細資訊）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "by zone .*" 代表 Nginx 配置的限流區域（zone）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "client: &lt;HOST>" 這部分 Fail2Ban 會替換為實際的客戶端 IP 地址</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex 用於排除特定的匹配模式</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - 這裡留空，表示不排除任何請求</span><br></span></code></pre></div></div>
<p>這條 failregex 主要是用來匹配 Nginx 限流（limit_req_zone） 觸發的日誌，如：</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-log codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">2024/02/15 12:34:56 [error] 1234#5678: *90123 limiting requests, excess: 20.000 by zone "api_limit" client: 192.168.1.100, server: example.com, request: "GET /api/v1/data HTTP/1.1"</span><br></span></code></pre></div></div>
<p>對應的 Nginx 配置可能是：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">server {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    location /api/ {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        limit_req zone=api_limit burst=20 nodelay;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre></div></div>
<p>這樣，當某個 IP 短時間內發送過多請求，Nginx 會在日誌中記錄 <code>"limiting requests, excess: ... client: &lt;IP>"</code>，Fail2Ban 就能根據 failregex 來匹配並封鎖該 IP。</p>
<p>接著設定 Jail，在 <code>jail.local</code> 檔案中加入：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-limitreq]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-limitreq</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/error.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 10m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre></div></div>
<p>這將在 10 分鐘內 超過 10 次觸發 Nginx 速率限制的 IP 封鎖 24 小時。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=防止暴力登入>防止暴力登入<a href=#防止暴力登入 class=hash-link aria-label=防止暴力登入的直接連結 title=防止暴力登入的直接連結>​</a></h3>
<p>如果網站提供登入功能，攻擊者可能會透過暴力嘗試帳號密碼。</p>
<p>建立一個新的過濾器檔案：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-login.conf</span><br></span></code></pre></div></div>
<p>填入以下內容：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(POST|GET) /(admin|wp-login.php) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex 用於匹配惡意請求，目標是常見的管理後台登錄頁面</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> 代表 IP 地址（Fail2Ban 會自動替換為實際的來源 IP）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(POST|GET) /(admin|wp-login.php) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "(POST|GET)" 代表 HTTP 方法（攻擊者可能會用 GET 或 POST 嘗試登入）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/admin" 是一些網站後台的常見路徑</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/wp-login.php" 是 WordPress 登錄頁面</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "HTTP.*" 用於匹配不同的 HTTP 版本，如 HTTP/1.1、HTTP/2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex 用於排除某些特定請求</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - 這裡留空，表示不排除任何請求</span><br></span></code></pre></div></div>
<p>這會匹配 WordPress 或一般網站的管理後台登入嘗試。</p>
<p>接著設定 Jail，在 <code>jail.local</code> 檔案中加入：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-login]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-login</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 5m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre></div></div>
<p>這會在 5 分鐘內超過 5 次登入失敗的 IP 封鎖 24 小時。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=嘗試存取敏感資料>嘗試存取敏感資料<a href=#嘗試存取敏感資料 class=hash-link aria-label=嘗試存取敏感資料的直接連結 title=嘗試存取敏感資料的直接連結>​</a></h3>
<p>惡意攻擊者可能會試圖存取 <code>/etc/passwd</code>、<code>/.git</code>、<code>/.env</code> 等敏感路徑。</p>
<p>建立一個新的過濾器檔案：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-sensitive.conf</span><br></span></code></pre></div></div>
<p>填入以下內容：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(GET|POST) /(etc/passwd|\.git|\.env) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex 用於匹配試圖訪問敏感文件的惡意請求</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> 代表 IP 地址（Fail2Ban 會自動替換為實際的來源 IP）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(GET|POST) /(etc/passwd|\.git|\.env) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "(GET|POST)" 代表 HTTP 方法，攻擊者可能會用 GET 或 POST 來探測文件</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/etc/passwd" 是 Linux 系統的密碼文件，攻擊者可能會試圖讀取它</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/.git" 目錄可能包含源代碼與敏感信息，攻擊者可能會試圖下載 `.git` 文件夾</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/.env" 環境變數文件，可能包含 **資料庫密碼、API Key、密鑰**</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "HTTP.*" 匹配不同的 HTTP 版本（如 HTTP/1.1、HTTP/2）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex 用於排除特定請求的匹配</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - 這裡留空，表示不排除任何請求</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>這條規則用於防止目錄遍歷攻擊、保護 Git 目錄、阻擋對 <code>.env</code> 文件的探測，以及防範 Web Scanner 掃描。</p>
<p>接著設定 Jail，在 <code>jail.local</code> 檔案中加入：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-sensitive]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-sensitive</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre></div></div>
<p>這會對任何嘗試存取這些敏感檔案的 IP 立即封鎖 24 小時。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=針對-api-的攻擊>針對 API 的攻擊<a href=#針對-api-的攻擊 class=hash-link aria-label="針對 API 的攻擊的直接連結" title="針對 API 的攻擊的直接連結">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>提示</div><div class=admonitionContent_BuS1><p>要記得根據你的 api 來調整過濾器。</div></div>
<p>針對 API 端點（如 <code>/api/login</code>、<code>/api/register</code>）進行暴力攻擊時，應限制請求頻率。</p>
<p>建立一個新的過濾器檔案：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-api.conf</span><br></span></code></pre></div></div>
<p>填入以下內容：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(POST) /api/(login|register) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex 用於匹配針對 API 登入和註冊的惡意請求</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> 代表 IP 地址（Fail2Ban 會自動替換為實際的來源 IP）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(POST) /api/(login|register) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "(POST)" 限定為 HTTP POST 方法（防止暴力破解登入或濫用註冊）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/api/login" 是登入 API，可能成為暴力破解攻擊目標</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/api/register" 是註冊 API，攻擊者可能會用來濫發帳號（如機器人註冊）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "HTTP.*" 匹配 HTTP 版本（如 HTTP/1.1、HTTP/2）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex 用於排除某些特定請求的匹配</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - 這裡留空，表示不排除任何請求</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span></code></pre></div></div>
<p>這條規則用於防止暴力破解登入、自動化註冊攻擊，以及提升 API 安全性。</p>
<p>接著設定 Jail，在 <code>jail.local</code> 檔案中加入：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-api]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-api</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 1m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre></div></div>
<p>這會在 1 分鐘內超過 10 次登入嘗試的 IP 封鎖 24 小時。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=套用新規則>套用新規則<a href=#套用新規則 class=hash-link aria-label=套用新規則的直接連結 title=套用新規則的直接連結>​</a></h3>
<p>完成設定後，重新啟動 Fail2ban：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo systemctl restart fail2ban</span><br></span></code></pre></div></div>
<p>並確認 Jail 狀態：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status</span><br></span></code></pre></div></div>
<p>如果想查看某個監獄的狀態，可以使用：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status nginx-404 # 替換為你的 jail 名稱</span><br></span></code></pre></div></div>
<p>到這裡，我們已針對 Nginx 的常見攻擊類型設定 Fail2ban 進行防禦，確保網站安全。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=測試防禦效果>測試防禦效果<a href=#測試防禦效果 class=hash-link aria-label=測試防禦效果的直接連結 title=測試防禦效果的直接連結>​</a></h2>
<p>完成 Fail2ban 的 Nginx 防禦設定後，我們簡單測試一下。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=使用-curl-模擬攻擊>使用 <code>curl</code> 模擬攻擊<a href=#使用-curl-模擬攻擊 class=hash-link aria-label=使用-curl-模擬攻擊的直接連結 title=使用-curl-模擬攻擊的直接連結>​</a></h3>
<p>可以在本機或另一台電腦上使用 <code>curl</code> 發送惡意請求來觸發 Fail2ban 的封鎖機制。</p>
<p>請注意測試時不要從本機 <code>localhost</code> 發送，因為 <code>127.0.0.1</code> 可能被 <code>ignoreip</code> 設定排除，Fail2ban 不會封鎖它。可以使用其他網路環境的電腦或伺服器來測試，或是暫時將 <code>ignoreip</code> 清空。</p>
<ul>
<li>
<p><strong>1. 測試 404 掃描攔截</strong></p>
<p>模擬攻擊者隨機掃描不存在的頁面：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">for i in $(seq 1 6); do</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    curl -I http://&lt;你的伺服器IP或域名>/nonexistentpage_$i ;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">done</span><br></span></code></pre></div></div>
<p>這將連續請求 6 個不存在的頁面，產生 HTTP 404 錯誤。如果你的規則設定為 5 次 404 即封鎖，Fail2ban 應該會在第 5 或第 6 次時將該 IP 封鎖。
封鎖後，你再執行 <code>curl</code> 請求，應該會發現連線失敗（如超時或連接被拒）。</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>2. 測試敏感 URL 攔截</strong></p>
<p>攻擊者通常會嘗試存取系統敏感檔案，例如 <code>/etc/passwd</code>，來確認伺服器是否存在漏洞：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">curl -I http://&lt;你的伺服器>/etc/passwd</span><br></span></code></pre></div></div>
<p>如果 Fail2ban 的 <code>nginx-sensitive</code> 過濾器正確設定，這次請求應該會被 Fail2ban 偵測到並立即封鎖該 IP（如果 <code>maxretry = 1</code>）。</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>3. 測試 User-Agent 攔截</strong></p>
<p>模擬惡意爬蟲工具，例如 <code>sqlmap</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">curl -A "sqlmap/1.5.2#stable" http://&lt;你的伺服器>/</span><br></span></code></pre></div></div>
<p>如果你的規則中設定了 <code>sqlmap</code> 這個 User-Agent，Fail2ban 應該會立即封鎖該 IP。</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>4. 測試暴力登入攻擊</strong></p>
<p>對 WordPress 或其他登入頁發送多次請求，模擬攻擊者嘗試暴力破解：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">for i in $(seq 1 6); do</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    curl -X POST -d "username=admin&password=wrongpassword" http://&lt;你的伺服器>/wp-login.php ;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">done</span><br></span></code></pre></div></div>
<p>如果你的 <code>nginx-sensitive</code> 過濾器設定為 5 次失敗即封鎖，則 Fail2ban 應該會在第 5 或 6 次時將該 IP 封鎖。</p>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=驗證狀態與日誌>驗證狀態與日誌<a href=#驗證狀態與日誌 class=hash-link aria-label=驗證狀態與日誌的直接連結 title=驗證狀態與日誌的直接連結>​</a></h3>
<p>你可以使用以下指令查看監獄內的狀態，假設我們要查看 <code>nginx-sensitive</code>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status nginx-sensitive</span><br></span></code></pre></div></div>
<p>預期輸出：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">Status for the jail: nginx-sensitive</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|- Filter</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|  |- Currently failed: 0</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|  |- Total failed: 9</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|  `- File list: /var/log/nginx/access.log /var/log/nginx/error.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">`- Actions</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |- Currently banned: 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |- Total banned: 2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   `- Banned IP list: 203.0.113.45</span><br></span></code></pre></div></div>
<ul>
<li><strong>Currently banned</strong>：當前被封鎖的 IP 數量。</li>
<li><strong>Total failed</strong>：累計的惡意請求次數。</li>
<li><strong>Banned IP list</strong>：顯示當前被封鎖的 IP（例如 <code>203.0.113.45</code>）。</li>
</ul>
<hr>
<p>接著，你可以查看 Fail2ban 的日誌，確認封鎖紀錄：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo tail -n 20 /var/log/fail2ban.log</span><br></span></code></pre></div></div>
<p>預期輸出範例：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">fail2ban.actions [INFO] Ban 203.0.113.45 on nginx-sensitive</span><br></span></code></pre></div></div>
<p>表示 <code>203.0.113.45</code> 這個 IP 因觸發 <code>nginx-sensitive</code> 規則而被封鎖。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=解除封鎖-ip>解除封鎖 IP<a href=#解除封鎖-ip class=hash-link aria-label="解除封鎖 IP的直接連結" title="解除封鎖 IP的直接連結">​</a></h3>
<p>在測試或日常管理時，你可能需要手動封鎖或解除封鎖某個 IP。</p>
<p>你可以手動封鎖某個 IP：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client set nginx-sensitive banip 203.0.113.45</span><br></span></code></pre></div></div>
<p>這將立即封鎖 <code>203.0.113.45</code>，並且該 IP 會被加入 <code>nginx-sensitive</code> 的封鎖名單中。</p>
<p>如果發現某個 IP 被誤封鎖，可以解除封鎖：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client set nginx-sensitive unbanip 203.0.113.45</span><br></span></code></pre></div></div>
<p>執行該指令後，可以使用 <code>fail2ban-client status nginx-sensitive</code> 確認該 IP 是否已從封鎖名單移除。</p>
<hr>
<p>最後，你可以檢查防火牆規則（iptables / nftables）是否正確設定。</p>
<p>Fail2ban 主要透過 <code>iptables</code>（或 <code>nftables</code>）來封鎖 IP，因此也可以直接檢查防火牆規則：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo iptables -L -n --line-numbers</span><br></span></code></pre></div></div>
<p>如果封鎖規則生效，你應該會看到類似：</p>
<div class="language-text codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">Chain f2b-nginx-sensitive (1 references)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">num  target     prot opt source               destination</span><br></span><span class=token-line style=color:#393A34><span class="token plain">1    REJECT     all  --  203.0.113.45          0.0.0.0/0   reject-with icmp-port-unreachable</span><br></span></code></pre></div></div>
<p>這表示 <code>203.0.113.45</code> 已被封鎖，所有流量都會被拒絕。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=結論>結論<a href=#結論 class=hash-link aria-label=結論的直接連結 title=結論的直接連結>​</a></h2>
<p>到這邊，我們設定了針對 Nginx 的防禦規則，算是完成了基本的 Fail2ban 設定。</p>
<p>這個部分請務必按照你的實際需求調整參數，比如不同類型的攻擊可以拆分不同監獄、設置不同的 maxretry/findtime，以及審慎設定 ignoreip 白名單以避免誤封關鍵 IP。</p>
<p>部署完成後，還是要持續關心 Fail2ban 的日誌，確保它正常運行並能有效防禦惡意攻擊。</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated>最後<!-- -->由 <b>zephyr-sh</b> <!-- -->於 <b><time datetime=2025-02-15T07:30:22.000Z itemprop=dateModified>2025年2月15日</time></b> <!-- -->更新</span></div></div><div style=margin-top:3rem> </div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label=文件選項卡><a class="pagination-nav__link pagination-nav__link--prev" href=/docs/nginx-notes/security><div class=pagination-nav__sublabel>上一頁</div><div class=pagination-nav__label>Nginx 安全強化</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/docs/nginx-notes/static-file-server><div class=pagination-nav__sublabel>下一頁</div><div class=pagination-nav__label>Nginx 提供靜態資源</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#什麼是-fail2ban class="table-of-contents__link toc-highlight">什麼是 Fail2ban？</a><li><a href=#fail2ban-基本設定 class="table-of-contents__link toc-highlight">Fail2ban 基本設定</a><li><a href=#監控常見攻擊類型 class="table-of-contents__link toc-highlight">監控常見攻擊類型</a><ul><li><a href=#防止惡意爬蟲 class="table-of-contents__link toc-highlight">防止惡意爬蟲</a><li><a href=#防止-404-掃描攻擊 class="table-of-contents__link toc-highlight">防止 404 掃描攻擊</a><li><a href=#防止-ddos-攻擊 class="table-of-contents__link toc-highlight">防止 DDoS 攻擊</a><li><a href=#防止暴力登入 class="table-of-contents__link toc-highlight">防止暴力登入</a><li><a href=#嘗試存取敏感資料 class="table-of-contents__link toc-highlight">嘗試存取敏感資料</a><li><a href=#針對-api-的攻擊 class="table-of-contents__link toc-highlight">針對 API 的攻擊</a><li><a href=#套用新規則 class="table-of-contents__link toc-highlight">套用新規則</a></ul><li><a href=#測試防禦效果 class="table-of-contents__link toc-highlight">測試防禦效果</a><ul><li><a href=#使用-curl-模擬攻擊 class="table-of-contents__link toc-highlight">使用 <code>curl</code> 模擬攻擊</a><li><a href=#驗證狀態與日誌 class="table-of-contents__link toc-highlight">驗證狀態與日誌</a><li><a href=#解除封鎖-ip class="table-of-contents__link toc-highlight">解除封鎖 IP</a></ul><li><a href=#結論 class="table-of-contents__link toc-highlight">結論</a></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class=footer__links><a class=footer__link-item href=/docs>開源專案</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/papers/intro>論文筆記</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/blog>部落格</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/terms-of-service>使用條款</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/privacy-policy>隱私政策</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/become-an-author>成為作者</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/worklog>工作日誌</a></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2025 DOCSAID.</div></div></div></footer></div>