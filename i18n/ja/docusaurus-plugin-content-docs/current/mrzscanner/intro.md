---
sidebar_position: 1
---

# イントロダクション

MRZ（Machine Readable Zone、機械読み取り可能領域）とは、パスポート、ビザ、身分証明書などの旅行書類における特定の領域で、この領域内の情報は機械によって迅速に読み取ることができます。MRZ は、国際民間航空機関（ICAO）の 9303 号文書に従って設計および生成され、国境検査の迅速化と情報処理の正確性向上に使用されます。

- [**9303 号文書**](./reference.md#icao-9303)

人々は MRZ が何であるか知らないかもしれませんが、通常手にしているパスポートには MRZ 区画があり、以下のように赤枠で囲まれた部分があります：

<figure>
![mrz example](./resources/img1.jpg)
<figcaption>画像出典：[**MIDV-2020 合成データセット**](http://l3i-share.univ-lr.fr/MIDV2020/midv2020.html)</figcaption>
</figure>

---

パスポートだけでなく、特定の国の身分証明書、運転免許証、ビザなどの書類にも MRZ 区画があります。

MRZ 区画にはいくつかの顕著な特徴があります：

1. **固定された構造**：異なる種類の MRZ は異なる構造を持ち、各フィールドの意味も固定されています。
2. **クリーンな文字領域**：MRZ の背景は単色で、文字は黒色、また文字間に一定の間隔があります。
3. **簡単な分類**：MRZ 区画の文字は数字と大文字のアルファベットだけで、全体で 37 文字です。

:::info
MRZ の構造は、異なる種類の書類によって異なります。主なものは以下の通りです：

1. **TD1（身分証明書等）：** 3 行、各行 30 文字で、合計 90 文字。
2. **TD2（パスポートカード等）：** 2 行、各行 36 文字で、合計 72 文字。
3. **TD3（パスポート等）：** 2 行、各行 44 文字で、合計 88 文字。
4. **MRVA（ビザタイプ A）：** 2 行、各行 44 文字で、合計 88 文字。
5. **MRVB（ビザタイプ B）：** 2 行、各行 36 文字で、合計 72 文字。
   :::

## 構造紹介

有名な MRZ 解析に関連する Github プロジェクト[**Arg0s1080/mrz**](https://github.com/Arg0s1080/mrz)を参考に、MRZ の構造について説明します：

![field distribution](./resources/Fields_Distribution.png)

---

上の図から、各 MRZ 区画の意味を明確に理解できます：

1. **Type**：書類の種類（パスポート、身分証明書、ビザなど）
2. **Country Code**：発行国のコード
3. **Surname**：姓
4. **Given Names**：名
5. **Document Number**：書類番号
6. **National**：国籍
7. **Date of Birth**：生年月日
8. **Date of Expiry**：有効期限
9. **Optional**：カスタムフィールド

## 文字認識

今回のテーマは「MRZ 文字認識」であり、このテーマはあまり一般的ではなく、研究論文も少ないです。しかし、問題を分解して考えれば、結局これは OCR の問題に過ぎません。いくつかの OCR モデルを微調整すれば問題は解決します。

でも、それは無駄だと思いませんか？！

OCR モデルは通常、さまざまな種類の文字（数字、大文字、小文字、句読点など）を認識するために設計されており、予測される文字クラスは数千にも及ぶ可能性があります。そのため、こうしたモデルは複雑で、計算リソースも多く必要です。

もしこのモデルをそのまま MRZ 認識に適用すると、私たちが専門的でないように見えてしまいますよね？

だからこそ、MRZ の特徴に合わせて、モデルを再設計する必要があります。このような専用のモデルは、余分な文字タイプを処理する必要がなく、計算リソースを節約し、認識速度と精度を向上させることができます。

### 二段階認識

専用のモデルを設計する以上、MRZ 認識を 2 つの段階に分けることができます：

1. **領域検出**：軽量のモデルを使用して、画像内の MRZ 区画を検出します。
2. **文字認識**：軽量のモデルを使用して、画像内の MRZ 区画にある文字を認識します。

言うは易し、行うは難しですが、私たちは 1 週間を費やして MRZ 検出モデルを完成させ、さらに 1 週間を費やして MRZ 認識モデルを完成させました。この 2 つのモデルを合わせて約 5MB で、単一フレームの認識精度は約 95%に達しました。

:::tip
**定義：** 上記の精度とは、すべての MRZ 領域内の文字認識が正確であれば、その画像全体の認識が正しいと見なされ、1 文字でも間違えれば全て間違いとなります。
:::

本当に言いたいことは、この方法の唯一の欠点は...

### つまらない

どんな風に考えても、私たちは「順風順水」にこのテーマを終わらせたと思います。それは公務として終わらせたと言えるでしょう。

お客様から依頼が来たので、計画通りに進めた結果、この解決策はお客様に引き渡した後、私たちの片隅に放置され、新しい解決策を考え始めました。

- **もし二段階認識を使わないのであれば、単一段階認識しかありません！**

私たちは直接原画像から MRZ 区画の文字を認識する必要があります。

### 単一段階認識

そして、さらに 3 ヶ月かけて単一段階の MRZ 認識モデルを完成させました。

正直言うと、予想以上に時間がかかってしまい、少し損した気分です。

この問題は私たちが考えていたよりもずっと難しいものでした。何度も「あきらめて、二段階解決策に戻した方がいいんじゃないか？」と思いましたが、少なくともそれは精度が高かったんですから。自分で難しい道を選ぶ意味があるのでしょうか？

単一段階モデルの難しさは、モデルが全体の画像からサイズが異なり、方向も不定な MRZ 区画を検索し、その文字を認識する必要があるという点です。この前提のもとで、モデルは軽量でなければならず、モバイル端末のニーズを満たす必要があります。これらの要素が重なることで、モデルの収束が難しくなり、性能があまり良くありませんでした。

:::info
技術的な詳細については、後の章で紹介します：[**モデル設計**](./model_arch.md)
:::

要するに、開発過程でかなり落胆した瞬間もありましたが、最終的にはひと段落つけることができました。

すでに費やしたお金と時間は戻ってこないので、このソリューションをオープンソース化して、皆さんと共有することにしました。

単一段階の解決策は私たちにとって「段階的成果」に過ぎません。私たちが考えている完全な形は、もっと堅牢で、正確なモデルであり、より多くのアプリケーションシーンに対応できるものであるべきです。

:::tip
私たちは今後も多くの論文を読んで、モデルの性能を改善し続けます。
:::

## モデル評価

この部分は、正直言って無理です。

まず、このようなテーマには標準的なデータセットがないため、自分たちでデータセットを合成して、独自にラベルを付ける必要があります。そのため、データセットの信頼性は非常に低いです。さらに、MIDV は一定のデータを提供していますが、それも合成されたサンプルが多く、モデルを微調整するにはあまり効果がありませんし、モデルの性能評価に直接使用するのは難しいです。

そのため、このプロジェクトでは、以前のプロジェクトのように完全なモデル評価レポートを提供することはできません。

## 最後に

このプロジェクトで私たちはいくつかの機能を達成しました：

1. 合成データセットの有効性を検証しました。
2. MRZ 検出と認識を統合し、単一段階認識モデルを完成させました。
3. すべての形式の MRZ ファイルを統合し、統一された解析インターフェースを提供しました。

また、友人から実際のパスポートや居留証を借り、各国のパスポートでテストを行いました。シーンが一定の規定条件下にあれば、安定した認識結果が得られることが確認できました。

もしこのテーマに興味があれば、自分でテストしてみてください。フィードバックをいただけると嬉しいです。

また、提案があれば、ぜひご連絡ください。お話しできることを楽しみにしています。
