---
sidebar_position: 3
---

# クイックスタート

私たちは簡単なモデル推論インターフェースを提供しており、その中には前処理と後処理のロジックも含まれています。

まず、必要な依存関係をインポートし、`DocClassifier` クラスを作成する必要があります。

## 登録データ

モデルの話に進む前に、まず登録データについて説明します。

---

推論用のデータフォルダには、`register` フォルダがあり、その中にすべての登録データが含まれています。自分の登録データをその中に入れておくと、推論時に `DocClassifier` が自動的にそのフォルダ内のデータを読み込みます。自分のデータセットを使用する場合は、`DocClassifier` を作成する際に `register_root` パラメータを指定し、それを自分のデータセットのルートディレクトリに設定してください。

私たちのモジュールにはいくつかのファイル画像の登録データがデフォルトで含まれており、それらを参考にして自分で拡張できます。また、自分のアプリケーションに適したデータセットを使用することを強くお勧めします。

![register](./resources/register_demo.jpg)

:::tip
データは可能な限りフルサイズの画像を使用し、背景の干渉を最小限に抑えることで、モデルの安定性を向上させることをお勧めします。
:::

:::danger
私たちが事前にフォルダに入れた画像の多くはインターネットから収集したもので、解像度が非常に低いため、展示用としてしか使用できません。実際のデプロイには適していません。`register_root` パラメータを使って、自分のデータセットを入力し、モデルが自分のアプリケーションに適応できるようにしてください。
:::

## 重複登録

この問題には 2 つのケースがあります：

- **ケース 1：ファイル名が重複している場合**

  私たちの実装ロジックでは、登録フォルダ内のファイル名がデータのクエリインデックスとして使用されます。

  そのため、ファイル名が重複していると、後のファイルが前のファイルを上書きします。

  この場合の問題は大きくなく、上書きされたファイルは使用されませんが、モデルの推論には影響しません。

- **ケース 2：ファイル内容が重複している場合**

  同じファイルが複数回登録された場合です。

  例えば、ユーザーが 3 枚の同じ画像を異なるラベルで登録した場合、推論時に類似度を並べ替える過程でスコアは同じですが、必ず 1 つが最前に表示されます。この場合、モデルは常に同じラベルを返すわけではないため、結果に不確定性があります。

  この場合も大きな問題ではなく、モデルに不確定性が生じるだけで、原因を見つけるのは難しくなります。（~おい！~）

:::tip
要するに、登録データを真剣に扱ってください。
:::

## モデル推論

登録データの準備が整ったら、いよいよモデル推論を始めます。

以下は簡単な例です。まずモデルを起動します：

```python
from docclassifier import DocClassifier

model = DocClassifier()
```

次に、画像を読み込みます：

```python
import docsaidkit as D

img = D.imread('path/to/test_driver.jpg')
```

:::tip
`DocClassifier` が提供するテスト画像を使用することもできます：

ダウンロードリンク：[**test_driver.jpg**](https://github.com/DocsaidLab/DocClassifier/blob/main/docs/test_driver.jpg)

![test_card](./resources/test_driver.jpg)

:::

または、URL を使って直接読み込むこともできます：

```python
import cv2
from skimage import io

img = io.imread('https://github.com/DocsaidLab/DocClassifier/blob/main/docs/test_driver.jpg?raw=true')
img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
```

最後に、`model` を使って推論を行います：

```python
most_similar, max_score = model(img)
print(f'most_similar: {most_similar}, max_score: {max_score:.4f}')
# >>> most_similar: None, max_score: 0.0000
```

デフォルトでは、この例は `None` と `0.0000` を返します。これは、デフォルトの登録データと入力画像に大きな差があるため、モデルが登録データとの類似性を非常に低く判断するためです。

:::tip
デフォルトで登録されている運転免許証のデータは 1 頭のシカです；入力された認識画像は空白の運転免許証の画像です。（差がかなり大きい）
:::

この場合、`threshold` パラメータを下げることを検討できます：

```python
from docclassifier import DocClassifier

model = DocClassifier(
    threshold=0.6
)

# 再度推論を行う
most_similar, max_score = model(img)
print(f'most_similar: {most_similar}, max_score: {max_score:.4f}')
# >>> most_similar: 台湾運転免許証表面, max_score: 0.6116
```

これで、ラベル名とスコア（`台湾運転免許証表面` と `0.6116`）が得られます。このスコアは、入力画像と登録データ間の類似性を示します。

:::tip
`DocClassifier` は `__call__` を使用してラップされているため、インスタンスを直接呼び出して推論を行うことができます。
:::

:::info
初めて `DocClassifier` を使用する際には、自動的にモデルがダウンロードされる機能も設計されています。
:::

## 閾値設定

モデルの能力を評価する際には、TPR@FPR=1e-4 の基準を使用していますが、実際にはこの基準は比較的厳しく、デプロイ時にユーザー体験が悪化する可能性があります。そのため、デプロイ時には TPR@FPR=1e-1 または TPR@FPR=1e-2 の閾値設定を使用することをお勧めします。

現在、デフォルトの閾値は `TPR@FPR=1e-2` に設定されています。この閾値は私たちのテストと評価を通じて、最も適切であると考えています。詳細な閾値設定表は以下の通りです：

- **lcnet050_cosface_f256_r128_squeeze_imagenet_clip_20240326 結果**

  - **`model_cfg` を "20240326" に設定**
  - **TPR@FPR=1e-4: 0.912**

    |    FPR    | 1e-05 | 1e-04 | 1e-03 | 1e-02 | 1e-01 |   1   |
    | :-------: | :---: | :---: | :---: | :---: | :---: | :---: |
    |    TPR    | 0.856 | 0.912 | 0.953 | 0.980 | 0.996 |  1.0  |
    | Threshold | 0.705 | 0.682 | 0.657 | 0.626 | 0.581 | 0.359 |
