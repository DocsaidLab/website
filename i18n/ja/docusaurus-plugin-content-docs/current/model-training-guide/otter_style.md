---
slug: otter-style
title: Otter Style
authors: Zephyr
---

## Pytorch-Lightning „Å´Âü∫„Å•„Åè

Êú¨Á´†„Åß„ÅØ„ÄÅZephyr „ÅåÊãÖÂΩì„Åô„Çã„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÊßãÁØâÊñπÊ≥ï„Å´„Å§„ÅÑ„Å¶Ë™¨Êòé„Åó„Åæ„Åô„ÄÇ‰∏ª„Å´ Pytorch-Lightning Ë®ìÁ∑¥„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ„ÇíÂü∫Áõ§„Å®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

:::info
Ë©≥Á¥∞„Å™ÂÆüË£ÖÂÜÖÂÆπ„ÅØ„ÄÅ‰ª•‰∏ã„ÇíÂèÇÁÖß„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö[**DocsaidLab/Otter**](https://github.com/DocsaidLab/Otter)„ÄÇ

„ÄåOtter„Äç„Å®„ÅÑ„ÅÜÂêçÂâç„ÅÆÁî±Êù•„Å´„Å§„ÅÑ„Å¶ÁâπÂà•„Å™ÊÑèÂë≥„ÅØ„Å™„Åè„ÄÅÂå∫Âà•„Åô„Çã„Åü„ÇÅ„ÅÆÂêçÂâç„Å´„Åô„Åé„Åæ„Åõ„Çì„ÄÇüòÖ
:::

## Áí∞Â¢É„ÅÆÊßãÁØâ

‰ª•‰∏ã„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Åß„ÅØ„ÄÅ`DocClassifier` „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Çí‰æã„Å´„Å®„Çä„ÄÅ„É¢„Éá„É´Ë®ìÁ∑¥Áí∞Â¢É„ÇíÊßãÁØâ„Åô„ÇãÊñπÊ≥ï„ÇíË™¨Êòé„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÂÜÖÂÆπ„ÅØ„ÄÅ`DocAligner` „ÇÑ `MRZScanner` „Å™„Å©„ÄÅZephyr „ÅåÊãÖÂΩì„Åô„Çã‰ªñ„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´„ÇÇÂøúÁî®ÂèØËÉΩ„Åß„Åô„ÄÇ

:::info
Ê∑±Â±§Â≠¶Áøí„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÂ§ö„Åè„ÅØÊé®Ë´ñ„É¢„Ç∏„É•„Éº„É´„ÅÆ„Åø„ÅåÂÖ¨Èñã„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇÁèæÂú®„ÅÆ„Å®„Åì„Çç„ÄÅ`DocClassifier` „ÅÆ„Åø„ÅåË®ìÁ∑¥„É¢„Ç∏„É•„Éº„É´„ÇíÂÖ¨Èñã„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ‰ªñ„ÅÆ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË®ìÁ∑¥„É¢„Ç∏„É•„Éº„É´„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÄÅÊú¨Á´†„ÅÆË®ìÁ∑¥ÊñπÊ≥ï„ÇíÂèÇËÄÉ„Å´„Åó„Å¶Áã¨Ëá™„Å´ÂÆüË£Ö„Åô„Çã„Åì„Å®„ÅåÂèØËÉΩ„Åß„Åô„ÄÇ

`DocClassifier` „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË©≥Á¥∞„ÅØ„Åì„Å°„ÇâÔºö[**DocClassifier github**](https://github.com/DocsaidLab/DocClassifier)
:::

„Åæ„Åö„ÄÅgit „Çí‰ΩøÁî®„Åó„Å¶ [**Otter**](https://github.com/DocsaidLab/Otter) „É¢„Ç∏„É•„Éº„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„ÄÅDocker „Ç§„É°„Éº„Ç∏„ÇíÊßãÁØâ„Åó„Åæ„ÅôÔºö

```bash
git clone https://github.com/DocsaidLab/Otter.git
cd Otter
bash docker/build.bash
```

„Éì„É´„Éâ„Çπ„ÇØ„É™„Éó„Éà„ÅÆÂÜÖÂÆπ„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„Åß„ÅôÔºö

```bash title="Otter/docker/build.bash"
docker build \
    -f docker/Dockerfile \
    -t otter_base_image .
```

„Éï„Ç°„Ç§„É´ÂÜÖ„Åß `otter_base_image` „Çí‰ªªÊÑè„ÅÆÂêçÂâç„Å´ÁΩÆ„ÅçÊèõ„Åà„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ„Åì„ÅÆÂêçÂâç„ÅØÂæåÁ∂ö„ÅÆË®ìÁ∑¥„Åß‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ

:::info
PyTorch Lightning „ÅØ„ÄÅPyTorch „Å´Âü∫„Å•„ÅèËªΩÈáè„Å™Ê∑±Â±§Â≠¶Áøí„Éï„É¨„Éº„É†„ÉØ„Éº„ÇØ„Åß„ÅÇ„Çä„ÄÅ„É¢„Éá„É´Ë®ìÁ∑¥„Éó„É≠„Çª„Çπ„ÇíÁ∞°Á¥†Âåñ„Åô„Çã„Åì„Å®„ÇíÁõÆÁöÑ„Å®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇÁ†îÁ©∂„Ç≥„Éº„ÉâÔºà„É¢„Éá„É´ÂÆöÁæ©„ÄÅÂâçÂêë„Åç/Âæå„ÇçÂêë„Åç‰ºùÊí≠„ÄÅ„Ç™„Éó„ÉÜ„Ç£„Éû„Ç§„Ç∂Ë®≠ÂÆö„Å™„Å©Ôºâ„Å®„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞„Ç≥„Éº„ÉâÔºàË®ìÁ∑¥„É´„Éº„Éó„ÄÅ„É≠„Ç∞Ë®òÈå≤„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Éù„Ç§„É≥„Éà‰øùÂ≠ò„Å™„Å©Ôºâ„ÇíÂàÜÈõ¢„Åô„Çã„Åì„Å®„Åß„ÄÅÁ†îÁ©∂ËÄÖ„ÅåÁÖ©Èõë„Å™„Ç®„É≥„Ç∏„Éã„Ç¢„É™„É≥„Ç∞„ÅÆË©≥Á¥∞„ÇíÂá¶ÁêÜ„Åô„Çã„Åì„Å®„Å™„Åè„ÄÅ„É¢„Éá„É´„Åù„ÅÆ„ÇÇ„ÅÆ„Å´ÈõÜ‰∏≠„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ

ËààÂë≥„ÅÆ„ÅÇ„ÇãÊñπ„ÅØ‰ª•‰∏ã„ÅÆ„É™„ÇΩ„Éº„Çπ„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑÔºö

- [**PyTorch Lightning ÂÖ¨Âºè„Çµ„Ç§„Éà**](https://lightning.ai/)
- [**PyTorch Lightning GitHub**](https://github.com/Lightning-AI/pytorch-lightning)
  :::

:::tip
`Otter` „É¢„Ç∏„É•„Éº„É´„Å´„Å§„ÅÑ„Å¶Á∞°Âçò„Å´Ë™¨Êòé„Åó„Åæ„ÅôÔºö

‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å™Âü∫Êú¨ÁöÑ„Å™„É¢„Ç∏„É•„Éº„É´„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„ÅôÔºö

1. `BaseMixin`ÔºöÂü∫Êú¨ÁöÑ„Å™Ë®ìÁ∑¥„É¢„Éá„É´„Åß„ÄÅË®ìÁ∑¥„ÅÆÂü∫Êú¨Ë®≠ÂÆö„ÇíÂê´„Åø„Åæ„Åô„ÄÇ
2. `BorderValueMixin` „Å® `FillValueMixin`ÔºöÁîªÂÉè„ÅÆÊã°Âºµ„Å´‰ΩøÁî®„Åï„Çå„Çã„Éë„Éá„Ç£„É≥„Ç∞„É¢„Éº„Éâ„ÄÇ
3. `build_callback`Ôºö„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÈñ¢Êï∞„ÇíÊßãÁØâ„Åô„Çã„Åü„ÇÅ„ÅÆ„É¢„Ç∏„É•„Éº„É´„ÄÇ
4. `build_dataset`Ôºö„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÇíÊßãÁØâ„Åô„Çã„Åü„ÇÅ„ÅÆ„É¢„Ç∏„É•„Éº„É´„ÄÇ
5. `build_logger`Ôºö„É≠„Ç∞Ë®òÈå≤„ÇíÊßãÁØâ„Åô„Çã„Åü„ÇÅ„ÅÆ„É¢„Ç∏„É•„Éº„É´„ÄÇ
6. `build_trainer`Ôºö„Éà„É¨„Éº„Éä„Éº„ÇíÊßãÁØâ„Åô„Çã„Åü„ÇÅ„ÅÆ„É¢„Ç∏„É•„Éº„É´„ÄÇ
7. `load_model_from_config`ÔºöË®≠ÂÆö„Éï„Ç°„Ç§„É´„Åã„Çâ„É¢„Éá„É´„ÇíË™≠„ÅøËæº„ÇÄ„Åü„ÇÅ„ÅÆ„É¢„Ç∏„É•„Éº„É´„ÄÇ

‰∏ÄÈÉ®„Å´„ÅØ„Ç∑„Çπ„ÉÜ„É†ÊÉÖÂ†±„ÇíË®òÈå≤„Åô„ÇãÊ©üËÉΩ„ÅåÁµÑ„ÅøËæº„Åæ„Çå„Å¶„Åä„Çä„ÄÅÁâπÂÆö„ÅÆË®≠ÂÆö„Éï„Ç°„Ç§„É´ÂΩ¢Âºè„Çí‰ΩøÁî®„Åó„Å™„Åë„Çå„Å∞Ê≠£„Åó„ÅèÂãï‰Ωú„Åó„Åæ„Åõ„Çì„ÄÇ

Áâπ„Å´Â≠¶„Å∂ÂøÖË¶Å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁµåÈ®ì‰∏ä„ÄÅÂêÑ„Ç®„É≥„Ç∏„Éã„Ç¢„ÅåÁã¨Ëá™„ÅÆ„É¢„Éá„É´Ë®ìÁ∑¥ÊñπÊ≥ï„ÇíÈÄ≤Âåñ„Åï„Åõ„Å¶„Åä„Çä„ÄÅ„Åì„Çå„ÅØÁÑ°Êï∞„Å´„ÅÇ„ÇãÂèØËÉΩÊÄß„ÅÆ‰∏Ä„Å§„Å´„Åô„Åé„Åæ„Åõ„Çì„ÄÇÂèÇËÄÉÁ®ãÂ∫¶„Å´„ÅîË¶ß„Åè„Å†„Åï„ÅÑ„ÄÇ
:::

‰ª•‰∏ã„ÅØ„ÄÅ„É¢„Éá„É´Ë®ìÁ∑¥Â∞ÇÁî®„Å´Ë®≠Ë®à„Åï„Çå„Åü [**Dockerfile**](https://github.com/DocsaidLab/Otter/blob/main/docker/Dockerfile) „Åß„ÅôÔºö

```dockerfile title="Otter/docker/Dockerfile"
# syntax=docker/dockerfile:experimental
FROM nvcr.io/nvidia/pytorch:24.12-py3

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONWARNINGS="ignore" \
    DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Taipei

RUN apt-get update -y && \
    apt-get install -y --no-install-recommends \
    tzdata wget git libturbojpeg exiftool ffmpeg poppler-utils libpng-dev \
    libtiff5-dev libjpeg8-dev libopenjp2-7-dev zlib1g-dev gcc \
    libfreetype6-dev liblcms2-dev libwebp-dev tcl8.6-dev tk8.6-dev python3-tk \
    python3-pip libharfbuzz-dev libfribidi-dev libxcb1-dev libfftw3-dev \
    libpq-dev python3-dev gosu && \
    ln -sf /usr/share/zoneinfo/$TZ /etc/localtime && \
    dpkg-reconfigure -f noninteractive tzdata && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

RUN python -m pip install --no-cache-dir -U pip setuptools wheel

COPY . /usr/local/otter
RUN cd /usr/local/otter && \
    python setup.py bdist_wheel && \
    python -m pip install dist/*.whl && \
    cd ~ && rm -rf /usr/local/otter

RUN python -m pip install --no-cache-dir -U \
    tqdm colored ipython tabulate tensorboard scikit-learn fire \
    albumentations "Pillow>=10.0.0" fitsne opencv-fixer prettytable

RUN python -c "from opencv_fixer import AutoFix; AutoFix()"
RUN python -c "import capybara; import chameleon"

WORKDIR /code

ENV ENTRYPOINT_SCRIPT=/entrypoint.sh

RUN printf '#!/bin/bash\n\
    if [ ! -z "$USER_ID" ] && [ ! -z "$GROUP_ID" ]; then\n\
    groupadd -g "$GROUP_ID" -o usergroup\n\
    useradd --shell /bin/bash -u "$USER_ID" -g "$GROUP_ID" -o -c "" -m user\n\
    export HOME=/home/user\n\
    chown -R "$USER_ID":"$GROUP_ID" /home/user\n\
    chown -R "$USER_ID":"$GROUP_ID" /code\n\
    exec gosu "$USER_ID":"$GROUP_ID" "$@"\n\
    else\n\
    exec "$@"\n\
    fi' > "$ENTRYPOINT_SCRIPT" && \
    chmod +x "$ENTRYPOINT_SCRIPT"

ENTRYPOINT ["/bin/bash", "/entrypoint.sh"]

CMD ["bash"]
```

‰∏äË®ò„ÅÆ Dockerfile „ÇíÂü∫„Å´„ÄÅÁîªÂÉèÂá¶ÁêÜ„ÇÑÊ©üÊ¢∞Â≠¶ÁøíÈñ¢ÈÄ£„ÅÆ‰ΩúÊ•≠„Å´ÈÅ©„Åó„Åü„ÄÅÂ§öÊßò„Å™„ÉÑ„Éº„É´„Å®„É©„Ç§„Éñ„É©„É™„ÇíÂê´„ÇÄÊ∑±Â±§Â≠¶Áøí„Ç≥„É≥„ÉÜ„Éä„ÇíÊßãÁØâ„Åß„Åç„Åæ„Åô„ÄÇ

‰ª•‰∏ã„Å´ÈáçË¶Å„Å™ÈÉ®ÂàÜ„ÇíË™¨Êòé„Åó„Åæ„ÅôÔºö

---

```dockerfile
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONWARNINGS="ignore" \
    DEBIAN_FRONTEND=noninteractive \
    TZ=Asia/Taipei
```

Áí∞Â¢ÉÂ§âÊï∞„ÅÆË®≠ÂÆöÔºö

- **`PYTHONDONTWRITEBYTECODE=1`**: `.pyc` „ÅÆ„Ç≥„É≥„Éë„Ç§„É´„Éï„Ç°„Ç§„É´ÁîüÊàê„ÇíÈò≤„Åé„ÄÅ‰∏çÂøÖË¶Å„Å™„Éï„Ç°„Ç§„É´„ÅÆ‰ΩúÊàê„ÇíÊäëÂà∂„Åó„Åæ„Åô„ÄÇ
- **`PYTHONWARNINGS="ignore"`**: Python „ÅÆË≠¶Âëä„ÇíÁÑ°Ë¶ñ„Åó„Åæ„Åô„ÄÇ
- **`DEBIAN_FRONTEND=noninteractive`**: ÂØæË©±Âûã„Éó„É≠„É≥„Éó„Éà„ÇíÁÑ°ÂäπÂåñ„Åó„ÄÅËá™ÂãïÂåñ„Åï„Çå„Åü„Éá„Éó„É≠„Ç§„ÇíÂèØËÉΩ„Å´„Åó„Åæ„Åô„ÄÇ
- **`TZ=Asia/Taipei`**: „Çø„Ç§„É†„Çæ„Éº„É≥„ÇíÂè∞Âåó„Å´Ë®≠ÂÆö„Åó„Åæ„Åô„ÄÇ

:::tip
„ÅäÂ•Ω„Åø„ÅÆ„Çø„Ç§„É†„Çæ„Éº„É≥„Å´Â§âÊõ¥„Åó„Åü„Çä„ÄÅ‰ªñ„ÅÆÁí∞Â¢ÉÂ§âÊï∞„ÇíËøΩÂä†„Åô„Çã„Åì„Å®„ÇÇÂèØËÉΩ„Åß„Åô„ÄÇ
:::

---

```dockerfile
COPY . /usr/local/otter
RUN cd /usr/local/otter && \
    python setup.py bdist_wheel && \
    python -m pip install dist/*.whl && \
    cd ~ && rm -rf /usr/local/otter
```

1. ÁèæÂú®„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅÆÂÖ®ÂÜÖÂÆπ„Çí„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅÆ `/usr/local/otter` „Éë„Çπ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åô„ÄÇ
2. Ë©≤ÂΩì„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÁßªÂãï„Åó„ÄÅ`setup.py` „Çí‰ΩøÁî®„Åó„Å¶ wheel ÂΩ¢Âºè„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ
3. ÁîüÊàê„Åï„Çå„Åü wheel „Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„ÄÅ„Åù„ÅÆÂæå„ÄÅ„Éì„É´„Éâ„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÂâäÈô§„Åó„Å¶Áí∞Â¢É„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó„Åó„Åæ„Åô„ÄÇ

---

```dockerfile
RUN python -m pip install --no-cache-dir -U \
    tqdm colored ipython tabulate tensorboard scikit-learn fire \
    albumentations "Pillow>=10.0.0" fitsne opencv-fixer prettytable
```

ÂøÖË¶Å„Å™ Python „ÅÆ„Çµ„Éº„Éâ„Éë„Éº„ÉÜ„Ç£„É©„Ç§„Éñ„É©„É™„Çí„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Åæ„ÅôÔºö

- **`tqdm`**: „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆ„ÉÑ„Éº„É´„ÄÇ
- **`colored`**: „Çø„Éº„Éü„Éä„É´Âá∫Âäõ„ÅÆÁùÄËâ≤„ÄÇ
- **`ipython`**: ÂØæË©±Âûã Python „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÄÇ
- **`tabulate`**: Ë°®ÂΩ¢Âºè„ÅÆ„Éá„Éº„Çø„Éï„Ç©„Éº„Éû„ÉÉ„Éà„ÉÑ„Éº„É´„ÄÇ
- **`tensorboard`**: Ê∑±Â±§Â≠¶Áøí„ÅÆÂèØË¶ñÂåñ„ÉÑ„Éº„É´„ÄÇ
- **`scikit-learn`**: Ê©üÊ¢∞Â≠¶Áøí„É©„Ç§„Éñ„É©„É™„ÄÇ
- **`fire`**: „Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÁîüÊàê„ÉÑ„Éº„É´„ÄÇ
- **`albumentations`**: ÁîªÂÉè„Éá„Éº„ÇøÊã°Âºµ„É©„Ç§„Éñ„É©„É™„ÄÇ
- **`Pillow`**: ÁîªÂÉèÂá¶ÁêÜ„É©„Ç§„Éñ„É©„É™Ôºà„Éê„Éº„Ç∏„Éß„É≥ 10.0 ‰ª•‰∏äÔºâ„ÄÇ
- **`fitsne`**: t-SNE „ÅÆÈ´òÂäπÁéáÂÆüË£Ö„ÄÇ
- **`opencv-fixer`**: OpenCV ‰øÆÊ≠£„ÉÑ„Éº„É´„ÄÇ
- **`prettytable`**: Ë°®ÂΩ¢Âºè„ÅÆ„Éá„Éº„ÇøÂá∫Âäõ„ÉÑ„Éº„É´„ÄÇ

:::tip
‰ªñ„ÅÆ„ÉÑ„Éº„É´„ÅåÂøÖË¶Å„Å™Â†¥Âêà„ÄÅ„Åì„Åì„Å´ÂØæÂøú„Åô„Çã„É©„Ç§„Éñ„É©„É™„ÇíËøΩÂä†„Åô„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ
:::

---

```dockerfile
RUN python -c "from opencv_fixer import AutoFix; AutoFix()"
RUN python -c "import capybara; import chameleon"
```

‰ª•‰∏ä„ÅÆ 2 Ë°å„ÅØ„ÄÅÁ∞°Âçò„Å™ Python „Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å„Åó„Å¶„Ç§„É≥„Çπ„Éà„Éº„É´„ÅåÊ≠£Â∏∏„Å´Ë°å„Çè„Çå„Åü„Åã„Çí„ÉÜ„Çπ„Éà„Åó„Åæ„ÅôÔºö

1. OpenCV „ÅÆË®≠ÂÆöÂïèÈ°å„ÇíËá™Âãï‰øÆÊ≠£„Åó„Åæ„Åô„ÄÇ
2. `capybara` „Å® `chameleon` „É¢„Ç∏„É•„Éº„É´„ÅåÊ≠£Â∏∏„Å´Âà©Áî®ÂèØËÉΩ„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ

:::tip
OpenCV „ÅØ„Éê„Éº„Ç∏„Éß„É≥„Å´„Çà„Çã‰∏çÂÖ∑Âêà„Åå„Çà„ÅèÁô∫Áîü„Åô„Çã„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ `opencv-fixer` „ÇíÁî®„ÅÑ„Å¶Ëá™Âãï‰øÆÊ≠£„ÇíË°å„ÅÑ„Åæ„Åô„ÄÇ

„Åï„Çâ„Å´„ÄÅ`capybara` „É¢„Ç∏„É•„Éº„É´„Åß„ÅØÊèèÁîªÁî®„ÅÆ„Éï„Ç©„É≥„Éà„Éï„Ç°„Ç§„É´„Çí‰∫ãÂâç„Å´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã„Åü„ÇÅ„ÄÅ„Åì„Çå„Çí„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„Å´„ÅÇ„Çâ„Åã„Åò„ÇÅÂèñÂæó„Åó„Å¶„Åä„Åç„Åæ„Åô„ÄÇ
:::

---

```dockerfile
RUN printf '#!/bin/bash\n\
    if [ ! -z "$USER_ID" ] && [ ! -z "$GROUP_ID" ]; then\n\
    groupadd -g "$GROUP_ID" -o usergroup\n\
    useradd --shell /bin/bash -u "$USER_ID" -g "$GROUP_ID" -o -c "" -m user\n\
    export HOME=/home/user\n\
    chown -R "$USER_ID":"$GROUP_ID" /home/user\n\
    chown -R "$USER_ID":"$GROUP_ID" /code\n\
    exec gosu "$USER_ID":"$GROUP_ID" "$@"\n\
    else\n\
    exec "$@"\n\
    fi' > "$ENTRYPOINT_SCRIPT" && \
    chmod +x "$ENTRYPOINT_SCRIPT"
```

‰ª•‰∏ã„ÅÆ„Ç≥„Éº„Éâ„ÅØ Bash „Çπ„ÇØ„É™„Éó„Éà„ÇíÁîüÊàê„Åó„ÄÅÊ¨°„ÅÆÊ©üËÉΩ„ÇíÂÆüÁèæ„Åó„Åæ„ÅôÔºö

1. Áí∞Â¢ÉÂ§âÊï∞ `USER_ID` „Å® `GROUP_ID` „ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅ„Åù„Çå„Å´Âü∫„Å•„ÅÑ„Å¶„É¶„Éº„Ç∂„Éº„Å®„Ç∞„É´„Éº„Éó„ÇíÂãïÁöÑ„Å´‰ΩúÊàê„Åó„ÄÅÈÅ©Âàá„Å™Ê®©Èôê„ÇíË®≠ÂÆö„Åó„Åæ„Åô„ÄÇ
2. `gosu` „Çí‰ΩøÁî®„Åó„Å¶„ÄÅ„Åù„ÅÆ„É¶„Éº„Ç∂„Éº„Å´Âàá„ÇäÊõø„Åà„ÅüÁä∂ÊÖã„Åß„Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å„Åó„ÄÅ„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅßÊ≠£„Åó„ÅÑÊ®©Èôê„ÇíÊåÅ„Å§Êìç‰Ωú„Çí‰øùË®º„Åó„Åæ„Åô„ÄÇ
3. „Åì„Çå„Çâ„ÅÆÂ§âÊï∞„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂºïÊï∞„Å®„Åó„Å¶Ê∏°„Åï„Çå„Åü„Ç≥„Éû„É≥„Éâ„Çí„Åù„ÅÆ„Åæ„ÅæÂÆüË°å„Åó„Åæ„Åô„ÄÇ

:::tip
`gosu` „ÅØ„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„Åß„ÅÆ„É¶„Éº„Ç∂„ÉºÊ®©Èôê„ÇíÂàá„ÇäÊõø„Åà„Çã„Åü„ÇÅ„ÅÆ„ÉÑ„Éº„É´„Åß„ÄÅ`sudo` „Çí‰ΩøÁî®„Åô„ÇãÈöõ„Å´Áîü„Åò„ÇãÂèØËÉΩÊÄß„ÅÆ„ÅÇ„ÇãÊ®©Èôê„ÅÆÂïèÈ°å„ÇíÂõûÈÅø„Åß„Åç„Åæ„Åô„ÄÇ
:::

## „Éà„É¨„Éº„Éã„É≥„Ç∞„ÅÆÂÆüË°å

Docker „Ç§„É°„Éº„Ç∏„ÅÆÊßãÁØâ„ÅåÂÆå‰∫Ü„Åó„Åü„ÅÆ„Åß„ÄÅ„Åì„ÅÆ„Ç§„É°„Éº„Ç∏„Çí‰ΩøÁî®„Åó„Å¶„É¢„Éá„É´„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ

Ê¨°„Å´„ÄÅ`DocClassifier` „Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´ÁßªÂãï„Åó„ÄÅÊúÄÂàù„Å´ `train.bash` „Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Åæ„ÅôÔºö

- [**DocClassifier/docker/train.bash**](https://github.com/DocsaidLab/DocClassifier/blob/main/docker/train.bash)

```bash title="DocClassifier/docker/train.bash"
#!/bin/bash

docker run \
    -e USER_ID=$(id -u) \
    -e GROUP_ID=$(id -g) \
    --gpus all \
    --shm-size=64g \
    --ipc=host --net=host \
    --cpuset-cpus="0-31" \
    -v $PWD/DocClassifier:/code/DocClassifier \
    -v /data/Dataset:/data/Dataset \ # „Åì„Åì„Åß„ÅØ„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Éá„Éº„Çø„Çª„ÉÉ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
    -it --rm otter_base_image bash -c "
echo '
from fire import Fire
from DocClassifier.model import main_classifier_train

if __name__ == \"__main__\":
    Fire(main_classifier_train)
' > /code/trainer.py && python /code/trainer.py --cfg_name $1
"
```

‰∏äË®ò„ÅÆ„Éï„Ç°„Ç§„É´„Å´„Å§„ÅÑ„Å¶„ÅÆË™¨Êòé„ÅØ‰ª•‰∏ã„ÅÆÈÄö„Çä„Åß„Åô„ÄÇÂ§âÊõ¥„ÇíÂä†„Åà„Åü„ÅÑÂ†¥Âêà„ÅØ„ÄÅÈñ¢ÈÄ£ÊÉÖÂ†±„ÇíÂèÇËÄÉ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

1. **`-e USER_ID=$(id -u)` „Å® `-e GROUP_ID=$(id -g)`**ÔºöÁèæÂú®„ÅÆ„É¶„Éº„Ç∂„Éº„ÅÆ UID „Å® GID „Çí„Ç≥„É≥„ÉÜ„Éä„Å´Ê∏°„Åó„ÄÅ„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅÆ„Éï„Ç°„Ç§„É´Êìç‰Ωú„ÅÆÊ®©Èôê„Åå„Éõ„Çπ„Éà„Å®‰∏ÄËá¥„Åô„Çã„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ
2. **`--gpus all`**ÔºöGPU „Çµ„Éù„Éº„Éà„ÇíÊúâÂäπ„Å´„Åó„ÄÅ„Åô„Åπ„Å¶„ÅÆÂà©Áî®ÂèØËÉΩ„Å™ GPU „É™„ÇΩ„Éº„Çπ„Çí„Ç≥„É≥„ÉÜ„Éä„Å´Ââ≤„ÇäÂΩì„Å¶„Åæ„Åô„ÄÇ
3. **`--shm-size=64g`**ÔºöÂÖ±Êúâ„É°„É¢„É™„ÅÆ„Çµ„Ç§„Ç∫„Çí 64GB „Å´Ë®≠ÂÆö„Åó„ÄÅÂ§ßÈáè„ÅÆ„É°„É¢„É™„ÇíÂøÖË¶Å„Å®„Åô„ÇãÊ∑±Â±§Â≠¶Áøí„ÅÆ„Çø„Çπ„ÇØ„Å´ÈÅ©„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
4. **`--ipc=host` „Å® `--net=host`**Ôºö„Éõ„Çπ„Éà„ÅÆ„Éó„É≠„Çª„ÇπÈñìÈÄö‰ø°„Å®„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„É™„ÇΩ„Éº„Çπ„ÇíÂÖ±Êúâ„Åó„Å¶„ÄÅ„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Å®‰∫íÊèõÊÄß„ÇíÂêë‰∏ä„Åï„Åõ„Åæ„Åô„ÄÇ
5. **`--cpuset-cpus="0-31"`**Ôºö„Ç≥„É≥„ÉÜ„Éä„Åå CPU 0-31 „Ç≥„Ç¢„ÅÆ„Åø„Çí‰ΩøÁî®„Åô„Çã„Çà„ÅÜ„Å´Âà∂Èôê„Åó„ÄÅ‰ªñ„ÅÆ„Éó„É≠„Çª„Çπ„Å´ÂΩ±Èüø„Çí‰∏é„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ
6. **`-v $PWD/DocClassifier:/code/DocClassifier`**Ôºö„Éõ„Çπ„Éà„ÅÆÁèæÂú®„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„ÅÆ `DocClassifier` „Éï„Ç©„É´„ÉÄ„Çí„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅÆ `/code/DocClassifier` „Å´„Éû„Ç¶„É≥„Éà„Åó„Åæ„Åô„ÄÇ
7. **`-v /data/Dataset:/data/Dataset`**Ôºö„Éõ„Çπ„Éà„ÅÆ„Éá„Éº„Çø„Çª„ÉÉ„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™„Çí„Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅÆ `/data/Dataset` „Å´„Éû„Ç¶„É≥„Éà„Åó„Åæ„Åô„ÄÇÂÆüÈöõ„ÅÆÁä∂Ê≥Å„Å´Âøú„Åò„Å¶Â§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
8. **`-it`**Ôºö„Ç§„É≥„Çø„É©„ÇØ„ÉÜ„Ç£„Éñ„É¢„Éº„Éâ„Åß„Ç≥„É≥„ÉÜ„Éä„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ
9. **`--rm`**Ôºö„Ç≥„É≥„ÉÜ„ÉäÁµÇ‰∫ÜÊôÇ„Å´Ëá™ÂãïÁöÑ„Å´„Ç≥„É≥„ÉÜ„Éä„ÇíÂâäÈô§„Åó„ÄÅ‰∏ÄÊôÇÁöÑ„Å™„Ç≥„É≥„ÉÜ„Éä„ÅåÊ∫ú„Åæ„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åô„ÄÇ
10. **`otter_base_image`**Ôºö‰ª•Ââç„Å´ÊßãÁØâ„Åó„Åü Docker „Ç§„É°„Éº„Ç∏„ÅÆÂêçÂâç„Çí‰ΩøÁî®„Åó„Åæ„Åô„ÄÇÂ§âÊõ¥„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„ÄÅËá™ÂàÜ„ÅÆÂêçÂâç„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ

:::tip
„Åì„Åì„Åß„ÅØ„ÅÑ„Åè„Å§„Åã„ÅÆ‰∏ÄËà¨ÁöÑ„Å™ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„ÅôÔºö

1. `--gpus` „ÅåÂãï‰Ωú„Åó„Å™„ÅÑÂ†¥ÂêàÔºödocker „ÅåÊ≠£„Åó„Åè„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÂèÇËÄÉÔºö[**ÈÄ≤Èöé„Ç§„É≥„Çπ„Éà„Éº„É´**](../capybara/advance.md)„ÄÇ
2. `--cpuset-cpus`ÔºöCPU „Ç≥„Ç¢„ÅÆÊï∞„ÇíË∂Ö„Åà„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
3. Dockerfile ÂÜÖ„Åß‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„ÅôÔºö`WORKDIR /code`„ÄÇ„ÇÇ„ÅóÊ∞ó„Å´ÂÖ•„Çâ„Å™„Åë„Çå„Å∞„ÄÅËá™ÂàÜ„ÅßÂ§âÊõ¥„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
4. `-v`Ôºö„Éû„Ç¶„É≥„Éà„Åó„Å¶„ÅÑ„Çã‰ΩúÊ•≠„Éá„Ç£„É¨„ÇØ„Éà„É™„ÇíÂøÖ„ÅöÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÈñìÈÅï„Åà„Çã„Å®„Éï„Ç°„Ç§„É´„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ
5. `DocClassifier` „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÜÖ„Åß„ÅØ„ÄÅÂ§ñÈÉ®„Åã„Çâ ImageNet „Éá„Éº„Çø„Çª„ÉÉ„Éà„Çí„Éû„Ç¶„É≥„Éà„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÂøÖË¶Å„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Åì„ÅÆÈÉ®ÂàÜ„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
   :::

---

„Ç≥„É≥„ÉÜ„ÉäËµ∑ÂãïÂæå„ÄÅÁßÅ„Åü„Å°„ÅØ„Éà„É¨„Éº„Éã„É≥„Ç∞„Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å„Åó„Åæ„Åô„ÄÇ„Åì„Åì„Åß„ÅØÁõ¥Êé• Python „Çπ„ÇØ„É™„Éó„Éà„ÇíË®òËø∞„Åó„Åæ„ÅôÔºö

```bash
bash -c "
echo '
from fire import Fire
from DocClassifier.model import main_classifier_train

if __name__ == \"__main__\":
    Fire(main_classifier_train)
' > /code/trainer.py && python /code/trainer.py --cfg_name $1
"
```

1. **`echo`**ÔºöPython „ÅÆ„Ç≥„Éº„Éâ„Çí `/code/trainer.py` „Éï„Ç°„Ç§„É´„Å´Êõ∏„ÅçËæº„Åø„Åæ„Åô„ÄÇ„Åì„ÅÆ„Ç≥„Éº„Éâ„ÅÆÊ©üËÉΩ„ÅØÊ¨°„ÅÆÈÄö„Çä„Åß„ÅôÔºö

   - **`from fire import Fire`**Ôºö`fire` „É©„Ç§„Éñ„É©„É™„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„ÄÅ„Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„ÇíÁîüÊàê„Åó„Åæ„Åô„ÄÇ
   - **`from DocClassifier.model import main_classifier_train`**Ôºö`DocClassifier.model` „É¢„Ç∏„É•„Éº„É´„Åã„Çâ„Éà„É¨„Éº„Éã„É≥„Ç∞„ÅÆ„É°„Ç§„É≥Èñ¢Êï∞„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇ
   - **`if __name__ == "__main__":`**Ôºö„Åì„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÅåÂÆüË°å„Åï„Çå„Çã„Å®„ÄÅ`Fire(main_classifier_train)` „ÇíËµ∑Âãï„Åó„ÄÅ„Ç≥„Éû„É≥„Éâ„É©„Ç§„É≥ÂºïÊï∞„ÇíÈñ¢Êï∞„Å´„Éê„Ç§„É≥„Éâ„Åó„Åæ„Åô„ÄÇ

2. **`python /code/trainer.py --cfg_name $1`**ÔºöÁîüÊàê„Åó„Åü Python „Çπ„ÇØ„É™„Éó„Éà„ÇíÂÆüË°å„Åó„ÄÅ`$1` „ÅßÊ∏°„Åï„Çå„ÅüÂºïÊï∞„Çí `--cfg_name` „ÅÆÂÄ§„Å®„Åó„Å¶‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ„Åì„ÅÆÂºïÊï∞„ÅØÈÄöÂ∏∏„ÄÅË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíÊåáÂÆö„Åô„Çã„Åü„ÇÅ„Å´‰ΩøÁî®„Åï„Çå„Åæ„Åô„ÄÇ

### „Éë„É©„É°„Éº„ÇøË®≠ÂÆö

„É¢„Éá„É´„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„Å´„ÅØ„ÄÅË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíÁΩÆ„Åè„Åü„ÇÅ„ÅÆÂ∞ÇÁî®„Éá„Ç£„É¨„ÇØ„Éà„É™„Åå„ÅÇ„Çä„ÄÅÈÄöÂ∏∏„ÅØ `config` „Å®ÂêçÂâç„Åå‰ªò„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ

„Åì„ÅÆ„Éá„Ç£„É¨„ÇØ„Éà„É™ÂÜÖ„Åß„ÄÅ„Åï„Åæ„Åñ„Åæ„Å™Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÇíÂÆöÁæ©„Åß„Åç„ÄÅÁï∞„Å™„Çã„É¢„Éá„É´„ÅÆ„Éà„É¨„Éº„Éã„É≥„Ç∞„Å´‰ΩøÁî®„Åó„Åæ„Åô„ÄÇ‰æã„Åà„Å∞Ôºö

```yaml title="config/lcnet050_cosface_f256_r128_squeeze_lbn_imagenet.yaml"
common:
  batch_size: 1024
  image_size: [128, 128]
  is_restore: False
  restore_ind: ""
  restore_ckpt: ""
  preview_batch: 1000
  use_imagenet: True
  use_clip: False

global_settings:
  image_size: [128, 128]

trainer:
  max_epochs: 40
  precision: 32
  val_check_interval: 1.0
  gradient_clip_val: 5
  accumulate_grad_batches: 1
  accelerator: gpu
  devices: [0]

model:
  name: ClassifierModel
  backbone:
    name: Backbone
    options:
      name: timm_lcnet_050
      pretrained: True
      features_only: True
  head:
    name: FeatureLearningSqueezeLBNHead
    options:
      in_dim: 256
      embed_dim: 256
      feature_map_size: 4
  loss:
    name: CosFace
    options:
      s: 64
      m: 0.4
    num_classes: -1
    embed_dim: 256

onnx:
  name: WarpFeatureLearning
  input_shape:
    img:
      shape: [1, 3, 128, 128]
      dtype: float32
  input_names: ["img"]
  output_names:
    - feats
  dynamic_axes:
    img:
      "0": batch_size
    output:
      "0": batch_size
  options:
    opset_version: 16
    verbose: False
    do_constant_folding: True

dataset:
  train_options:
    name: SynthDataset
    options:
      aug_ratio: 1
      length_of_dataset: 2560000
      use_imagenet: True
      use_clip: False
  valid_options:
    name: RealDataset
    options:
      return_tensor: True

dataloader:
  train_options:
    batch_size: -1
    num_workers: 24
    shuffle: False
    drop_last: False
  valid_options:
    batch_size: -1
    num_workers: 16
    shuffle: False
    drop_last: False

optimizer:
  name: AdamW
  options:
    lr: 0.001
    betas: [0.9, 0.999]
    weight_decay: 0.001
    amsgrad: False

lr_scheduler:
  name: PolynomialLRWarmup
  options:
    warmup_iters: -1
    total_iters: -1
  pl_options:
    monitor: loss
    interval: step

callbacks:
  - name: ModelCheckpoint
    options:
      monitor: valid_fpr@4
      mode: max
      verbose: True
      save_last: True
      save_top_k: 5
  - name: LearningRateMonitor
    options:
      logging_interval: step
  - name: RichModelSummary
    options:
      max_depth: 3
  - name: CustomTQDMProgressBar
    options:
      unit_scale: -1

logger:
  name: TensorBoardLogger
  options:
    save_dir: logger
```

ÂêÑ„Éï„Ç£„Éº„É´„Éâ„ÅÆ„Ç≠„ÉºÂÄ§„ÅØ„Åô„Åß„Å´ `Otter` „É¢„Ç∏„É•„Éº„É´ÂÜÖ„ÅßÂÆöÁæ©„Åï„Çå„Å¶„Åä„Çä„ÄÅ„Åì„ÅÆÂëΩÂêçÊñπÊ≥ï„Å´Âæì„ÅÜ„Å†„Åë„ÅßÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Åæ„Åô„ÄÇ

„Åì„Åì„Åæ„ÅßË™≠„Çì„Å†„ÅÇ„Å™„Åü„ÅØ„ÄÅ„Å™„ÅúÊúÄÂàù„Å´„Äå`Otter` „É¢„Ç∏„É•„Éº„É´„ÇíÁâπÂà•„Å´Â≠¶„Å∂ÂøÖË¶Å„ÅØ„Å™„ÅÑ„Äç„Å®Ë®Ä„Å£„Åü„ÅÆ„ÅãÁêÜËß£„Åß„Åç„Çã„Åß„Åó„Çá„ÅÜÔºÅ

„Åì„Åì„Å´„ÅØ„Åô„Åß„Å´‰∏ÄÂÆö„ÅÆÊäΩË±°Âåñ„Å®„É©„ÉÉ„Éî„É≥„Ç∞„ÅåÊñΩ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„Åù„Çå„Åß„ÇÇÈùûÂ∏∏„Å´„Ç´„Çπ„Çø„Éû„Ç§„Ç∫„Åï„Çå„Åü„Ç¢„Éº„Ç≠„ÉÜ„ÇØ„ÉÅ„É£„Åß„Åô„ÄÇ

ÊúÄÁµÇÁöÑ„Å´„ÅØËá™ÂàÜ„Å´ÊúÄÈÅ©„Å™ÊñπÊ≥ï„ÇíË¶ã„Å§„Åë„Çã„Åì„Å®„ÅåÂøÖË¶Å„Åß„Åô„ÅÆ„Åß„ÄÅ„Åì„ÅÆÂΩ¢Âºè„Å´„ÅÇ„Åæ„Çä„Åì„Å†„Çè„ÇãÂøÖË¶Å„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ

### Ë®ìÁ∑¥ÈñãÂßã

ÊúÄÂæå„Å´„ÄÅ`DocClassifier` „ÅÆ‰∏ä‰Ωç„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÁßªÂãï„Åó„ÄÅ‰ª•‰∏ã„ÅÆ„Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å„Åó„Å¶Ë®ìÁ∑¥„ÇíÈñãÂßã„Åó„Åæ„ÅôÔºö

```bash
# Âæå„ÅßËá™ÂàÜ„ÅÆË®≠ÂÆö„Éï„Ç°„Ç§„É´Âêç„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
bash DocClassifier/docker/train.bash lcnet050_cosface_f256_r128_squeeze_lbn_imagenet
```

„Åì„Çå„Çâ„ÅÆÊâãÈ†Ü„ÇíÈÄö„Åò„Å¶„ÄÅDocker „Ç≥„É≥„ÉÜ„ÉäÂÜÖ„ÅßÂÆâÂÖ®„Å´„É¢„Éá„É´Ë®ìÁ∑¥„ÅÆ„Çø„Çπ„ÇØ„ÇíÂÆüË°å„Åß„Åç„ÄÅDocker „ÅÆÈöîÈõ¢Áí∞Â¢É„ÇíÂà©Áî®„Åó„Å¶‰∏ÄË≤´ÊÄß„Å®ÂÜçÁèæÊÄß„ÇíÁ¢∫‰øù„Åß„Åç„Åæ„Åô„ÄÇ„Åì„ÅÆÊñπÊ≥ï„Å´„Çà„Çä„ÄÅ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Éá„Éó„É≠„Ç§„É°„É≥„Éà„Å®Êã°Âºµ„Åå„Çà„Çä‰æøÂà©„ÅßÊüîËªü„Å´„Å™„Çä„Åæ„Åô„ÄÇ

## ONNX „Å∏„ÅÆÂ§âÊèõ

„Åì„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Åß„ÅØ„ÄÅ„É¢„Éá„É´„Çí ONNX „Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´Â§âÊèõ„Åô„ÇãÊñπÊ≥ï„ÇíË™¨Êòé„Åó„Åæ„Åô„ÄÇ

„Åæ„Åö„ÄÅ`to_onnx.bash` „Éï„Ç°„Ç§„É´„ÅÆÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö

```bash title="DocClassifier/docker/to_onnx.bash"
#!/bin/bash

docker run \
    -e USER_ID=$(id -u) \
    -e GROUP_ID=$(id -g) \
    --gpus all \
    --shm-size=64g \
    --ipc=host --net=host \
    --cpuset-cpus="0-31" \
    -v $PWD/DocClassifier:/code/DocClassifier \
    -it --rm otter_base_image bash -c "
echo '
from fire import Fire
from DocClassifier.model import main_classifier_torch2onnx

if __name__ == \"__main__\":
    Fire(main_classifier_torch2onnx)
' > /code/torch2onnx.py && python /code/torch2onnx.py --cfg_name $1
"
```

„Åì„ÅÆ„Éï„Ç°„Ç§„É´„Åã„ÇâÁ¢∫Ë™ç„ÇíÂßã„ÇÅ„Åæ„Åô„Åå„ÄÅÂ§âÊõ¥„ÅØÂøÖË¶Å„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂ§âÊõ¥„ÅåÂøÖË¶Å„Å™„ÅÆ„ÅØÂØæÂøú„Åô„Çã„Éï„Ç°„Ç§„É´ `model/to_onnx.py` „Åß„Åô„ÄÇ

Ë®ìÁ∑¥ÈÅéÁ®ã„Åß„ÅØ„ÄÅ„É¢„Éá„É´„ÅÆË®ìÁ∑¥„ÇíÁõ£Ë¶ñ„Åô„Çã„Åü„ÇÅ„Å´Â§ö„Åè„ÅÆÂàÜÂ≤ê„Çí‰ΩøÁî®„Åô„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„Åå„ÄÅÊé®Ë´ñÊÆµÈöé„Åß„ÅØ„Åù„ÅÆ„ÅÜ„Å°„ÅÆ 1 „Å§„ÅÆÂàÜÂ≤ê„ÅÆ„Åø„ÅåÂøÖË¶Å„Å´„Å™„ÇãÂ†¥Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ„Åó„Åü„Åå„Å£„Å¶„ÄÅ„É¢„Éá„É´„Çí ONNX „Éï„Ç©„Éº„Éû„ÉÉ„Éà„Å´Â§âÊèõ„Åó„ÄÅÊé®Ë´ñÊÆµÈöé„ÅßÂøÖË¶Å„Å™ÂàÜÂ≤ê„ÅÆ„Åø„ÇíÊÆã„ÅôÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇ

‰æã„Åà„Å∞Ôºö

```python
class WarpFeatureLearning(nn.Module):

    def __init__(self, model: L.LightningModule):
        super().__init__()
        self.backbone = model.backbone
        self.head = model.head

    def forward(self, img: torch.Tensor):
        xs = self.backbone(img)
        features = self.head(xs)
        return features
```

‰∏äË®ò„ÅÆ‰æã„Åß„ÅØ„ÄÅÊé®Ë´ñÁî®„ÅÆÂàÜÂ≤ê„Å†„Åë„ÇíÂèñ„ÇäÂá∫„Åó„ÄÅ„Åù„Çå„ÇíÊñ∞„Åó„ÅÑ„É¢„Éá„É´ `WarpFeatureLearning` „Å®„Åó„Å¶„É©„ÉÉ„Éó„Åó„Åæ„Åó„Åü„ÄÇÊ¨°„Å´„ÄÅyaml Ë®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅßÂØæÂøú„Åô„Çã„Éë„É©„É°„Éº„ÇøË®≠ÂÆö„ÇíË°å„ÅÑ„Åæ„ÅôÔºö

```yaml
onnx:
  name: WarpFeatureLearning
  input_shape:
    img:
      shape: [1, 3, 128, 128]
      dtype: float32
  input_names: ["img"]
  output_names:
    - feats
  dynamic_axes:
    img:
      "0": batch_size
    output:
      "0": batch_size
  options:
    opset_version: 16
    verbose: False
    do_constant_folding: True
```

„É¢„Éá„É´„ÅÆÂÖ•Âäõ„Çµ„Ç§„Ç∫„ÄÅÂÖ•ÂäõÂêç„ÄÅÂá∫ÂäõÂêç„ÄÅ„Åä„Çà„Å≥ ONNX „ÅÆ„Éê„Éº„Ç∏„Éß„É≥Áï™Âè∑„Å´„Å§„ÅÑ„Å¶Ë™¨Êòé„Åó„Åæ„Åô„ÄÇ

Â§âÊèõÈÉ®ÂàÜ„ÅØ„Åô„Åß„Å´„Åì„Å°„Çâ„Åß‰ΩúÊàêÊ∏à„Åø„Åß„Åô„ÄÇ‰∏äË®ò„ÅÆÂ§âÊõ¥„ÇíÂÆå‰∫Ü„Åó„ÅüÂæå„ÄÅ`model/to_onnx.py` „Éï„Ç°„Ç§„É´„Åå„ÅÇ„Å™„Åü„ÅÆ„É¢„Éá„É´„ÇíÊåá„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„ÄÅ`DocClassifier` „ÅÆ‰∏ä‰Ωç„Éá„Ç£„É¨„ÇØ„Éà„É™„Å´ÁßªÂãï„Åó„Å¶„ÄÅ‰ª•‰∏ã„ÅÆ„Ç≥„Éû„É≥„Éâ„ÇíÂÆüË°å„Åó„Å¶Â§âÊèõ„ÇíÈñãÂßã„Åó„Åæ„ÅôÔºö

```bash
# Âæå„ÅßËá™ÂàÜ„ÅÆË®≠ÂÆö„Éï„Ç°„Ç§„É´Âêç„Å´ÁΩÆ„ÅçÊèõ„Åà„Å¶„Åè„Å†„Åï„ÅÑ
bash DocClassifier/docker/to_onnx.bash lcnet050_cosface_f256_r128_squeeze_lbn_imagenet
```

## ÊúÄÂæå„Å´

ÂÜçÂ∫¶Âº∑Ë™ø„Åó„Åæ„Åô„Åå„ÄÅÁßÅ„Åü„Å°„ÅØ„Åô„Åπ„Å¶„ÅÆ‰ΩúÊ•≠„Çí Docker ÂÜÖ„ÅßË°å„ÅÜ„Åì„Å®„ÇíÊé®Â•®„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åì„Çå„Å´„Çà„Çä„ÄÅÁí∞Â¢É„Åå‰∏ÄË≤´ÊÄß„Çí‰øù„Å°„ÄÅ‰∏çË¶Å„Å™ÂïèÈ°å„ÇíÈÅø„Åë„Çã„Åì„Å®„Åå„Åß„Åç„Åæ„Åô„ÄÇ

‰ª•‰∏ä„ÅÆË™¨Êòé„ÇíÈÄö„Åò„Å¶„ÄÅ„É¢„Éá„É´Ë®ìÁ∑¥„ÅÆ„Éó„É≠„Çª„Çπ„Çí„Åä„Åä„Çà„ÅùÊääÊè°„Åß„Åç„Åü„Å®ÊÄù„ÅÑ„Åæ„Åô„ÄÇÂÆüÈöõ„ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„Åß„ÅØ„ÄÅ„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅÆÊ∫ñÂÇô„ÄÅ„É¢„Éá„É´„ÅÆ„Éë„É©„É°„Éº„ÇøË™øÊï¥„ÄÅË®ìÁ∑¥ÈÅéÁ®ã„ÅÆÁõ£Ë¶ñ„Å™„Å©„ÄÅ„Åï„Çâ„Å´Â§ö„Åè„ÅÆÂïèÈ°å„Å´Áõ¥Èù¢„Åô„Çã„Åã„ÇÇ„Åó„Çå„Åæ„Åõ„Çì„ÄÇ„Åü„Å†„Åó„ÄÅ„Åì„Çå„Çâ„ÅÆÂïèÈ°å„ÅØÁ¥∞„Åã„Åô„Åé„Å¶„ÄÅ„Åô„Åπ„Å¶„ÇíÂàóÊåô„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ„Åì„ÅÆÊñáÁ´†„Åß„ÅØÂü∫Êú¨ÁöÑ„Å™ÊåáÈáù„ÇíÊèê‰æõ„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ

„Å®„Å´„Åã„Åè„ÄÅÁ¥†Êô¥„Çâ„Åó„ÅÑ„É¢„Éá„É´„ÇíÊâã„Å´ÂÖ•„Çå„Çã„Åì„Å®„ÇíÁ•à„Å£„Å¶„ÅÑ„Åæ„ÅôÔºÅ
