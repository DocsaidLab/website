---
slug: mac-forticlient-vpn-split-routing
title: FortiClient VPN ã®åˆ†å‰²ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨­å®šã¨ãƒ«ãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
authors: Z. Yuan
tags: [vpn-routing, macos, forticlient]
image: /ja/img/2025/0802.jpg
description: FortiClient ã‚’ä¼šç¤¾ã®å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿ã«é™å®šã—ã€ãã‚Œä»¥å¤–ã®é€šä¿¡ã¯ã™ã¹ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã«æˆ»ã™ã€‚
---

ä»¥å‰ã€VPN ã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å¤‰æ›´ã™ã‚‹æ–¹æ³•ã‚’å…±æœ‰ã—ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

- å‰æï¼š[**VPN ã«é¸æŠçš„ãªãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¨­å®šã™ã‚‹**](/ja/blog/mac-selective-vpn-routing)

<!-- truncate -->

å½“æ™‚ä½¿ç”¨ã—ã¦ã„ãŸ VPN ã¯ L2TP æ–¹å¼ã§ã€`/etc/ppp/ip-up`ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½¿ã£ã¦ãƒ«ãƒ¼ãƒˆã‚’å¤‰æ›´ã§ãã¾ã—ãŸã€‚

ã—ã‹ã—ã€ä»•äº‹ã®éƒ½åˆã§æ–°ã—ã„ VPN ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹**FortiClient**ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸã€‚

ã™ã‚‹ã¨ã€å¾“æ¥ã®æ–¹æ³•ã¯ä½¿ãˆãªããªã‚Šã¾ã—ãŸã€‚

:::info
FortiClient ã¯ Fortinet ç¤¾ãŒæä¾›ã™ã‚‹ã‚»ã‚­ãƒ¥ã‚¢ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã§ã€ä¸»ãªç”¨é€”ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. **VPN æ¥ç¶šãƒ„ãƒ¼ãƒ«**
   FortiClient ã¯ SSL VPN ã¨ IPSec VPN ã«å¯¾å¿œã—ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå®‰å…¨ã«ãƒªãƒ¢ãƒ¼ãƒˆã‹ã‚‰ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚FortiGate ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«ã®ãƒãƒªã‚·ãƒ¼ã¨é€£æºã—ã€ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨æ¥ç¶šç®¡ç†ã‚’æä¾›ã—ã¾ã™ã€‚

2. **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿è­·**
   VPN æ©Ÿèƒ½ã«åŠ ãˆã€ãƒãƒ«ã‚¦ã‚§ã‚¢é˜²å¾¡ã€ã‚¦ã‚§ãƒ–ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã€è¡Œå‹•è§£æãªã©ã®æ©Ÿèƒ½ã‚’å‚™ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç«¯æœ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¼·åŒ–ã—ã¾ã™ã€‚

3. **Fortinet ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã¨ã®çµ±åˆ**
   FortiGateã€FortiAnalyzerã€EMS ãªã©ã® Fortinet è£½å“ã¨é€£æºã—ã€çµ±ä¸€ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£è¦–ãƒ»ç®¡ç†ã‚’å®Ÿç¾ã—ã¾ã™ã€‚

4. **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ å¯¾å¿œ**
   Windowsã€macOSã€Linuxã€iOSã€Android ãªã©å¤šæ§˜ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚µãƒãƒ¼ãƒˆã—ã€ä¼æ¥­å†…ã®ä¸€æ‹¬å±•é–‹ã¨ç®¡ç†ãŒå®¹æ˜“ã§ã™ã€‚

ç°¡å˜ã«è¨€ãˆã°ã€FortiClient ã¯ãƒªãƒ¢ãƒ¼ãƒˆæ¥ç¶šã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿è­·ã‚’å…¼ã­å‚™ãˆãŸä¼æ¥­å‘ã‘ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«ã§ã‚ã‚Šã€ç‰¹ã«ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã®å³å¯†ãªç®¡ç†ãŒæ±‚ã‚ã‚‰ã‚Œã‚‹çµ„ç¹”ã«é©ã—ã¦ã„ã¾ã™ã€‚
:::

## ãªãœç„¡åŠ¹ã«ãªã‚‹ã®ã‹ï¼Ÿ

FortiClient ã¯ macOS ä¸Šã§ `utunX` ã¨ã„ã†ä»®æƒ³ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®ã‚ˆã†ãª **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆ** ã‚’ç©æ¥µçš„ã«ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã™ã€‚ã‚ˆãã‚ã‚‹çµ„ã¿åˆã‚ã›ã¯ï¼š

```
0.0.0.0/1      â†’ utunX
128.0.0.0/1    â†’ utunX
default        â†’ utunX
```

ã“ã‚Œã‚‰ 3 ã¤ã‚’åˆã‚ã›ã‚‹ã¨ã€Œã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒ VPN ã‚’çµŒç”±ã™ã‚‹ã€ã“ã¨ã«ãªã‚Šã¾ã™ã€‚ã¾ãŸã€æ¥ç¶šã™ã‚‹ãŸã³ã«ãƒ­ãƒ¼ã‚«ãƒ«è¨­å®šãŒä¸Šæ›¸ãã•ã‚Œã‚‹ãŸã‚ã€å˜ã« `/etc/ppp/ip-up` ã ã‘ã§ã¯åˆ†å‰²ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å½¹å‰²ã‚’æœãŸã›ã¾ã›ã‚“ã€‚

ã§ã¯ã€ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã‹ï¼ŸğŸ’¢

ãŸã ã® VPN ãƒ„ãƒ¼ãƒ«ãªã®ã«ã€å…¨ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å¥ªãŠã†ã¨ã™ã‚‹ã®ã‹ï¼Ÿ

## ã¤ã¾ã‚Šï¼Ÿ

ä»Šå›ã®ç§ã®ç›®çš„ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€ä»¥ä¸‹ã®æ¡ä»¶ã ã‘æº€ãŸã›ã°è‰¯ã„ï¼š

- **ä¼šç¤¾ã®å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯**ï¼ˆä¾‹ï¼š`10.0.0.0/8`ï¼‰ã¯ VPN çµŒç”±
- **ãƒ­ãƒ¼ã‚«ãƒ« LANï¼ä¸€èˆ¬çš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ** ã¯ç‰©ç†ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆWi-Fi ã‚„æœ‰ç·š LAN ãªã©ï¼‰ã‚’ç›´æ¥é€šã‚‹
- ç¾åœ¨ã® VPN ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’è‡ªå‹•æ¤œå‡º
- ãƒ«ãƒ¼ãƒˆè¨­å®šãŒæ­£ã—ãåæ˜ ã•ã‚Œã¦ã„ã‚‹ã‹æ¤œè¨¼ã§ãã‚‹ä»•çµ„ã¿ã‚’æä¾›

ä»¥ä¸‹ã€ã¾ãšã¯æ‰‹å‹•ã‚³ãƒãƒ³ãƒ‰ã‚’èª¬æ˜ã—ã€æœ€å¾Œã«è‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

---

## 1. ãƒ«ãƒ¼ãƒˆã®ä¿®æ­£

FortiClient ã¯æ¥ç¶šæ™‚ã«ä»¥ä¸‹ã® 3 ã¤ã®å¼·åˆ¶ãƒ«ãƒ¼ãƒˆã‚’å¯†ã‹ã«è¿½åŠ ã—ã€ã™ã¹ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ VPN ã«å¼•ãè¾¼ã¿ã¾ã™ï¼š

```
0.0.0.0/1
128.0.0.0/1
default
```

ã“ã‚Œã‚‰ 3 ã¤ã¯ IPv4 å…¨ä½“ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ã‚«ãƒãƒ¼ã—ã¦ãŠã‚Šã€å…¨ã¦ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¦æ±‚ã‚’ä¸¸ã”ã¨æ•æ‰ã—ã¦ã—ã¾ã„ã¾ã™ã€‚

ãªã®ã§æœ€åˆã«ã‚„ã‚‹ã“ã¨ã¯ã€ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã™ï¼š

```bash
for cidr in default 0.0.0.0/1 128.0.0.0/1; do
  sudo route -q -n delete -ifscope "$VPN_IF" "$cidr"
done
```

> `$VPN_IF` ã¯ç§ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§è‡ªå‹•çš„ã«ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆä¾‹ï¼šutun4ã€utun6 ãªã©ï¼‰ã‚’è¦‹ã¤ã‘ã‚‹ãŸã‚ã®å¤‰æ•°ã§ã™ã€‚

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯éå¸¸ã«é‡è¦ã§ã€å‰Šé™¤ã«å¤±æ•—ã™ã‚‹ã¨ VPN ãŒå…¨ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’å¥ªã„ç¶šã‘ã¾ã™ã€‚å‰Šé™¤æ™‚ã« "not in table" ã¨è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ãŒã€ãã‚Œã¯è©²å½“ãƒ«ãƒ¼ãƒˆãŒå­˜åœ¨ã—ãªã„ã ã‘ãªã®ã§ç„¡è¦–ã—ã¦æ§‹ã„ã¾ã›ã‚“ã€‚

---

## 2. ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã‚’å¾©å…ƒ

VPN ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ãŸã‚‰ã€å…ƒã€…ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’æˆ»ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã†ã™ã‚‹ã“ã¨ã§ `google.com` ã‚„ `youtube.com` ã®ã‚ˆã†ãªä¸€èˆ¬çš„ãªã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡ã¯ç‰©ç†ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆen0ã€en1 ãªã©ï¼‰ã‚’çµŒç”±ã—ã¾ã™ã€‚

```bash
if ! sudo route -n change default "$LOCAL_GW"; then
  sudo route -n add default "$LOCAL_GW"
fi
```

> `$LOCAL_GW` ã¯ `netstat` ã‚³ãƒãƒ³ãƒ‰ãªã©ã‹ã‚‰è‡ªå‹•çš„ã«å–å¾—ã—ãŸå…ƒã®ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼ˆä¾‹ï¼š192.168.0.1ï¼‰ã§ã€æ‰‹å‹•å…¥åŠ›ã¯ä¸è¦ã§ã™ã€‚

---

## 3. ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å°‚ç”¨ãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ 

æ¬¡ã« VPN ãŒç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®ã¿ã‚’æ‰±ã†ã‚ˆã†ã«è¨­å®šã—ã¾ã™ã€‚

ä»®ã«ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒ `10.0.0.0/8` ã ã¨ã™ã‚‹ã¨ã€VPN ã®ãƒ”ã‚¢å…ˆ IP ã«ãƒ«ãƒ¼ãƒˆã‚’å‘ã‘ã¾ã™ï¼š

```bash
sudo route -n add -net 10.0.0.0/8 "$VPN_PEER"
```

æ—¢ã«ãƒ«ãƒ¼ãƒˆãŒå­˜åœ¨ã—ã¦ã„ã‚Œã° `change` ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ï¼š

```bash
sudo route -n change -net 10.0.0.0/8 "$VPN_PEER"
```

> `$VPN_PEER` ã¯ VPN ã® Point-to-Point å¯¾å‘å…ˆ IP ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ `ifconfig utunX` ã‚’è§£æã—ã¦è‡ªå‹•å–å¾—ã—ã¦ã„ã¾ã™ã€‚

:::warning
ã‚‚ã—ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒ 10.0.0.0/8 ä»¥å¤–ã®å ´åˆã¯ã€ã“ã®éƒ¨åˆ†ã‚’å¿…ãšä¿®æ­£ã—ã¦ãã ã•ã„ã€‚ä¾‹ãˆã°ã€ç¤¾å†…ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãŒ 172.16.0.0/12 ã®å ´åˆã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¯¾å¿œã•ã›ã¾ã™ï¼š

```bash
sudo route -n add -net 172.16.0.0/12 "$VPN_PEER"
```

:::

---

## 4. è¨­å®šãŒæœ‰åŠ¹ã‹ç¢ºèªã™ã‚‹

æœ€å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ç§ãŒå¼·åŒ–ã—ãŸéƒ¨åˆ†ã§ã™ã€‚

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€ã„ãã¤ã‹ã®ãƒ†ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’æŒ‡å®šã™ã‚‹ã¨ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯è‡ªå‹•çš„ã«ï¼š

1. å„ IP ã¾ãŸã¯ãƒ›ã‚¹ãƒˆåãŒå®Ÿéš›ã«ã©ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’é€šã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯
2. ãã®ãƒ›ã‚¹ãƒˆã«å¯¾ã—ã¦ ping ã‚’é€ã‚Šã€é€šä¿¡å¯èƒ½ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¾ã™

ä¾‹ãˆã°ï¼š

ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã€ãƒ†ã‚¹ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ã—ã¦ä»¥ä¸‹ã‚’æŒ‡å®šã—ã¾ã™ï¼š

```bash
bash forticlient_split.sh 10.1.1.1 192.168.0.100 google.com
```

ã™ã‚‹ã¨ã€æ¬¡ã®ã‚ˆã†ãªå‡ºåŠ›ãŒå¾—ã‚‰ã‚Œã¾ã™ï¼š

```
ğŸŒ 10.1.1.1      âœ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ utun4 (æœŸå¾…å€¤ utun4) âœ…  æ¥ç¶šæˆåŠŸ âœ…
ğŸŒ 192.168.0.100 âœ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ en0   (æœŸå¾…å€¤ ãƒ­ãƒ¼ã‚«ãƒ«) âœ…  æ¥ç¶šæˆåŠŸ âœ…
ğŸŒ google.com    âœ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ en0   (æœŸå¾…å€¤ ãƒ­ãƒ¼ã‚«ãƒ«) âœ…  æ¥ç¶šæˆåŠŸ âœ…
```

ã“ã‚Œã«ã‚ˆã‚Šã€ŒVPN ã¯ä¼šç¤¾ã®å†…éƒ¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ã¿ã‚’æ‹…å½“ã™ã‚‹ã€ã¨ã„ã†è¨­å®šãŒæ­£ã—ãæ©Ÿèƒ½ã—ã¦ã„ã‚‹ã‹ã€ç´ æ—©ãæ¤œè¨¼ã§ãã¾ã™ã€‚

æ¥ç¶šçŠ¶æ³ã‚„ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã€é€šä¿¡å¯å¦ãŒä¸€ç›®ã§ã‚ã‹ã‚‹ã®ã§ä¾¿åˆ©ã§ã™ï¼

ãªã‹ãªã‹è‰¯ã„æ„Ÿã˜ã§ã—ã‚‡ã†ï¼Ÿ

---

## å®Œå…¨ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

macOSã€FortiClient VPN å¯¾å¿œã€è‡ªå‹•æ¤œå‡ºã€ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ã€æ¥ç¶šãƒ†ã‚¹ãƒˆã€ãƒ«ãƒ¼ãƒˆè¡¨ç¤ºã€VPN ãƒ”ã‚¢ IP è§£æãªã©ã®æ©Ÿèƒ½ã‚’å‚™ãˆãŸå®Œå…¨ç‰ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä»¥ä¸‹ã«ã¾ã¨ã‚ã¾ã—ãŸã€‚

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ `forticlient_split.sh` ã¨ã„ã†åå‰ã§ä¿å­˜ã—ã€å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š

```bash
chmod +x forticlient_split.sh
./forticlient_split.sh 10.1.1.1 192.168.0.100 google.com
```

ä»¥ä¸‹ãŒã‚³ãƒ¼ãƒ‰ã«ãªã‚Šã¾ã™ã€‚ã”æ´»ç”¨ãã ã•ã„ã€‚

```bash title="forticlient_split.sh" showLineNumbers
#!/usr/bin/env bash
# =============================================================================
# FortiClient VPN åˆ†å‰²ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆè©³ç´°å‡ºåŠ›ä»˜ãï¼‰
#
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ FortiClient ã«ã‚ˆã£ã¦æŒ¿å…¥ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã€
# VPN ä»¥å¤–ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ç”¨ã«ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’å¾©å…ƒã—ã€
# 10.0.0.0/8 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ VPN ã«ãƒã‚¤ãƒ³ãƒ‰ã—ã€
# ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒãƒƒãƒ”ãƒ³ã‚°ã€æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆpingï¼‰ã‚’è©³ç´°ã«è¡¨ç¤ºã—ã¾ã™ã€‚
#
# ä½¿ã„æ–¹:
#   forticlient_split.sh [ -h | --help ] host1 [host2 ...]
#
# ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
#   -h, --help    ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†ã—ã¾ã™ã€‚
# =============================================================================

set -euo pipefail
IFS=$'\n\t'

# -----------------------------------------------------------------------------
# ã‚¨ãƒ©ãƒ¼ã¨æƒ…å ±è¡¨ç¤ºã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
# -----------------------------------------------------------------------------

# die ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹1ã§çµ‚äº†ã—ã¾ã™ã€‚
# å¼•æ•°:
#   $@: è¡¨ç¤ºã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
die() {
  printf 'âŒ %s\n' "$*" >&2
  exit 1
}

# info ã¯æƒ…å ±ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
# å¼•æ•°:
#   $@: è¡¨ç¤ºã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
info() {
  printf 'â„¹ï¸  %s\n' "$*"
}

# -----------------------------------------------------------------------------
# ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
# -----------------------------------------------------------------------------

# get_vpn_interface ã¯æœ€åˆã«è¦‹ã¤ã‹ã£ãŸ PtP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤ utun/tun/ppp ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åã‚’å‡ºåŠ›ã—ã¾ã™ã€‚
# æˆ»ã‚Šå€¤:
#   è¦‹ã¤ã‹ã£ãŸã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åã‚’å‡ºåŠ›ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºå‡ºåŠ›
get_vpn_interface() {
  while read -r iface; do
    iface=${iface%:}
    if ifconfig "$iface" | grep -q 'inet .*-->'; then
      printf '%s\n' "$iface"
      return
    fi
  done < <(ifconfig | awk '/^(utun|tun|ppp)[0-9]+:/{print $1}')
}

# get_vpn_peer ã¯æŒ‡å®šã•ã‚ŒãŸ VPN ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã® PtP å¯¾å‘ IP ã‚’å–å¾—ã—ã¾ã™ã€‚
# å¼•æ•°:
#   $1: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åï¼ˆä¾‹: utun4ï¼‰
# æˆ»ã‚Šå€¤:
#   å¯¾å‘ IP ã‚’å‡ºåŠ›ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºå‡ºåŠ›
get_vpn_peer() {
  local iface="$1"
  ifconfig "$iface" | awk '/inet / && /-->/ {
    for (i = 1; i <= NF; i++) {
      if ($i == "-->") { print $(i+1); exit }
    }
  }'
}

# get_local_gateway ã¯ VPN ä»¥å¤–ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’å–å¾—ã—ã¾ã™ã€‚
# æˆ»ã‚Šå€¤:
#   ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ IP ã‚’å‡ºåŠ›ã€è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ç©ºå‡ºåŠ›
get_local_gateway() {
  netstat -rn \
    | awk '$1=="default" && $NF !~ /(utun|tun|ppp)/ { print $2; exit }'
}

# iface_of ã¯æŒ‡å®šãƒ›ã‚¹ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã«ä½¿ã‚ã‚Œã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åã‚’è¿”ã—ã¾ã™ã€‚
# å¼•æ•°:
#   $1: ãƒ›ã‚¹ãƒˆåã¾ãŸã¯IP
# æˆ»ã‚Šå€¤:
#   ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹åã‚’å‡ºåŠ›
iface_of() {
  route get "$1" 2>/dev/null \
    | awk '/interface:/{print $2}'
}

# show_route_info ã¯ç¾åœ¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã¨10.0.0.0/8ã®ãƒ«ãƒ¼ãƒˆæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
show_route_info() {
  printf '\nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n'
  info "ğŸ” ç¾åœ¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆ:"
  route get default 2>/dev/null | awk 'NR<=5'
  info "ğŸ” ç¾åœ¨ã® 10.0.0.0/8 ãƒ«ãƒ¼ãƒˆ:"
  route get 10.0.0.1 2>/dev/null | awk 'NR<=5'
  printf 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n'
}

# test_connect ã¯æŒ‡å®šãƒ›ã‚¹ãƒˆã¸ã®pingç–é€šç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚
# å¼•æ•°:
#   $1: ãƒ›ã‚¹ãƒˆåã¾ãŸã¯IP
test_connect() {
  local host="$1"
  printf '   â†³ %s ã¸ã®ç–é€šãƒ†ã‚¹ãƒˆ: ' "$host"
  if ping -c2 -W1 "$host" &>/dev/null; then
    printf 'âœ… åˆ°é”å¯èƒ½\n'
  else
    printf 'âŒ åˆ°é”ä¸å¯\n'
  fi
}

# -----------------------------------------------------------------------------
# ä½¿ç”¨æ–¹æ³•è¡¨ç¤º
# -----------------------------------------------------------------------------

usage() {
  cat <<-EOF
ä½¿ã„æ–¹: $(basename "$0") [ -h | --help ] host1 [host2 ...]
ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  -h, --help    ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã¦çµ‚äº†ã—ã¾ã™ã€‚
EOF
  exit 0
}

# -----------------------------------------------------------------------------
# ãƒ¡ã‚¤ãƒ³å‡¦ç†
# -----------------------------------------------------------------------------

# ãƒ•ãƒ©ã‚°è§£æ
if [[ "${1-}" =~ ^-h|--help$ ]]; then
  usage
fi

# ãƒ›ã‚¹ãƒˆåé›†
HOSTS=("$@")
(( ${#HOSTS[@]} )) || die "å°‘ãªãã¨ã‚‚ä¸€ã¤ã®ãƒ›ã‚¹ãƒˆã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚"

# 1. VPNã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã®æ¤œå‡º
info "ğŸ” VPNã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’æ¤œå‡ºä¸­"
VPN_IF=$(get_vpn_interface)                         || die "VPNã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼ˆutun/tun/pppï¼‰ã‚’æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
VPN_PEER=$(get_vpn_peer "$VPN_IF")                  || die "VPNã®PtPå¯¾å‘IPã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
LOCAL_GW=$(get_local_gateway)                       || die "ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
info "   â€¢ VPNã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ï¼š$VPN_IF"
info "   â€¢ VPNãƒ”ã‚¢IPï¼š$VPN_PEER"
info "   â€¢ ãƒ­ãƒ¼ã‚«ãƒ«ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ï¼š$LOCAL_GW"

# å¤‰æ›´å‰ã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
show_route_info

# 2. FortiClient ã«ã‚ˆã£ã¦å¼·åˆ¶è¿½åŠ ã•ã‚ŒãŸãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤
info "ğŸ§¹ FortiClientãŒæŒ¿å…¥ã—ãŸå¼·åˆ¶ãƒ«ãƒ¼ãƒˆã‚’å‰Šé™¤ä¸­"
for cidr in default 0.0.0.0/1 128.0.0.0/1; do
  sudo route -q -n delete -ifscope "$VPN_IF" "$cidr" 2>/dev/null || true
done

# 3. ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã‚’å¾©å…ƒ
info "ğŸš§ ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã‚’ $LOCAL_GW ã«è¨­å®šä¸­"
if ! sudo route -n change default "$LOCAL_GW" 2>/dev/null; then
  sudo route -n add default "$LOCAL_GW"
fi

# 4. 10.0.0.0/8 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’VPNã«ãƒã‚¤ãƒ³ãƒ‰
info "ğŸ”— 10.0.0.0/8 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ $VPN_PEER ($VPN_IF) ã«ãƒã‚¤ãƒ³ãƒ‰"
if ! sudo route -n add -net 10.0.0.0/8 "$VPN_PEER" 2>/dev/null; then
  sudo route -n change -net 10.0.0.0/8 "$VPN_PEER"
fi

# å¤‰æ›´å¾Œã®ãƒ«ãƒ¼ãƒˆã‚’è¡¨ç¤º
show_route_info

# 5. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨æ¥ç¶šæ€§ã®ãƒ†ã‚¹ãƒˆ
info "ğŸŒ ãƒ«ãƒ¼ãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã¨æ¥ç¶šæ€§ã‚’ãƒ†ã‚¹ãƒˆä¸­"
for host in "${HOSTS[@]}"; do
  actual_if=$(iface_of "$host" || echo "ä¸æ˜")
  if [[ $host == 10.* ]]; then
    expected_if="$VPN_IF"
  else
    expected_if="ãƒ­ãƒ¼ã‚«ãƒ«ï¼ˆéVPNï¼‰"
  fi
  printf '   â€¢ %-15s âœ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ %-8s (æœŸå¾…å€¤ %s)\n' \
    "$host" "$actual_if" "$expected_if"
  test_connect "$host"
done

info "ğŸ‰ è¨­å®šã€ãƒ«ãƒ¼ãƒˆã€æ¥ç¶šæ€§ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ"
```
