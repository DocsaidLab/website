<!doctype html><html lang=ja dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-nginx-notes/monitoring" data-has-hydrated=false><meta charset=UTF-8><meta name=generator content="Docusaurus v3.7.0"><title data-rh=true>Nginx ログと監視 | DOCSAID</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"><meta data-rh=true name=twitter:card content=summary_large_image><meta data-rh=true property=og:image content=https://docsaid.org/ja/img/docsaid-social-card.jpg><meta data-rh=true name=twitter:image content=https://docsaid.org/ja/img/docsaid-social-card.jpg><meta data-rh=true property=og:url content=https://docsaid.org/ja/docs/nginx-notes/monitoring><meta data-rh=true property=og:locale content=ja><meta data-rh=true property=og:locale:alternate content=zh_hant><meta data-rh=true property=og:locale:alternate content=en><meta data-rh=true name=docusaurus_locale content=ja><meta data-rh=true name=docsearch:language content=ja><meta data-rh=true name=docusaurus_version content=current><meta data-rh=true name=docusaurus_tag content=docs-default-current><meta data-rh=true name=docsearch:version content=current><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current><meta data-rh=true property=og:title content="Nginx ログと監視 | DOCSAID"><meta data-rh=true name=description content="API を外部に公開した後、私たちはすぐに四方八方からの悪意のあるリクエストを受け取ることになります。"><meta data-rh=true property=og:description content="API を外部に公開した後、私たちはすぐに四方八方からの悪意のあるリクエストを受け取ることになります。"><link data-rh=true rel=icon href=/ja/img/favicon.ico><link data-rh=true rel=canonical href=https://docsaid.org/ja/docs/nginx-notes/monitoring><link data-rh=true rel=alternate href=https://docsaid.org/docs/nginx-notes/monitoring hreflang=zh-hant><link data-rh=true rel=alternate href=https://docsaid.org/en/docs/nginx-notes/monitoring hreflang=en><link data-rh=true rel=alternate href=https://docsaid.org/ja/docs/nginx-notes/monitoring hreflang=ja><link data-rh=true rel=alternate href=https://docsaid.org/docs/nginx-notes/monitoring hreflang=x-default><link data-rh=true rel=preconnect href=https://S9NC0RYCHF-dsn.algolia.net crossorigin=anonymous><link rel=alternate type=application/rss+xml href=/ja/blog/rss.xml title="DOCSAID RSS Feed"><link rel=alternate type=application/atom+xml href=/ja/blog/atom.xml title="DOCSAID Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-RDF83L9R4M"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-RDF83L9R4M",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=DOCSAID href=/ja/opensearch.xml><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css type=text/css integrity=sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM crossorigin=anonymous><link rel=stylesheet href=/ja/assets/css/styles.28beeaa6.css><script src=/ja/assets/js/runtime~main.aad01731.js defer></script><script src=/ja/assets/js/main.0ba60a26.js defer></script><body class=navigation-with-keyboard><script>!function(){var t,e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t=null!==e?e:"light",document.documentElement.setAttribute("data-theme",t)}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><link rel=preload as=image href=/ja/img/docsaid_logo.png><link rel=preload as=image href=/ja/img/docsaid_logo_white.png><div role=region aria-label=メインコンテンツまでスキップ><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>メインコンテンツまでスキップ</a></div><nav aria-label=ナビゲーション class="navbar navbar--fixed-top navbarHideable_jvwV"><div class=navbar__inner><div class=navbar__items><button aria-label=ナビゲーションバーを開く aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/ja/><div class=navbar__logo><img src=/ja/img/docsaid_logo.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/ja/img/docsaid_logo_white.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/ja/docs/>オープンソースプロジェクト</a><a class="navbar__item navbar__link" href=/ja/papers/intro>論文ノート</a><a class="navbar__item navbar__link" href=/ja/blog>ブログ</a><a class="navbar__item navbar__link" href=/ja/playground/intro>遊び場</a><a class="navbar__item navbar__link" href=/ja/services>技術サービス</a><a class="navbar__item navbar__link" href=/ja/aboutus>私たちについて</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link><svg viewBox="0 0 24 24" width=20 height=20 aria-hidden=true class=iconLanguage_nlXk><path fill=currentColor d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"/></svg>日本語</a><ul class=dropdown__menu><li><a href=/docs/nginx-notes/monitoring target=_self rel="noopener noreferrer" class=dropdown__link lang=zh-hant>繁體中文</a><li><a href=/en/docs/nginx-notes/monitoring target=_self rel="noopener noreferrer" class=dropdown__link lang=en>English</a><li><a href=/ja/docs/nginx-notes/monitoring target=_self rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang=ja>日本語</a></ul></div><div class=navbarSearchContainer_dCNk><button type=button class="DocSearch DocSearch-Button" aria-label="検索 (Command+K)"><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 20 20" aria-hidden=true><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke=currentColor fill=none fill-rule=evenodd stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>検索</span></span><span class=DocSearch-Button-Keys></span></button></div><button type=button class="ant-btn css-7ny38l ant-btn-circle ant-btn-default ant-btn-color-default ant-btn-variant-outlined ant-btn-icon-only"><span class=ant-btn-icon><span role=img aria-label=user style=font-size:18px class="anticon anticon-user"><svg viewBox="64 64 896 896" focusable=false data-icon=user width=1em height=1em fill=currentColor aria-hidden=true><path d="M858.5 763.6a374 374 0 00-80.6-119.5 375.63 375.63 0 00-119.5-80.6c-.4-.2-.8-.3-1.2-.5C719.5 518 760 444.7 760 362c0-137-111-248-248-248S264 225 264 362c0 82.7 40.5 156 102.8 201.1-.4.2-.8.3-1.2.5-44.8 18.9-85 46-119.5 80.6a375.63 375.63 0 00-80.6 119.5A371.7 371.7 0 00136 901.8a8 8 0 008 8.2h60c4.4 0 7.9-3.5 8-7.8 2-77.2 33-149.5 87.8-204.3 56.7-56.7 132-87.9 212.2-87.9s155.5 31.2 212.2 87.9C779 752.7 810 825 812 902.2c.1 4.4 3.6 7.8 8 7.8h60a8 8 0 008-8.2c-1-47.8-10.9-94.3-29.5-138.2zM512 534c-45.9 0-89.1-17.9-121.6-50.4S340 407.9 340 362c0-45.9 17.9-89.1 50.4-121.6S466.1 190 512 190s89.1 17.9 121.6 50.4S684 316.1 684 362c0 45.9-17.9 89.1-50.4 121.6S557.9 534 512 534z"/></svg></span></span></button></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="main-wrapper mainWrapper_eExm"><div class=docsWrapper_hBAB><button aria-label=先頭へ戻る class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex=-1 class=sidebarLogo_isFc href=/ja/><img src=/ja/img/docsaid_logo.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src=/ja/img/docsaid_logo_white.png alt="Docsaid Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"><b></b></a><nav aria-label=ドキュメントのサイドバー class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/ja/docs/>オープンソースプロジェクト</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/model-training-guide/>モデル訓練ガイド</a><button aria-label="'モデル訓練ガイド'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/autotraderx/>AutoTraderX</a><button aria-label="'AutoTraderX'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/capybara/>Capybara</a><button aria-label="'Capybara'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/docaligner/>DocAligner</a><button aria-label="'DocAligner'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/docclassifier/>DocClassifier</a><button aria-label="'DocClassifier'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/gmailsummary/>GmailSummary</a><button aria-label="'GmailSummary'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/mrzscanner/>MRZScanner</a><button aria-label="'MRZScanner'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist menu__link--active" href=/ja/docs/nginx-notes/>Nginx Notes</a><button aria-label="'Nginx Notes'の目次を隠す" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul style=display:block;overflow:visible;height:auto class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ja/docs/nginx-notes/intro>Nginx の紹介</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ja/docs/nginx-notes/install-and-settings>Nginx のインストールと設定</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ja/docs/nginx-notes/https-settings>Nginx HTTPS の設定</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ja/docs/nginx-notes/security>Nginx のセキュリティ強化</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/ja/docs/nginx-notes/monitoring>Nginx ログと監視</a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/ja/docs/nginx-notes/static-file-server>Nginx による静的リソースの提供</a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" tabindex=0 href=/ja/docs/category/補充資料>ほそくしりょう</a><button aria-label="'ほそくしりょう'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="menu__link menu__link--sublist" href=/ja/docs/wordcanvas/>WordCanvas</a><button aria-label="'WordCanvas'の目次を開く" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul></nav><button type=button title=サイドバーを隠す aria-label=サイドバーを隠す class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width=20 height=20 aria-hidden=true class=collapseSidebarButtonIcon_kv0_><g fill=#7a7a7a><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"/><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"/></g></svg></button></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label=パンくずリストのナビゲーション><ul class=breadcrumbs itemscope itemtype=https://schema.org/BreadcrumbList><li class=breadcrumbs__item><a aria-label=ホームページ class=breadcrumbs__link href=/ja/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_YNFT><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class=breadcrumbs__item><a class=breadcrumbs__link itemprop=item href=/ja/docs/nginx-notes/><span itemprop=name>Nginx Notes</span></a><meta itemprop=position content=1><li itemscope itemprop=itemListElement itemtype=https://schema.org/ListItem class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link itemprop=name>Nginx ログと監視</span><meta itemprop=position content=2></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>Nginx ログと監視</h1></header>
<p>API を外部に公開した後、私たちはすぐに四方八方からの悪意のあるリクエストを受け取ることになります。</p>
<p>ログ記録を確認したことがあれば、さまざまな IP が異なるユーザー名とパスワードでサーバーへのログインを試みているのを簡単に見つけることができるでしょう。これは一般的なブルートフォース攻撃であり、攻撃者は自動化ツールを使ってログインを繰り返し、正しいパスワードを見つけるまで試行を続けます。</p>
<p>パスワードの複雑さを限界まで高めることはできますが、常にそれを気にするのも一つの手ではありません。</p>
<p>そこで、Fail2ban というツールを使い、これらの IP をすべてブロックします。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=fail2ban-とは>Fail2ban とは？<a href=#fail2ban-とは class=hash-link aria-label="Fail2ban とは？ への直接リンク" title="Fail2ban とは？ への直接リンク">​</a></h2>
<p>Fail2ban は、サーバーログを監視し、規則に基づいて悪意のある IP をブロックするオープンソースの侵入防止ツールです。SSH、HTTP、その他のネットワークサービスに対するブルートフォース攻撃を防ぐのに効果的です。</p>
<p>Fail2ban の動作の基本は、「フィルター（filters）」と「ジャイル（jails）」の二つの概念に基づいています：</p>
<ul>
<li><strong>フィルター</strong>：ログ内で疑わしい行動パターンを検出するために定義されたもの</li>
<li><strong>ジャイル</strong>：フィルターとブロックメカニズムを組み合わせ、異常な動作を検出すると自動的に対応を実行します。</li>
</ul>
<p>Nginx の適用シーンでは、Fail2ban は Nginx のアクセスログ（access log）やエラーログ（error log）を監視し、疑わしいリクエストを識別します。例えば：</p>
<ul>
<li><strong>頻繁な 404 エラー</strong>（潜在的なスキャン攻撃）</li>
<li><strong>連続するログイン失敗</strong>（ブルートフォース攻撃）</li>
<li><strong>短時間での高頻度リクエスト</strong>（DDoS 攻撃や悪意のあるクローラー）</li>
</ul>
<p>異常が検出されると、Fail2ban は設定に基づいて、iptables や nftables を通じて自動的に送信元 IP をブロックし、Nginx サーバーへの攻撃を防ぎます。</p>
<p>Ubuntu 環境では、Nginx のログはデフォルトで以下のパスに保存されます：</p>
<ul>
<li><strong>アクセスログ</strong>：<code>/var/log/nginx/access.log</code></li>
<li><strong>エラーログ</strong>：<code>/var/log/nginx/error.log</code></li>
</ul>
<p>Fail2ban はこれらのログを監視し、デフォルトまたはカスタムのフィルター規則テンプレートに基づいてログ内容を照合します。ログが悪意のある行動パターンに一致すると、Fail2ban は関連する IP をブロックリストに追加します。</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 14 16"><path fill-rule=evenodd d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"/></svg></span>備考</div><div class=admonitionContent_BuS1><p>規則テンプレートは通常、<code>/etc/fail2ban/filter.d/</code>にあります。</div></div>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>ヒント</div><div class=admonitionContent_BuS1><p>Nginx を保護するだけでなく、Fail2ban は SSH、FTP、メールサーバーなど、さまざまなサービスにも適用でき、広範囲なサーバーセキュリティ保護機能を提供します。このガイドは主に Nginx 関連の防御設定に焦点を当てています。</div></div>
<h1>Fail2ban 基本設定</h1>
<p>Ubuntu では、Fail2ban は APT パッケージマネージャを使って直接インストールできます。これは公式のソフトウェアリポジトリに含まれているため、以下の手順でインストールと起動を行います：</p>
<ol>
<li>
<p><strong>システムパッケージリストを更新</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo apt update</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong>Fail2ban のインストール</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo apt install -y fail2ban</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、Fail2ban とその依存パッケージが自動的にダウンロードされ、インストールされます。インストールが完了すると、Fail2ban は自動的に起動し、システム起動時に自動実行されるように設定されます。</p>
</li>
<li>
<p><strong>Fail2ban サービスの状態確認</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo systemctl status fail2ban</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>インストールが成功すれば、<code>active (running)</code> と表示され、Fail2ban が正常に動作していることが確認できます。</p>
</li>
<li>
<p><strong>Fail2ban のバージョンと状態の確認</strong>：</p>
<ul>
<li>
<p>現在インストールされている Fail2ban のバージョンを表示：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">fail2ban-client --version</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p>現在有効になっているジャイル（監獄）の確認：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>デフォルトでは、Fail2ban は SSH の保護機能のみが有効になっており、Nginx 関連の防御には追加設定が必要です。</p>
</li>
</ul>
</li>
</ol>
<hr>
<p>Fail2ban の主な設定ファイルは <code>/etc/fail2ban/jail.conf</code> ですが、公式では「このファイルを直接編集しないように」と推奨されています。これはソフトウェアの更新時に設定が上書きされるのを防ぐためです。</p>
<p>そのため、ローカル設定ファイル <code>jail.local</code> を作成し、デフォルトの値を上書きします。</p>
<ol>
<li>
<p><strong><code>jail.conf</code> を <code>jail.local</code> にコピー</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
<li>
<p><strong><code>jail.local</code> の編集</strong>：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/jail.local</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
</li>
</ol>
<p><code>[DEFAULT]</code> セクションを探し、いくつかの重要なパラメータを設定します。これには、無視する IP、ブロック時間、観察時間、最大再試行回数などの設定が含まれます：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[DEFAULT]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreip = 127.0.0.1/8 ::1    # 信頼するIPアドレスを設定。これらのIPはブロックされません</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 1h                 # デフォルトのブロック時間。秒数または時間単位（例：1h、10m）で設定できます</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 10m                # この時間内に…</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 5                  # 最大5回の失敗でIPがブロックされます</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これらの設定の意味は次の通りです：</p>
<ul>
<li><strong>ignoreip</strong>：ブロックしない IP を指定します。例えば、ローカルホスト（<code>127.0.0.1</code>）や管理用 IP など。</li>
<li><strong>bantime</strong>：ブロックする時間の長さ。デフォルトでは 1 時間（<code>1h</code>）に設定されています。この時間内にその IP はアクセスできなくなります。</li>
<li><strong>findtime</strong>：失敗行動を観察する時間範囲。例えば、<code>10m</code>を設定すると、10 分間の間に発生した失敗行為がカウントされます。</li>
<li><strong>maxretry</strong>：最大再試行回数。例えば、<code>5</code>を設定すると、同一の IP が<code>findtime</code>内に 5 回失敗した場合、その IP がブロックされます。</li>
</ul>
<p>これらのパラメータはグローバル設定であり、すべてのジャイルに適用されます。後ほど、Nginx 専用のブロックポリシーを設定し、悪意のある攻撃をより効果的にブロックする必要があります。</p>
<p>設定を完了したら、Fail2ban を再起動して新しい設定を適用します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo systemctl restart fail2ban</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これで、Fail2ban の基本的なインストールとグローバル設定が完了しました。</p>
<p>次に、Fail2ban をさらに設定して、Nginx のログを監視し、悪意のあるリクエストを防止する方法を紹介します。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=一般的な攻撃タイプの監視>一般的な攻撃タイプの監視<a href=#一般的な攻撃タイプの監視 class=hash-link aria-label="一般的な攻撃タイプの監視 への直接リンク" title="一般的な攻撃タイプの監視 への直接リンク">​</a></h2>
<p>ここでは、いくつかの一般的な Nginx 攻撃タイプに対して、Fail2ban を使用して監視と自動ブロックを設定します。各攻撃行動は通常、Nginx のログに明確な特徴がありますので、まずは「フィルタ規則」を定義して検出し、対応するブロック戦略を適用します。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=悪意のあるクローラーの防止>悪意のあるクローラーの防止<a href=#悪意のあるクローラーの防止 class=hash-link aria-label="悪意のあるクローラーの防止 への直接リンク" title="悪意のあるクローラーの防止 への直接リンク">​</a></h3>
<p>多くの悪意のあるクローラーや攻撃ツールは、特定の User-Agent を使用します。例えば：</p>
<ul>
<li><code>Java</code></li>
<li><code>Python-urllib</code></li>
<li><code>Curl</code></li>
<li><code>sqlmap</code></li>
<li><code>Wget</code></li>
<li><code>360Spider</code></li>
<li><code>MJ12bot</code></li>
</ul>
<p>これらの User-Agent はほとんどが自動化ツールによるもので、通常のユーザーには属しません。そのため、これらの User-Agent に対してリアルタイムでブロックを行うことができます。</p>
<p>まず、<code>/etc/fail2ban/filter.d/</code>ディレクトリ内に新しいフィルタファイルを作成します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-badbots.conf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下の内容を入力します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(GET|POST).*HTTP.*" .* "(?:Java|Python-urllib|Curl|sqlmap|Wget|360Spider|MJ12bot)"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex は悪意のあるリクエストを検出するための正規表現です</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> はIPアドレスを表し、Fail2Banがこのプレースホルダーを解釈します</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(GET|POST).*HTTP.*" はHTTP GETまたはPOSTリクエストに限定</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - .* はリクエスト内容をマッチさせるために使用</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(?:Java|Python-urllib|Curl|sqlmap|Wget|360Spider|MJ12bot)"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - これらは一般的なクローラー、スキャナー、攻撃ツール：</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Java: Javaベースのクローラーから来ることが多い</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Python-urllib: Pythonの標準URLリクエストライブラリ</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Curl: コマンドラインHTTPリクエストツール</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - sqlmap: 自動SQLインジェクションツール</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - Wget: ダウンロードツール、サイトクローリングにも使用</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - 360Spider: 360検索エンジンのクローラー</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#     - MJ12bot: Majestic SEOクローラー</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex は特定のリクエストを除外するための正規表現</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - ここでは何も除外しないため空白にしています</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>次に、<code>jail.local</code>ファイルで Jail を設定します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-badbots]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-badbots</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これで、これらの User-Agent を使用したリクエストは、24 時間の間に即座にブロックされます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=404-スキャン攻撃の防止>404 スキャン攻撃の防止<a href=#404-スキャン攻撃の防止 class=hash-link aria-label="404 スキャン攻撃の防止 への直接リンク" title="404 スキャン攻撃の防止 への直接リンク">​</a></h3>
<p>この攻撃手法は存在しないページをブルートフォースで探し、短期間で大量のリクエストを行います。</p>
<p>攻撃者はスクリプトを使って存在しないページを繰り返しアクセスし、脆弱性や敏感なファイルを発見しようとすることがあり、その結果大量の HTTP 404 エラーが発生します。</p>
<p>新しいフィルターファイルを作成します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-404.conf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下の内容を入力します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(GET|POST).*HTTP.*" 404</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex は特定のログパターンにマッチさせるための正規表現です</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> はIPアドレス（Fail2Banはこのプレースホルダーを実際の送信元IPに置き換えます）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(GET|POST).*HTTP.*"：</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - GETまたはPOSTリクエストに限定</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - .* はURLやHTTPプロトコルバージョン（例：HTTP/1.1）をマッチさせます</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "404" はHTTPステータスコード404（リソースが見つからない）にマッチ</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># このルールは、404エラーを頻繁にトリガーするIPをブロックします。</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># 例えば、存在しないページをスキャンしている悪意のあるクローラーや攻撃者に対して効果的です</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>次に、<code>jail.local</code>ファイルに Jail を設定します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-404]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-404</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 10m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、10 分以内に 5 回の 404 エラーをトリガーした IP が 24 時間ブロックされます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=ddos-攻撃の防止>DDoS 攻撃の防止<a href=#ddos-攻撃の防止 class=hash-link aria-label="DDoS 攻撃の防止 への直接リンク" title="DDoS 攻撃の防止 への直接リンク">​</a></h3>
<p>短期間で大量のリクエストを送信する IP は、DDoS 攻撃や悪意のあるクローリングの可能性があります。</p>
<p>新しいフィルターファイルを作成します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-limitreq.conf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下の内容を入力します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = limiting requests, excess: .* by zone .* client: &lt;HOST></span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex はNginxのログでリクエスト制限（レートリミット）のイベントを検出するための正規表現です</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "limiting requests, excess: .* by zone .* client: &lt;HOST>"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "limiting requests, excess:" は設定された制限（例：Nginxのlimit_req_zone制限）を超えたリクエストを示します</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - .* は任意のデータ（リクエスト数や超過の詳細）を許容します</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "by zone .*" はNginx設定で指定されたリミットゾーン（zone）を表します</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "client: &lt;HOST>" は実際のクライアントIPアドレスに置き換わります</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>この <code>failregex</code> は、Nginx で設定されたリクエスト制限（<code>limit_req_zone</code>）にトリガーされるログを検出するために使用されます。例えば、次のようなログが記録されます：</p>
<div class="language-log codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-log codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">2024/02/15 12:34:56 [error] 1234#5678: *90123 limiting requests, excess: 20.000 by zone "api_limit" client: 192.168.1.100, server: example.com, request: "GET /api/v1/data HTTP/1.1"</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>対応する Nginx 設定は次のようになります：</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">server {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    location /api/ {</span><br></span><span class=token-line style=color:#393A34><span class="token plain">        limit_req zone=api_limit burst=20 nodelay;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    }</span><br></span><span class=token-line style=color:#393A34><span class="token plain">}</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>このように、IP が短時間で多くのリクエストを送信した場合、Nginx はログに「<code>limiting requests, excess: ... client: &lt;IP></code>」と記録し、Fail2Ban はこの <code>failregex</code> に基づいてその IP をブロックします。</p>
<p>次に、<code>jail.local</code>ファイルに Jail を設定します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-limitreq]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-limitreq</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/error.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 10m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、10 分以内に 10 回以上 Nginx のレート制限をトリガーした IP が 24 時間ブロックされます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=ブルートフォースログインの防止>ブルートフォースログインの防止<a href=#ブルートフォースログインの防止 class=hash-link aria-label="ブルートフォースログインの防止 への直接リンク" title="ブルートフォースログインの防止 への直接リンク">​</a></h3>
<p>ウェブサイトにログイン機能がある場合、攻撃者はブルートフォース攻撃を試みる可能性があります。</p>
<p>新しいフィルターファイルを作成します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-login.conf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下の内容を入力します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(POST|GET) /(admin|wp-login.php) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex は悪意のあるリクエストをマッチさせ、管理者ページのログイン試行をターゲットにします</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> はIPアドレス（Fail2Banがこれを実際の送信元IPに置き換えます）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(POST|GET) /(admin|wp-login.php) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "(POST|GET)" はHTTPメソッド（攻撃者がGETまたはPOSTでログインを試みる可能性があります）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/admin" は多くのウェブサイトで使用される管理ページの一般的なパスです</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/wp-login.php" はWordPressのログインページ</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "HTTP.*" は異なるHTTPバージョン（例：HTTP/1.1、HTTP/2）にマッチします</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex は特定のリクエストを除外するためのパターンです</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - ここでは何も除外しないため、空白にしています</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、WordPress や一般的なウェブサイトの管理者ページへのログイン試行を検出できます。</p>
<p>次に、<code>jail.local</code>ファイルに Jail を設定します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-login]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-login</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 5m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 5</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、5 分間に 5 回以上ログイン失敗をした IP が 24 時間ブロックされます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=敏感情報へのアクセス試行の防止>敏感情報へのアクセス試行の防止<a href=#敏感情報へのアクセス試行の防止 class=hash-link aria-label="敏感情報へのアクセス試行の防止 への直接リンク" title="敏感情報へのアクセス試行の防止 への直接リンク">​</a></h3>
<p>悪意のある攻撃者は、<code>/etc/passwd</code>、<code>/.git</code>、<code>/.env</code>などの敏感なパスにアクセスしようとする可能性があります。</p>
<p>新しいフィルターファイルを作成します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-sensitive.conf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下の内容を入力します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(GET|POST) /(etc/passwd|\.git|\.env) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex は敏感なファイルにアクセスしようとする悪意のあるリクエストをマッチさせます</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> はIPアドレス（Fail2Banがこれを実際の送信元IPに置き換えます）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(GET|POST) /(etc/passwd|\.git|\.env) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "(GET|POST)" はHTTPメソッド（攻撃者はGETまたはPOSTでファイルを探す可能性があります）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/etc/passwd" はLinuxシステムのパスワードファイルで、攻撃者が読み取ろうとする可能性があります</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/.git" はGitのリポジトリディレクトリで、攻撃者がソースコードや機密情報を探してダウンロードする可能性があります</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/.env" は環境変数ファイルで、データベースのパスワードやAPIキーなどを含む場合があります</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "HTTP.*" は異なるHTTPバージョン（例：HTTP/1.1、HTTP/2）にマッチします</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex は特定のリクエストを除外するためのパターンです</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - ここでは何も除外しないため、空白にしています</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>このルールは、ディレクトリトラバーサル攻撃、Git ディレクトリの保護、<code>.env</code>ファイルの探索防止、そして Web スキャナーによるスキャン防止に役立ちます。</p>
<p>次に、<code>jail.local</code>ファイルに Jail を設定します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-sensitive]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-sensitive</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、これらの敏感なファイルにアクセスしようとした IP は、即座に 24 時間ブロックされます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=api-攻撃への対応>API 攻撃への対応<a href=#api-攻撃への対応 class=hash-link aria-label="API 攻撃への対応 への直接リンク" title="API 攻撃への対応 への直接リンク">​</a></h3>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg viewBox="0 0 12 16"><path fill-rule=evenodd d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"/></svg></span>ヒント</div><div class=admonitionContent_BuS1><p>API のエンドポイントに合わせてフィルタを調整することを忘れないでください。</div></div>
<p>API エンドポイント（例：<code>/api/login</code>、<code>/api/register</code>）に対するブルートフォース攻撃には、リクエスト頻度を制限する必要があります。</p>
<p>新しいフィルターファイルを作成します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo vim /etc/fail2ban/filter.d/nginx-api.conf</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>以下の内容を入力します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[Definition]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">failregex = &lt;HOST> -.* "(POST) /api/(login|register) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">ignoreregex =</span><br></span><span class=token-line style=color:#393A34><span class="token plain" style=display:inline-block></span><br></span><span class=token-line style=color:#393A34><span class="token plain"># failregex はAPIのログインや登録に対する悪意のあるリクエストをマッチさせます</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - &lt;HOST> はIPアドレス（Fail2Banがこれを実際の送信元IPに置き換えます）</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - "(POST) /api/(login|register) HTTP.*"</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "(POST)" はHTTP POSTメソッドに限定（ブルートフォース攻撃を防ぐ）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/api/login" はログインAPIで、ブルートフォース攻撃の対象になる可能性があります</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "/api/register" は登録APIで、攻撃者が自動化されたアカウント登録を試みる場合があります</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#   - "HTTP.*" はHTTPバージョンにマッチ（例：HTTP/1.1、HTTP/2）</span><br></span><span class=token-line style=color:#393A34><span class="token plain">#</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># ignoreregex は特定のリクエストを除外するためのパターンです</span><br></span><span class=token-line style=color:#393A34><span class="token plain"># - ここでは何も除外しないため、空白にしています</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>このルールは、ブルートフォースログイン、自動化されたアカウント登録攻撃を防ぎ、API のセキュリティを向上させます。</p>
<p>次に、<code>jail.local</code>ファイルに Jail を設定します：</p>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">[nginx-api]</span><br></span><span class=token-line style=color:#393A34><span class="token plain">enabled  = true</span><br></span><span class=token-line style=color:#393A34><span class="token plain">port     = http,https</span><br></span><span class=token-line style=color:#393A34><span class="token plain">filter   = nginx-api</span><br></span><span class=token-line style=color:#393A34><span class="token plain">logpath  = /var/log/nginx/access.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">findtime = 1m</span><br></span><span class=token-line style=color:#393A34><span class="token plain">maxretry = 10</span><br></span><span class=token-line style=color:#393A34><span class="token plain">bantime  = 86400</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、1 分以内に 10 回以上ログイン試行を行った IP が 24 時間ブロックされます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=新規ルールの適用>新規ルールの適用<a href=#新規ルールの適用 class=hash-link aria-label="新規ルールの適用 への直接リンク" title="新規ルールの適用 への直接リンク">​</a></h3>
<p>設定が完了したら、Fail2ban を再起動します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo systemctl restart fail2ban</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>そして、Jail の状態を確認します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>特定の Jail の状態を確認したい場合は、次のコマンドを使用します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status nginx-404  # 自分のJail名に置き換えてください</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これで、Nginx に対する一般的な攻撃タイプに対して Fail2ban を設定し、サイトのセキュリティを強化しました。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=防御効果のテスト>防御効果のテスト<a href=#防御効果のテスト class=hash-link aria-label="防御効果のテスト への直接リンク" title="防御効果のテスト への直接リンク">​</a></h2>
<p>Fail2ban による Nginx の防御設定が完了した後、効果を簡単にテストできます。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=curl-を使った攻撃のシミュレーション><code>curl</code> を使った攻撃のシミュレーション<a href=#curl-を使った攻撃のシミュレーション class=hash-link aria-label="curl-を使った攻撃のシミュレーション への直接リンク" title="curl-を使った攻撃のシミュレーション への直接リンク">​</a></h3>
<p><code>curl</code>を使用して悪意のあるリクエストを送信し、Fail2ban のブロック機能をトリガーできます。</p>
<p>テスト時には、<code>localhost</code>からリクエストを送らないでください。<code>127.0.0.1</code>は<code>ignoreip</code>に設定されている場合があり、Fail2ban がブロックしないからです。他のネットワーク環境のコンピュータやサーバーを使用するか、一時的に<code>ignoreip</code>設定を空にしてください。</p>
<ul>
<li>
<p><strong>1. 404 スキャンのブロックテスト</strong></p>
<p>存在しないページをランダムにスキャンして攻撃者をシミュレートします：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">for i in $(seq 1 6); do</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    curl -I http://&lt;あなたのサーバーIPまたはドメイン>/nonexistentpage_$i ;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">done</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、6 つの存在しないページに対して連続リクエストが送信され、HTTP 404 エラーが発生します。もし設定が「5 回の 404 エラーでブロック」となっている場合、Fail2ban は 5 回目または 6 回目のリクエスト時に IP をブロックします。
ブロック後、再度<code>curl</code>でリクエストを送ると、接続失敗（タイムアウトや接続拒否）を確認できるはずです。</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>2. 敏感な URL のブロックテスト</strong></p>
<p>攻撃者がシステムの敏感なファイル、例えば<code>/etc/passwd</code>にアクセスしようとすることがあります：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">curl -I http://&lt;あなたのサーバー>/etc/passwd</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>nginx-sensitive</code>フィルターが正しく設定されていれば、このリクエストは Fail2ban によって検出され、IP は即座にブロックされるはずです（<code>maxretry = 1</code>の場合）。</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>3. User-Agent のブロックテスト</strong></p>
<p><code>sqlmap</code>のような悪意のあるクローラーをシミュレートします：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">curl -A "sqlmap/1.5.2#stable" http://&lt;あなたのサーバー>/</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>もし<code>sqlmap</code>が User-Agent に含まれている場合、Fail2ban は即座にその IP をブロックするはずです。</p>
</li>
</ul>
<hr>
<ul>
<li>
<p><strong>4. ブルートフォースログイン攻撃のテスト</strong></p>
<p>WordPress やその他のログインページに対して複数回リクエストを送信し、ブルートフォース攻撃をシミュレートします：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">for i in $(seq 1 6); do</span><br></span><span class=token-line style=color:#393A34><span class="token plain">    curl -X POST -d "username=admin&password=wrongpassword" http://&lt;あなたのサーバー>/wp-login.php ;</span><br></span><span class=token-line style=color:#393A34><span class="token plain">done</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p><code>nginx-sensitive</code>フィルターが「5 回の失敗でブロック」と設定されている場合、Fail2ban は 5 回目または 6 回目の失敗時に IP をブロックするはずです。</p>
</li>
</ul>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=ステータスとログの確認>ステータスとログの確認<a href=#ステータスとログの確認 class=hash-link aria-label="ステータスとログの確認 への直接リンク" title="ステータスとログの確認 への直接リンク">​</a></h3>
<p>以下のコマンドを使って、Jail のステータスを確認できます。例えば、<code>nginx-sensitive</code> Jail のステータスを確認する場合：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client status nginx-sensitive</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>期待される出力：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">Status for the jail: nginx-sensitive</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|- Filter</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|  |- Currently failed: 0</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|  |- Total failed: 9</span><br></span><span class=token-line style=color:#393A34><span class="token plain">|  `- File list: /var/log/nginx/access.log /var/log/nginx/error.log</span><br></span><span class=token-line style=color:#393A34><span class="token plain">`- Actions</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |- Currently banned: 1</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   |- Total banned: 2</span><br></span><span class=token-line style=color:#393A34><span class="token plain">   `- Banned IP list: 203.0.113.45</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<ul>
<li><strong>Currently banned</strong>：現在ブロックされている IP の数。</li>
<li><strong>Total failed</strong>：累積した悪意のあるリクエストの回数。</li>
<li><strong>Banned IP list</strong>：現在ブロックされている IP のリスト（例：<code>203.0.113.45</code>）。</li>
</ul>
<hr>
<p>次に、Fail2ban のログを確認して、ブロックの記録を確認できます：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo tail -n 20 /var/log/fail2ban.log</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>期待される出力例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">fail2ban.actions [INFO] Ban 203.0.113.45 on nginx-sensitive</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これは、<code>203.0.113.45</code>が<code>nginx-sensitive</code>ルールによってブロックされたことを示します。</p>
<h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=ip-の解除>IP の解除<a href=#ip-の解除 class=hash-link aria-label="IP の解除 への直接リンク" title="IP の解除 への直接リンク">​</a></h3>
<p>テストや日常的な管理中に、特定の IP を手動でブロックまたは解除することが必要な場合があります。</p>
<p>特定の IP を手動でブロックするには、次のコマンドを実行します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client set nginx-sensitive banip 203.0.113.45</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これにより、<code>203.0.113.45</code>が直ちにブロックされ、<code>nginx-sensitive</code> Jail のブロックリストに追加されます。</p>
<p>誤ってブロックされた IP を解除するには、次のコマンドを実行します：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo fail2ban-client set nginx-sensitive unbanip 203.0.113.45</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>このコマンドを実行後、<code>fail2ban-client status nginx-sensitive</code>を使って、IP がブロックリストから削除されているかを確認できます。</p>
<hr>
<p>最後に、ファイアウォールのルール（iptables / nftables）が正しく設定されているかを確認できます。</p>
<p>Fail2ban は主に<code>iptables</code>（または<code>nftables</code>）を通じて IP をブロックするため、直接ファイアウォールルールを確認することもできます：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">sudo iptables -L -n --line-numbers</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>ブロック規則が適用されていれば、次のような表示が確認できます：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#393A34;--prism-background-color:#f6f8fa><div class=codeBlockContent_biex><pre tabindex=0 class="prism-code language-text codeBlock_bY9V thin-scrollbar" style=color:#393A34;background-color:#f6f8fa><code class=codeBlockLines_e6Vv><span class=token-line style=color:#393A34><span class="token plain">Chain f2b-nginx-sensitive (1 references)</span><br></span><span class=token-line style=color:#393A34><span class="token plain">num  target     prot opt source               destination</span><br></span><span class=token-line style=color:#393A34><span class="token plain">1    REJECT     all  --  203.0.113.45          0.0.0.0/0   reject-with icmp-port-unreachable</span><br></span></code></pre><div class=buttonGroup__atx><button type=button aria-label=クリップボードにコードをコピー title=コピー class=clean-btn><span class=copyButtonIcons_eSgA aria-hidden=true><svg viewBox="0 0 24 24" class=copyButtonIcon_y97N><path fill=currentColor d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg><svg viewBox="0 0 24 24" class=copyButtonSuccessIcon_LjdS><path fill=currentColor d=M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z /></svg></span></button></div></div></div>
<p>これは、<code>203.0.113.45</code>がブロックされ、すべてのトラフィックが拒否されることを示しています。</p>
<h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id=結論>結論<a href=#結論 class=hash-link aria-label="結論 への直接リンク" title="結論 への直接リンク">​</a></h2>
<p>これで、Nginx 用の防御規則を設定し、基本的な Fail2ban 設定が完了しました。</p>
<p>この部分では、実際のニーズに応じてパラメータを調整してください。例えば、異なる攻撃タイプごとに異なる Jail を作成し、<code>maxretry</code>や<code>findtime</code>を設定すること、重要な IP を誤ってブロックしないように<code>ignoreip</code>のホワイトリストを慎重に設定することが必要です。</p>
<p>デプロイ後も、Fail2ban のログを定期的に監視し、正常に動作していることを確認して、悪意のある攻撃に対する効果的な防御を維持してください。</div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class=col></div><div class="col lastUpdated_JAkA"><span class=theme-last-updated><b><time datetime=2025-02-15T07:30:22.000Z itemprop=dateModified>2025年2月15日</time></b>に<b>zephyr-sh</b>が<!-- -->最終更新</span></div></div><div style=margin-top:3rem> </div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label=ドキュメントページ><a class="pagination-nav__link pagination-nav__link--prev" href=/ja/docs/nginx-notes/security><div class=pagination-nav__sublabel>前へ</div><div class=pagination-nav__label>Nginx のセキュリティ強化</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/ja/docs/nginx-notes/static-file-server><div class=pagination-nav__sublabel>次へ</div><div class=pagination-nav__label>Nginx による静的リソースの提供</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#fail2ban-とは class="table-of-contents__link toc-highlight">Fail2ban とは？</a><li><a href=#一般的な攻撃タイプの監視 class="table-of-contents__link toc-highlight">一般的な攻撃タイプの監視</a><ul><li><a href=#悪意のあるクローラーの防止 class="table-of-contents__link toc-highlight">悪意のあるクローラーの防止</a><li><a href=#404-スキャン攻撃の防止 class="table-of-contents__link toc-highlight">404 スキャン攻撃の防止</a><li><a href=#ddos-攻撃の防止 class="table-of-contents__link toc-highlight">DDoS 攻撃の防止</a><li><a href=#ブルートフォースログインの防止 class="table-of-contents__link toc-highlight">ブルートフォースログインの防止</a><li><a href=#敏感情報へのアクセス試行の防止 class="table-of-contents__link toc-highlight">敏感情報へのアクセス試行の防止</a><li><a href=#api-攻撃への対応 class="table-of-contents__link toc-highlight">API 攻撃への対応</a><li><a href=#新規ルールの適用 class="table-of-contents__link toc-highlight">新規ルールの適用</a></ul><li><a href=#防御効果のテスト class="table-of-contents__link toc-highlight">防御効果のテスト</a><ul><li><a href=#curl-を使った攻撃のシミュレーション class="table-of-contents__link toc-highlight"><code>curl</code> を使った攻撃のシミュレーション</a><li><a href=#ステータスとログの確認 class="table-of-contents__link toc-highlight">ステータスとログの確認</a><li><a href=#ip-の解除 class="table-of-contents__link toc-highlight">IP の解除</a></ul><li><a href=#結論 class="table-of-contents__link toc-highlight">結論</a></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__links text--center"><div class=footer__links><a class=footer__link-item href=/ja/docs>オープンソースプロジェクト</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/ja/papers/intro>論文ノート</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/ja/blog>ブログ</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/ja/terms-of-service>利用規約</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/ja/privacy-policy>プライバシーポリシー</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/ja/become-an-author>著者になる</a><span class=footer__link-separator>·</span><a class=footer__link-item href=/ja/worklog>作業日誌</a></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © 2024 DOCSAID.</div></div></div></footer></div>