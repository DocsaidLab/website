"use strict";(self.webpackChunkdocsaid_website=self.webpackChunkdocsaid_website||[]).push([["72063"],{36732:function(e,n,t){t.r(n),t.d(n,{frontMatter:()=>o,default:()=>h,contentTitle:()=>c,assets:()=>a,toc:()=>l,metadata:()=>i});var i=JSON.parse('{"id":"nginx-notes/https-settings","title":"Nginx HTTPS Settings","description":"In today\'s internet environment, website security has become a crucial concern, and SSL/TLS certificates are essential technologies to protect data transmission between websites and users.","source":"@site/i18n/en/docusaurus-plugin-content-docs/current/nginx-notes/https-settings.md","sourceDirName":"nginx-notes","slug":"/nginx-notes/https-settings","permalink":"/en/docs/nginx-notes/https-settings","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedBy":"zephyr-sh","lastUpdatedAt":1740705000000,"sidebarPosition":3,"frontMatter":{"sidebar_position":3},"sidebar":"tutorialSidebar","previous":{"title":"Nginx Configuration","permalink":"/en/docs/nginx-notes/install-and-settings"},"next":{"title":"Nginx Security","permalink":"/en/docs/nginx-notes/security"}}'),r=t(85893),s=t(50065);let o={sidebar_position:3},c="Nginx HTTPS Settings",a={},l=[{value:"Installing Let&#39;s Encrypt",id:"installing-lets-encrypt",level:2},{value:"Requesting a Let&#39;s Encrypt Certificate",id:"requesting-a-lets-encrypt-certificate",level:2},{value:"Configuring Nginx to Enable HTTPS",id:"configuring-nginx-to-enable-https",level:2},{value:"Nginx Reverse Proxy and Backend Services",id:"nginx-reverse-proxy-and-backend-services",level:2},{value:"Configuring Automatic Certificate Renewal",id:"configuring-automatic-certificate-renewal",level:2},{value:"Certbot&#39;s Automatic Renewal Mechanism",id:"certbots-automatic-renewal-mechanism",level:3},{value:"Verifying Automatic Renewal",id:"verifying-automatic-renewal",level:3},{value:"Ensuring the New Certificate Takes Effect After Renewal",id:"ensuring-the-new-certificate-takes-effect-after-renewal",level:3},{value:"Verifying Successful Renewal of the Certificate",id:"verifying-successful-renewal-of-the-certificate",level:3},{value:"Testing and Verifying HTTPS Configuration",id:"testing-and-verifying-https-configuration",level:2},{value:"Browser Test",id:"browser-test",level:3},{value:"Checking HTTP to HTTPS Redirection",id:"checking-http-to-https-redirection",level:3},{value:"Ensuring the Website Functions Correctly",id:"ensuring-the-website-functions-correctly",level:3},{value:"Checking Nginx Logs",id:"checking-nginx-logs",level:3},{value:"Conclusion",id:"conclusion",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"nginx-https-settings",children:"Nginx HTTPS Settings"})}),"\n",(0,r.jsx)(n.p,{children:"In today's internet environment, website security has become a crucial concern, and SSL/TLS certificates are essential technologies to protect data transmission between websites and users."}),"\n",(0,r.jsx)(n.p,{children:"Let's Encrypt is a free, automated, and open Certificate Authority (CA) that provides encryption protection for millions of websites worldwide, making HTTPS more accessible."}),"\n",(0,r.jsx)(n.p,{children:"Since it\u2019s free, we definitely have to support it, right?"}),"\n",(0,r.jsx)(n.p,{children:"So, we\u2019ll configure HTTPS on the Nginx server using Let's Encrypt."}),"\n",(0,r.jsx)(n.p,{children:"The goals of this section include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Obtain an SSL certificate"}),": Use Let's Encrypt\u2019s free certificate to encrypt website traffic."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Enforce HTTPS traffic"}),": Automatically redirect all HTTP requests to HTTPS (301 permanent redirect)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Nginx Reverse Proxy"}),": Ensure the front-end SSL works correctly with Nginx as a reverse proxy."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Automatic Renewal"}),": Set up an automatic certificate renewal mechanism to prevent certificate expiration after 90 days."]}),"\n"]}),"\n",(0,r.jsxs)(n.admonition,{type:"tip",children:[(0,r.jsx)(n.p,{children:"In the previous chapter, we briefly introduced the pros and cons of Let's Encrypt."}),(0,r.jsxs)(n.p,{children:["If you\u2019re not familiar with it, you can first check out our supplementary document: ",(0,r.jsx)(n.a,{href:"/en/docs/nginx-notes/supplementary/about-lets-encrypt",children:(0,r.jsx)(n.strong,{children:"Let's Encrypt"})})]})]}),"\n",(0,r.jsx)(n.h2,{id:"installing-lets-encrypt",children:"Installing Let's Encrypt"}),"\n",(0,r.jsx)(n.p,{children:"We use Let's Encrypt's ACME protocol to obtain SSL certificates."}),"\n",(0,r.jsx)(n.p,{children:"First, we need to install Certbot, the recommended ACME client from Let's Encrypt. Certbot automatically interacts with Let's Encrypt to request and renew certificates."}),"\n",(0,r.jsx)(n.p,{children:"For Debian/Ubuntu, you can install it directly from the package repository:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo apt update\nsudo apt install -y certbot python3-certbot-nginx\n"})}),"\n",(0,r.jsx)(n.p,{children:"This command will install Certbot along with the Nginx plugin, allowing Certbot to automatically modify Nginx configuration files to deploy the certificate."}),"\n",(0,r.jsx)(n.p,{children:"Before proceeding, ensure the following preparations are complete:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"You have a domain name"})," and its DNS records are pointing to your server's IP address."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"You have opened ports 80 and 443 in your firewall"}),", allowing HTTP/HTTPS traffic for verification and subsequent access."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"requesting-a-lets-encrypt-certificate",children:"Requesting a Let's Encrypt Certificate"}),"\n",(0,r.jsx)(n.p,{children:"With Certbot, we can request a certificate from Let's Encrypt."}),"\n",(0,r.jsx)(n.p,{children:"Let's Encrypt uses an automated ACME validation mechanism, requiring you to prove control over the domain. A common validation method is HTTP validation (Certbot will place a temporary file on your site for Let's Encrypt to validate) or DNS validation (more complex, used for wildcard certificate requests)."}),"\n",(0,r.jsx)(n.p,{children:"Here, we'll use simple HTTP validation and let the Nginx plugin configure it automatically:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Stop Nginx (may be required in webroot mode, but not needed with --nginx plugin)\n# sudo systemctl stop nginx\n\n# Run Certbot with the Nginx plugin to request a certificate\nsudo certbot --nginx -d your-domain.com -d www.your-domain.com\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Replace ",(0,r.jsx)(n.code,{children:"your-domain.com"})," and ",(0,r.jsx)(n.code,{children:"www.your-domain.com"})," with your actual domain name."]}),"\n",(0,r.jsx)(n.p,{children:"Once executed, Certbot will communicate with the Let's Encrypt server:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Domain Validation"}),": Certbot might temporarily modify the Nginx configuration or start a temporary service to respond to Let's Encrypt\u2019s validation request. For example, Let's Encrypt will attempt to access a validation file via ",(0,r.jsx)(n.code,{children:"http://your-domain.com/.well-known/acme-challenge/"}),". If the validation is successful, it confirms you control the domain."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Obtain Certificate"}),": Once validated, Let's Encrypt will issue an SSL certificate (including the full certificate chain ",(0,r.jsx)(n.code,{children:"fullchain.pem"})," and the private key file ",(0,r.jsx)(n.code,{children:"privkey.pem"}),"). Certbot will store these files in the default path (usually ",(0,r.jsx)(n.code,{children:"/etc/letsencrypt/live/your-domain.com/"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"During the process, Certbot might ask:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Whether you agree to the terms of service and provide an email address (for renewal notifications)."}),"\n",(0,r.jsxs)(n.li,{children:["Whether to automatically redirect HTTP traffic to HTTPS. ",(0,r.jsx)(n.strong,{children:"It\u2019s recommended to choose redirect"})," so Certbot can automatically set up the 301 redirect rule for you to ensure users access the site via HTTPS."]}),"\n"]}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["If you're not using the ",(0,r.jsx)(n.code,{children:"--nginx"})," plugin, you can also use the ",(0,r.jsx)(n.code,{children:"certbot certonly --webroot"})," mode to manually obtain the certificate and then edit the Nginx configuration yourself. Using ",(0,r.jsx)(n.code,{children:"--nginx"})," saves you from having to manually configure the settings."]})}),"\n",(0,r.jsx)(n.h2,{id:"configuring-nginx-to-enable-https",children:"Configuring Nginx to Enable HTTPS"}),"\n",(0,r.jsx)(n.p,{children:"Once the certificate has been issued, we need to enable HTTPS (SSL) in Nginx and load the certificate we just obtained."}),"\n",(0,r.jsx)(n.p,{children:"Here\u2019s an example configuration (assuming the default installation path for Certbot):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"# In Nginx's configuration file (e.g., /etc/nginx/sites-available/your-domain.conf):\n\n# HTTP service on port 80, redirect all requests to HTTPS\nserver {\n    listen 80;\n    listen [::]:80;\n    server_name your-domain.com www.your-domain.com;\n    # Redirect HTTP requests permanently to HTTPS\n    return 301 https://$host$request_uri;\n}\n\n# HTTPS service on port 443\nserver {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name your-domain.com www.your-domain.com;\n\n    # SSL certificate file paths (issued by Certbot)\n    ssl_certificate      /etc/letsencrypt/live/your-domain.com/fullchain.pem;\n    ssl_certificate_key  /etc/letsencrypt/live/your-domain.com/privkey.pem;\n\n    # (Reverse proxy configuration example)\n    location / {\n        proxy_pass http://127.0.0.1:8000;  # Forward requests to the backend application (e.g., FastAPI running on port 8000)\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n        proxy_intercept_errors on;\n    }\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Explanation of each part:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"HTTP service on port 80 (force redirect to HTTPS)"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"server {\n    listen 80;\n    listen [::]:80;\n    server_name your-domain.com www.your-domain.com;\n    # Redirect HTTP requests permanently to HTTPS\n    return 301 https://$host$request_uri;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Purpose of this block:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Listen on HTTP (port 80)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"listen 80;"})," : Nginx listens for IPv4 connections on port 80 (standard HTTP connection)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"listen [::]:80;"})," : Allows IPv6 connections."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Set ",(0,r.jsx)(n.code,{children:"server_name"})]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"server_name your-domain.com www.your-domain.com;"})}),"\n",(0,r.jsxs)(n.li,{children:["This tells Nginx that this configuration applies to ",(0,r.jsx)(n.code,{children:"your-domain.com"})," and ",(0,r.jsx)(n.code,{children:"www.your-domain.com"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Ensures that both the ",(0,r.jsx)(n.code,{children:"www"})," and non-",(0,r.jsx)(n.code,{children:"www"})," versions of the domain are correctly handled."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Force HTTP to HTTPS redirection"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"return 301 https://$host$request_uri;"})}),"\n",(0,r.jsx)(n.li,{children:"This will redirect all HTTP requests to HTTPS using a 301 permanent redirect."}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$host"})," represents the requested host (",(0,r.jsx)(n.code,{children:"your-domain.com"})," or ",(0,r.jsx)(n.code,{children:"www.your-domain.com"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$request_uri"})," represents the full URI of the request (e.g., ",(0,r.jsx)(n.code,{children:"/about"}),")."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"HTTPS service on port 443"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"server {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name your-domain.com www.your-domain.com;\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Purpose of this block:"})}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Listen on HTTPS (port 443)"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:"listen 443 ssl http2;"})}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"ssl"})," : Enable SSL encryption."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"http2"})," : Enable HTTP/2 for improved performance (reduces connection latency)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"listen [::]:443 ssl http2;"})," : Allows IPv6 connections using HTTPS."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Set ",(0,r.jsx)(n.code,{children:"server_name"})]})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Same as the HTTP configuration, it applies to ",(0,r.jsx)(n.code,{children:"your-domain.com"})," and ",(0,r.jsx)(n.code,{children:"www.your-domain.com"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"SSL certificate configuration"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"    # SSL certificate file paths (issued by Certbot)\n    ssl_certificate      /etc/letsencrypt/live/your-domain.com/fullchain.pem;\n    ssl_certificate_key  /etc/letsencrypt/live/your-domain.com/privkey.pem;\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Purpose of this block:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["These are the certificate paths automatically generated by ",(0,r.jsx)(n.strong,{children:"Let\u2019s Encrypt"}),":","\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"fullchain.pem"})," : The full certificate (including the intermediate CA certificates)."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"privkey.pem"})," : The private key used for SSL encryption."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Reverse proxy to FastAPI"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"    location / {\n        proxy_pass http://127.0.0.1:8000;  # Forward requests to the backend application (FastAPI)\n        proxy_http_version 1.1;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto $scheme;\n\n        # Let Nginx handle errors returned by FastAPI\n        proxy_intercept_errors on;\n    }\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Purpose of this block:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.code,{children:"proxy_pass http://127.0.0.1:8000;"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Assumes that FastAPI is running on ",(0,r.jsx)(n.code,{children:"127.0.0.1:8000"})," (command: ",(0,r.jsx)(n.code,{children:"uvicorn --host 127.0.0.1 --port 8000"}),")."]}),"\n",(0,r.jsx)(n.li,{children:"Forwards API requests to the FastAPI application running on the local server."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Proxy headers"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"proxy_set_header Host $host;"})," : Passes the original ",(0,r.jsx)(n.code,{children:"Host"})," header."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"proxy_set_header X-Real-IP $remote_addr;"})," : Passes the real client IP to the backend."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;"})," : Records the entire proxy chain."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"proxy_set_header X-Forwarded-Proto $scheme;"})," : Ensures the backend knows whether the original request was HTTP or HTTPS."]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Error handling"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"proxy_intercept_errors on;"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Allows Nginx to intercept errors returned by the backend (e.g., 502, 503)."}),"\n",(0,r.jsxs)(n.li,{children:["Custom error pages can be specified with ",(0,r.jsx)(n.code,{children:"error_page"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:"After completing the configuration, reload Nginx to apply the changes:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo nginx -t  # Test Nginx configuration syntax for correctness\nsudo systemctl reload nginx  # Apply configuration changes and reload the service\n"})}),"\n",(0,r.jsx)(n.h2,{id:"nginx-reverse-proxy-and-backend-services",children:"Nginx Reverse Proxy and Backend Services"}),"\n",(0,r.jsx)(n.p,{children:"In the architecture described above, Nginx serves as both the HTTPS endpoint and reverse proxy."}),"\n",(0,r.jsx)(n.p,{children:"Nginx handles the TLS handshake and encryption/decryption, meaning the SSL termination occurs at the Nginx layer. The backend application only needs to handle HTTP requests from Nginx, without needing to support HTTPS. Internal communication within the server remains lightweight, without the additional burden of encryption."}),"\n",(0,r.jsx)(n.p,{children:"This setup simplifies the backend application's configuration and reduces the maintenance overhead related to HTTPS."}),"\n",(0,r.jsx)(n.p,{children:"Additionally, when using Nginx as a reverse proxy, the backend application by default cannot directly access the client\u2019s real IP address. Instead, it will only see Nginx's IP."}),"\n",(0,r.jsxs)(n.p,{children:["To resolve this, we need to pass important HTTP headers to the backend application via ",(0,r.jsx)(n.code,{children:"proxy_set_header"})," to ensure the backend correctly identifies client information."]}),"\n",(0,r.jsx)(n.p,{children:"Key headers include:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"X-Forwarded-For"})})," \u2192 Passes the original client\u2019s IP address."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"Host"})})," \u2192 Retains the original host name of the request."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"X-Forwarded-Proto"})})," \u2192 Indicates the protocol used in the original request (",(0,r.jsx)(n.code,{children:"http"})," or ",(0,r.jsx)(n.code,{children:"https"}),")."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Nginx configuration:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"proxy_set_header Host $host;\nproxy_set_header X-Real-IP $remote_addr;\nproxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\nproxy_set_header X-Forwarded-Proto $scheme;\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Assuming our backend is a Python-based FastAPI application, by default FastAPI will not parse the proxy-passed headers. Therefore, we need to enable the ",(0,r.jsx)(n.code,{children:"proxy-headers"})," mode to correctly identify headers like ",(0,r.jsx)(n.code,{children:"X-Forwarded-For"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"uvicorn app:app --host 127.0.0.1 --port 8000 --proxy-headers\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Alternatively, inside FastAPI, we can use ",(0,r.jsx)(n.code,{children:"StarletteMiddleware.ProxyHeaders"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from fastapi import FastAPI\nfrom starlette.middleware.trustedhost import TrustedHostMiddleware\nfrom starlette.middleware.proxy_headers import ProxyHeadersMiddleware\n\napp = FastAPI()\n\n# Enable proxy header parsing\napp.add_middleware(ProxyHeadersMiddleware)\napp.add_middleware(TrustedHostMiddleware, allowed_hosts=["*"])\n'})}),"\n",(0,r.jsx)(n.p,{children:"With this configuration, the backend application can correctly obtain the client\u2019s real IP, request protocol, and other information, preventing misidentification."}),"\n",(0,r.jsx)(n.p,{children:"Finally, to ensure security, FastAPI should only listen on the local interface to prevent direct external access to the HTTP service, reducing the risk of unauthorized access."}),"\n",(0,r.jsx)(n.p,{children:"Best practice is:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"FastAPI should listen on the local interface"})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"uvicorn app:app --host 127.0.0.1 --port 8000\n"})}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["Nginx ",(0,r.jsx)(n.code,{children:"proxy_pass"})," should point to the local port"]})}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-nginx",children:"location / {\n    proxy_pass http://127.0.0.1:8000;\n}\n"})}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This way, external users cannot directly access the backend FastAPI application; they can only access it through Nginx as a proxy, enhancing security. Internal traffic remains unencrypted over HTTP, minimizing the additional burden of HTTPS and improving performance."}),"\n",(0,r.jsx)(n.h2,{id:"configuring-automatic-certificate-renewal",children:"Configuring Automatic Certificate Renewal"}),"\n",(0,r.jsx)(n.p,{children:"Let's Encrypt certificates are only valid for 90 days. This short validity period is designed to enhance security and encourage website administrators to implement automated renewal mechanisms. Manual renewal might lead to certificate expiration, disrupting HTTPS connections on the site. Therefore, it\u2019s recommended to use Certbot's automatic renewal feature to ensure the certificate remains valid at all times."}),"\n",(0,r.jsx)(n.h3,{id:"certbots-automatic-renewal-mechanism",children:"Certbot's Automatic Renewal Mechanism"}),"\n",(0,r.jsx)(n.p,{children:"Certbot uses different methods for automatic renewal depending on the system's initialization system (init system):"}),"\n",(0,r.jsx)(n.p,{children:"For systemd-based systems (most modern Linux distributions), Certbot uses a systemd timer to manage renewals, rather than a cron job."}),"\n",(0,r.jsx)(n.p,{children:"You can check if the systemd timer is enabled:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"systemctl list-timers | grep certbot\n"})}),"\n",(0,r.jsx)(n.p,{children:"If enabled, you should see something like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"certbot.timer               2025-02-13 02:00:00 UTC   12h left\n"})}),"\n",(0,r.jsx)(n.p,{children:"You can also manually check the status of the systemd timer:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"systemctl status certbot.timer\n"})}),"\n",(0,r.jsxs)(n.p,{children:["systemd runs the renewal check twice a day via the ",(0,r.jsx)(n.code,{children:"certbot.timer"}),". The actual renewal only occurs if the certificate is within ",(0,r.jsx)(n.strong,{children:"30 days of expiry"}),"."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["For non-systemd systems, Certbot uses a cron job, typically located at ",(0,r.jsx)(n.code,{children:"/etc/cron.d/certbot"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"The cron job might look like this:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"0 */12 * * * root test -x /usr/bin/certbot -a \\! -d /run/systemd/system && perl -e 'sleep int(rand(43200))' && certbot -q renew --no-random-sleep-on-renew\n"})}),"\n",(0,r.jsx)(n.p,{children:"This means it runs every 12 hours. If the system is using systemd, the cron job will not be executed."}),"\n",(0,r.jsx)(n.p,{children:"To avoid multiple renewals occurring simultaneously on the server, the cron job introduces a random delay of up to 12 hours."}),"\n",(0,r.jsx)(n.h3,{id:"verifying-automatic-renewal",children:"Verifying Automatic Renewal"}),"\n",(0,r.jsxs)(n.p,{children:["Whether using ",(0,r.jsx)(n.strong,{children:"systemd timer"})," or ",(0,r.jsx)(n.strong,{children:"cron"}),", you can manually test the renewal mechanism:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo certbot renew --dry-run\n"})}),"\n",(0,r.jsx)(n.p,{children:"If there are no errors in the output, it means the automatic renewal mechanism is functioning correctly."}),"\n",(0,r.jsx)(n.p,{children:"You can also check the installed certificates:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo certbot certificates\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will list the expiration dates and file paths of all certificates, ensuring they are not expired."}),"\n",(0,r.jsx)(n.h3,{id:"ensuring-the-new-certificate-takes-effect-after-renewal",children:"Ensuring the New Certificate Takes Effect After Renewal"}),"\n",(0,r.jsx)(n.p,{children:"After Let's Encrypt renews a certificate, Nginx/Apache will still use the old certificate until it's reloaded."}),"\n",(0,r.jsx)(n.p,{children:"To ensure the new certificate is loaded, you can use the following command:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo systemctl reload nginx  # or systemctl reload apache2\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can also add a ",(0,r.jsx)(n.code,{children:'--post-hook "systemctl reload nginx"'})," to the ",(0,r.jsx)(n.code,{children:"certbot renew"})," command, so that Certbot automatically reloads the server after a successful renewal."]}),"\n",(0,r.jsx)(n.h3,{id:"verifying-successful-renewal-of-the-certificate",children:"Verifying Successful Renewal of the Certificate"}),"\n",(0,r.jsx)(n.p,{children:"To check the current certificate expiration date:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo certbot certificates\n"})}),"\n",(0,r.jsx)(n.p,{children:"This will list all certificates managed by Certbot, including the expiration date and storage location. Make sure that after renewal, the expiration date has been updated."}),"\n",(0,r.jsx)(n.h2,{id:"testing-and-verifying-https-configuration",children:"Testing and Verifying HTTPS Configuration"}),"\n",(0,r.jsx)(n.p,{children:"After completing the HTTPS setup, perform the following tests to ensure everything is working correctly and meets security standards:"}),"\n",(0,r.jsx)(n.h3,{id:"browser-test",children:"Browser Test"}),"\n",(0,r.jsxs)(n.p,{children:["Go to ",(0,r.jsx)(n.code,{children:"https://your-domain.com"})," in your browser, ensuring that the secure lock icon \uD83D\uDD12 appears. Click on the certificate information to verify that the issuer is ",(0,r.jsx)(n.strong,{children:"Let's Encrypt"})," and that the certificate is valid and matches the domain."]}),"\n",(0,r.jsxs)(n.p,{children:["Try accessing ",(0,r.jsx)(n.code,{children:"http://your-domain.com"}),"; it should automatically redirect to HTTPS."]}),"\n",(0,r.jsx)(n.h3,{id:"checking-http-to-https-redirection",children:"Checking HTTP to HTTPS Redirection"}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"curl"})," to test:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"curl -I http://your-domain.com\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Ensure that it returns a ",(0,r.jsx)(n.code,{children:"301 Moved Permanently"})," response, and the ",(0,r.jsx)(n.code,{children:"Location"})," header should point to ",(0,r.jsx)(n.code,{children:"https://your-domain.com/..."}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"ensuring-the-website-functions-correctly",children:"Ensuring the Website Functions Correctly"}),"\n",(0,r.jsx)(n.p,{children:"Check that the backend API/website works as expected, such as:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Does the FastAPI API respond correctly?"}),"\n",(0,r.jsx)(n.li,{children:"Are internal HTTPS links on the website working?"}),"\n",(0,r.jsxs)(n.li,{children:["Have you taken ",(0,r.jsx)(n.code,{children:"X-Forwarded-Proto"})," into account for handling HTTPS redirects?"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"checking-nginx-logs",children:"Checking Nginx Logs"}),"\n",(0,r.jsx)(n.p,{children:"Review error and access logs to ensure there are no abnormalities:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo tail -f /var/log/nginx/access.log\nsudo tail -f /var/log/nginx/error.log\n"})}),"\n",(0,r.jsxs)(n.p,{children:["If you encounter TLS connection errors, it may be due to outdated devices not supporting ",(0,r.jsx)(n.strong,{children:"TLS 1.2"}),". Adjust settings accordingly if necessary."]}),"\n",(0,r.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,r.jsx)(n.p,{children:"We've accomplished a lot."}),"\n",(0,r.jsx)(n.p,{children:"In this chapter, we successfully enabled HTTPS for Nginx, ensuring that all traffic is encrypted using a certificate issued by Let's Encrypt. We also forced HTTP traffic to be redirected to HTTPS, providing a more secure connection environment."}),"\n",(0,r.jsx)(n.p,{children:"In addition to the basic HTTPS deployment, we used Nginx as a reverse proxy for FastAPI, ensuring that the front-end Nginx securely forwards requests to the backend service while preserving original request information such as client IP and protocol (HTTP/HTTPS). This ensures the integrity and traceability of the backend application."}),"\n",(0,r.jsx)(n.p,{children:"Finally, we implemented an automatic certificate renewal mechanism, ensuring that Let's Encrypt certificates are updated automatically and take effect after renewal, keeping the website's HTTPS connection active at all times."}),"\n",(0,r.jsx)(n.p,{children:"So, are the website's security standards complete?"}),"\n",(0,r.jsx)(n.p,{children:"Not quite yet. In the next chapter, we will explore advanced security configurations, such as HSTS, CSP headers, and how to prevent common website attacks."})]})}function h(e={}){let{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},50065:function(e,n,t){t.d(n,{Z:()=>c,a:()=>o});var i=t(67294);let r={},s=i.createContext(r);function o(e){let n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);