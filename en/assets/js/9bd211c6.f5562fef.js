"use strict";(self.webpackChunkblog=self.webpackChunkblog||[]).push([[2721],{23821:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>c});var s=t(74848),i=t(28453);const o={slug:"gosu-usage",title:"User Switching Tool in Containers: gosu",authors:"Zephyr",tags:["docker","gosu","sudo","container"],image:"/en/img/2024/0203.webp",description:"A tool worth learning how to use."},r=void 0,a={permalink:"/en/blog/gosu-usage",source:"@site/i18n/en/docusaurus-plugin-content-blog/2024/02-03-usage-gosu/index.md",title:"User Switching Tool in Containers: gosu",description:"A tool worth learning how to use.",date:"2024-02-03T00:00:00.000Z",tags:[{inline:!0,label:"docker",permalink:"/en/blog/tags/docker"},{inline:!0,label:"gosu",permalink:"/en/blog/tags/gosu"},{inline:!0,label:"sudo",permalink:"/en/blog/tags/sudo"},{inline:!0,label:"container",permalink:"/en/blog/tags/container"}],readingTime:4.04,hasTruncateMarker:!1,authors:[{name:"Zephyr",title:"Engineer",url:"https://github.com/zephyr-sh",imageURL:"https://github.com/zephyr-sh.png",key:"Zephyr"}],frontMatter:{slug:"gosu-usage",title:"User Switching Tool in Containers: gosu",authors:"Zephyr",tags:["docker","gosu","sudo","container"],image:"/en/img/2024/0203.webp",description:"A tool worth learning how to use."},unlisted:!1,prevItem:{title:"error-record",permalink:"/en/blog/2024/02/04/error-record"},nextItem:{title:"Managing Python Versions with pyenv",permalink:"/en/blog/pyenv-installation"}},l={authorsImageUrls:[void 0]},c=[{value:"Common Issues",id:"common-issues",level:2},{value:"TTY Conversion",id:"tty-conversion",level:3},{value:"Signal Forwarding",id:"signal-forwarding",level:3},{value:"What is gosu?",id:"what-is-gosu",level:2},{value:"Practical Use Cases",id:"practical-use-cases",level:3},{value:"Security Considerations",id:"security-considerations",level:3}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("figure",{children:(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.img,{alt:"title",src:t(31304).A+"",width:"1024",height:"1024"}),"\n",(0,s.jsx)("figcaption",{children:"Cover Image: Automatically generated by GPT-4 after reading this article"})]})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:"Docker technology has been extensively employed in deployment and management, allowing developers to package applications and their dependencies together to ensure consistent operation across different environments."}),"\n",(0,s.jsx)(n.h2,{id:"common-issues",children:"Common Issues"}),"\n",(0,s.jsx)(n.p,{children:"However, with frequent use, you can't escape encountering a few common problems."}),"\n",(0,s.jsx)(n.h3,{id:"tty-conversion",children:"TTY Conversion"}),"\n",(0,s.jsxs)(n.p,{children:["A common scenario is when you output a file within a container, exit the container, and then realize that the file permissions are all set to root. You then have to use ",(0,s.jsx)(n.code,{children:"chown"})," to change the file permissions repeatedly, which can be quite cumbersome."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:"Or, when running an application within a Docker container using sudo that requires interaction with the terminal (TTY), these applications might fail to properly detect the terminal because sudo might not handle terminal ownership and control properly when creating a new session. As a result, these applications requiring terminal interaction may not run correctly or encounter input/output errors when attempting to use them."}),"\n",(0,s.jsx)(n.h3,{id:"signal-forwarding",children:"Signal Forwarding"}),"\n",(0,s.jsx)(n.p,{children:"Suppose you have a container running a web server like Apache or Nginx. Typically, you might use command-line tools to manage this container, including starting and stopping it. Inside the container, if you use sudo to start the web server, sudo will create a new process to run the web server."}),"\n",(0,s.jsx)(n.p,{children:"The problem arises when you want to stop or restart the container. The container management system sends signals (like SIGTERM) to the container to notify processes inside it to prepare for shutdown. However, if the web server was started via sudo, this signal might only be sent to the sudo process, not the actual web server process. This means the web server might not receive the stop signal, preventing proper cleanup and safe shutdown."}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsx)(n.p,{children:"The design intention of sudo is to enhance security by allowing regular users to execute commands as other users (usually the root user). In this process, sudo starts a new session to execute the command. While this behavior typically poses no issues in traditional operating system environments, it can lead to signal delivery problems in lightweight virtualized environments like containers, as the new session created by sudo might be incompatible with how the container management system sends signals."})}),"\n",(0,s.jsx)(n.h2,{id:"what-is-gosu",children:"What is gosu?"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/tianon/gosu",children:(0,s.jsx)(n.strong,{children:"gosu GitHub repository"})})}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["gosu is a tool specifically designed for containers, aiming to simplify and secure command execution within containers. When you need to run a command as a different user (e.g., switching from an administrator to a regular user) within a container, gosu comes in handy. Its core mechanism directly borrows from how ",(0,s.jsx)(n.code,{children:"Docker/libcontainer"})," starts applications within containers (in fact, it directly uses code from the ",(0,s.jsx)(n.code,{children:"libcontainer"})," library for handling ",(0,s.jsx)(n.code,{children:"/etc/passwd"}),")."]}),"\n",(0,s.jsx)(n.p,{children:'If you\'re not interested in its inner workings, think of gosu as a helper. When you tell it to "run this command as this user," it does just that, then exits, leaving no trace behind.'}),"\n",(0,s.jsx)(n.h3,{id:"practical-use-cases",children:"Practical Use Cases"}),"\n",(0,s.jsx)(n.p,{children:"Using gosu in the ENTRYPOINT script of a Docker container is a typical use case, especially when we need to downgrade from the root user to a non-privileged user to perform certain operations. This practice is crucial for safeguarding the security of the container runtime environment, as it effectively reduces potential security risks."}),"\n",(0,s.jsx)(n.p,{children:"Installing gosu is straightforward, usually requiring just a few lines in the Dockerfile for installation and configuration. The following example demonstrates how to install gosu in a Dockerfile and dynamically create users and groups using an entrypoint script, then use gosu to execute commands with the specified user identity."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-Dockerfile",metastring:'title="Dockerfile"',children:'# Based on an existing base image\nFROM some_base_image:latest\n\nWORKDIR /app\n\n# Install gosu\nRUN apt-get update && apt-get install -y gosu && rm -rf /var/lib/apt/lists/*\n\n# Prepare entrypoint script\nCOPY entrypoint.sh /entrypoint.sh\nRUN chmod +x /entrypoint.sh\n\nENTRYPOINT ["/entrypoint.sh"]\nCMD ["default_command"]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["The example content of the ",(0,s.jsx)(n.code,{children:"entrypoint.sh"})," script is as follows. It dynamically creates a user and group based on the environment variables USER_ID and GROUP_ID, then executes a command using gosu:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title="entrypoint.sh"',children:'#!/bin/bash\n# Check if USER_ID and GROUP_ID environment variables are set\nif [ ! -z "$USER_ID" ] && [ ! -z "$GROUP_ID" ]; then\n    # Create group and user\n    groupadd -g "$GROUP_ID" usergroup\n    useradd -u "$USER_ID" -g usergroup -m user\n    # Execute command using gosu\n    exec gosu user "$@"\nelse\n    exec "$@"\nfi\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For a real-world example, refer to: ",(0,s.jsx)(n.a,{href:"https://github.com/DocsaidLab/DocClassifier/blob/main/docker/Dockerfile",children:(0,s.jsx)(n.strong,{children:"DocClassifier training docker"})})]}),"\n",(0,s.jsx)(n.h3,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,s.jsxs)(n.p,{children:["While gosu's primary purpose is to switch from the ",(0,s.jsx)(n.code,{children:"root"})," user to a non-privileged user during container startup, its developers also emphasize potential security risks associated with using gosu in certain contexts."]}),"\n",(0,s.jsx)(n.p,{children:"This is because any tool that allows user switching, if misused, could open doors to security vulnerabilities. Therefore, development and operations teams need to have a thorough understanding of gosu's usage scenarios and ensure it is only used in secure environments."})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},31304:(e,n,t)=>{t.d(n,{A:()=>s});const s=t.p+"assets/images/0203-ee58f02227c5bb39005c313c2fa21c5e.webp"},28453:(e,n,t)=>{t.d(n,{R:()=>r,x:()=>a});var s=t(96540);const i={},o=s.createContext(i);function r(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);