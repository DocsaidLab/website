"use strict";(self.webpackChunkdocsaid_website=self.webpackChunkdocsaid_website||[]).push([["9194"],{50807:function(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>r,metadata:()=>t,toc:()=>l});var t=i(74669),s=i(74848),o=i(84429);let r={slug:"gosu-usage",title:"User Switching Tool in Containers: gosu",authors:"Z. Yuan",tags:["docker","gosu"],image:"/en/img/2024/0203.webp",description:"A tool that is so useful, you definitely need to learn how to use it."},a,c={authorsImageUrls:[void 0]},l=[{value:"Common Problems",id:"common-problems",level:2},{value:"TTY Conversion",id:"tty-conversion",level:3},{value:"Signal Forwarding",id:"signal-forwarding",level:3},{value:"What is gosu?",id:"what-is-gosu",level:2},{value:"Practical Use Case",id:"practical-use-case",level:3},{value:"Security Considerations",id:"security-considerations",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Docker technology has been widely used in deployment and management."}),"\n",(0,s.jsx)(n.p,{children:"We often package various applications and their dependencies together to ensure consistent operation across different environments."}),"\n",(0,s.jsx)(n.h2,{id:"common-problems",children:"Common Problems"}),"\n",(0,s.jsx)(n.p,{children:"However, if you use it frequently, you're bound to run into a few common issues."}),"\n",(0,s.jsx)(n.h3,{id:"tty-conversion",children:"TTY Conversion"}),"\n",(0,s.jsx)(n.p,{children:"A common situation is when you output a file inside the container."}),"\n",(0,s.jsx)(n.p,{children:"After exiting the container, you may notice that the file permissions are set to root."}),"\n",(0,s.jsxs)(n.p,{children:["At this point, you need to use ",(0,s.jsx)(n.code,{children:"chown"})," to change the file's permissions."]}),"\n",(0,s.jsx)(n.p,{children:"Over and over again, isn't that annoying?"}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.p,{children:["Another case is when using ",(0,s.jsx)(n.code,{children:"sudo"})," to start an interactive application inside a Docker container. These applications may not correctly detect the terminal because ",(0,s.jsx)(n.code,{children:"sudo"})," may not handle the terminal's ownership and control properly when creating a new session."]}),"\n",(0,s.jsx)(n.p,{children:"As a result, applications that need terminal interaction may not work properly or encounter input/output errors when trying to use them."}),"\n",(0,s.jsx)(n.h3,{id:"signal-forwarding",children:"Signal Forwarding"}),"\n",(0,s.jsx)(n.p,{children:"Suppose you have a container running a web server, like Apache or Nginx."}),"\n",(0,s.jsxs)(n.p,{children:["Typically, you might use command-line tools to manage the container, including starting and stopping it. Inside the container, if you start the web server using ",(0,s.jsx)(n.code,{children:"sudo"}),", then ",(0,s.jsx)(n.code,{children:"sudo"})," will create a new process to run the web server."]}),"\n",(0,s.jsxs)(n.p,{children:["The problem arises when you want to stop or restart the container. The container management system will send a signal (like SIGTERM) to notify the processes inside the container to stop. However, if the web server is started via ",(0,s.jsx)(n.code,{children:"sudo"}),", this signal may only be sent to the ",(0,s.jsx)(n.code,{children:"sudo"})," process, not the actual web server process. This means the web server may not receive the stop signal and thus cannot perform proper cleanup and shutdown."]}),"\n",(0,s.jsxs)(n.admonition,{type:"tip",children:[(0,s.jsxs)(n.p,{children:["The design of ",(0,s.jsx)(n.code,{children:"sudo"})," is to improve security, allowing regular users to execute commands as other users (typically root). In this process, ",(0,s.jsx)(n.code,{children:"sudo"})," creates a new session to execute the command."]}),(0,s.jsxs)(n.p,{children:["This behavior typically doesn\u2019t cause issues in traditional operating system environments, but in lightweight virtualization environments like containers, it may lead to signal forwarding problems, as the new session created by ",(0,s.jsx)(n.code,{children:"sudo"})," may not be compatible with the way the container management system sends signals."]})]}),"\n",(0,s.jsx)(n.h2,{id:"what-is-gosu",children:"What is gosu?"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://github.com/tianon/gosu",children:(0,s.jsx)(n.strong,{children:"gosu GitHub repository"})})}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"gosu is a tool specifically designed for containers. Its purpose is to make it easier and safer to execute commands inside containers."}),"\n",(0,s.jsxs)(n.p,{children:["When you need to run a program as a different user (e.g., switching from the admin user to a regular user), gosu comes in handy. Its core functionality is directly inspired by the way ",(0,s.jsx)(n.code,{children:"Docker/libcontainer"})," launches applications inside containers (in fact, it directly uses the ",(0,s.jsx)(n.code,{children:"/etc/passwd"})," handling code from the ",(0,s.jsx)(n.code,{children:"libcontainer"})," codebase)."]}),"\n",(0,s.jsx)(n.p,{children:'If you\'re not interested in the technical details, simply put, gosu is like an assistant: when you tell it "please run this command as this user," it does it for you and then exits, leaving no trace behind.'}),"\n",(0,s.jsx)(n.h3,{id:"practical-use-case",children:"Practical Use Case"}),"\n",(0,s.jsx)(n.p,{children:"The most common use of gosu is in Docker entrypoint scripts, where it downgrades the container from the root user to a regular user to avoid permission issues."}),"\n",(0,s.jsx)(n.p,{children:"Here\u2019s an example:"}),"\n",(0,s.jsx)(n.p,{children:"First, add a few lines to your Dockerfile to install gosu:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-Dockerfile",metastring:'title="Dockerfile"',children:'# Base the image on an existing base image\nFROM some_base_image:latest\n\nWORKDIR /app\n\n# Install gosu\nRUN apt-get update && apt-get install -y gosu && rm -rf /var/lib/apt/lists/*\n\n# Prepare the entrypoint script\nCOPY entrypoint.sh /entrypoint.sh\nRUN chmod +x /entrypoint.sh\n\nENTRYPOINT ["/entrypoint.sh"]\nCMD ["default_command"]\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Next, create an entrypoint script ",(0,s.jsx)(n.code,{children:"entrypoint.sh"}),", which dynamically creates users based on environment variables and then uses gosu to switch users to run the command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",metastring:'title="entrypoint.sh"',children:'#!/bin/bash\n# Check if USER_ID and GROUP_ID environment variables are set\nif [ ! -z "$USER_ID" ] && [ ! -z "$GROUP_ID" ]; then\n    # Create user group and user\n    groupadd -g "$GROUP_ID" usergroup\n    useradd -u "$USER_ID" -g usergroup -m user\n    # Use gosu to execute the command\n    exec gosu user "$@"\nelse\n    exec "$@"\nfi\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For a real example, refer to: ",(0,s.jsx)(n.a,{href:"https://github.com/DocsaidLab/Otter/blob/main/docker/Dockerfile",children:(0,s.jsx)(n.strong,{children:"Example training docker"})})]}),"\n",(0,s.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,s.jsx)(n.p,{children:"While gosu is very convenient in container environments, developers have pointed out potential security risks. Any tool that allows user identity switching should be used cautiously."}),"\n",(0,s.jsx)(n.p,{children:"It\u2019s like the key to your house: while it's very useful, if misused, it might leave your security door wide open. Therefore, when using gosu, teams should ensure they fully understand the use case to avoid abuse in unsafe scenarios."}),"\n",(0,s.jsxs)(n.p,{children:["For related discussions, refer to: ",(0,s.jsx)(n.a,{href:"https://github.com/tianon/gosu/issues/37",children:(0,s.jsx)(n.strong,{children:"Keeping the TTY across a privilege boundary might be insecure #37"})})]}),"\n",(0,s.jsxs)(n.admonition,{type:"info",children:[(0,s.jsx)(n.p,{children:"I know you\u2019re too lazy to read, so here\u2019s a brief excerpt of the key points:"}),(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"A developer raised concerns that keeping TTY across a privilege boundary might pose a security risk."})}),(0,s.jsx)(n.p,{children:"When a program switches from high to low privilege, if a new virtual terminal is not created, file descriptors (such as standard input/output) that were not closed in the parent process might be used by the new process. Using the TIOCSTI ioctl call, an attacker can inject input characters into the TTY buffer, simulating keyboard input and executing unauthorized commands. This type of vulnerability is allowed by design."}),(0,s.jsx)(n.p,{children:'For example, the following code will inject "id\\n" character by character into standard input:'}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-c",children:'#include <unistd.h>\n#include <sys/ioctl.h>\n#include <stdio.h>\n\nint main()\n{\n    for (char *cmd = "id\\n"; *cmd; cmd++) {\n        if (ioctl(STDIN_FILENO, TIOCSTI, cmd)) {\n            fprintf(stderr, "ioctl failed\\n");\n            return 1;\n        }\n    }\n    return 0;\n}\n'})}),(0,s.jsx)(n.p,{children:"This code is considered malicious because it deliberately uses the TIOCSTI ioctl call to simulate keyboard input and inject commands into the terminal without user interaction. This allows for malicious injection or privilege escalation attacks, making it a security risk."}),(0,s.jsx)(n.p,{children:"Since Docker assigns a new TTY and replaces the parent shell, the injected commands cannot affect the host or the original terminal, so the risk is lower. In unexpected interactive environments, if you run gosu directly in the terminal without replacing the original TTY, an attacker\u2019s program could successfully inject commands, creating a security vulnerability."}),(0,s.jsx)(n.p,{children:"However, this vulnerability primarily affects unintended usage scenarios. If used as designed, such as in Docker containers as an entrypoint with Docker assigning a new TTY, the risk is significantly reduced."}),(0,s.jsx)(n.p,{children:"Therefore, as long as it's used in the intended environment, there's no need to overly worry about the risk."})]})]})}function u(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},84429:function(e,n,i){i.d(n,{R:()=>r,x:()=>a});var t=i(96540);let s={},o=t.createContext(s);function r(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}},74669:function(e){e.exports=JSON.parse('{"permalink":"/en/blog/gosu-usage","source":"@site/i18n/en/docusaurus-plugin-content-blog/2024/02-03-usage-gosu/index.md","title":"User Switching Tool in Containers: gosu","description":"A tool that is so useful, you definitely need to learn how to use it.","date":"2024-02-03T00:00:00.000Z","tags":[{"inline":true,"label":"docker","permalink":"/en/blog/tags/docker"},{"inline":true,"label":"gosu","permalink":"/en/blog/tags/gosu"}],"readingTime":5.25,"hasTruncateMarker":true,"authors":[{"name":"Z. Yuan","title":"Dosaid maintainer, Full-Stack AI Engineer","url":"https://github.com/zephyr-sh","socials":{"github":"https://github.com/zephyr-sh","linkedin":"https://www.linkedin.com/in/ze-yuan-sh7/"},"imageURL":"https://github.com/zephyr-sh.png","key":"Z. Yuan","page":null}],"frontMatter":{"slug":"gosu-usage","title":"User Switching Tool in Containers: gosu","authors":"Z. Yuan","tags":["docker","gosu"],"image":"/en/img/2024/0203.webp","description":"A tool that is so useful, you definitely need to learn how to use it."},"unlisted":false,"prevItem":{"title":"Daily Error Troubleshooting Log","permalink":"/en/blog/error-record"},"nextItem":{"title":"Building a New Computer","permalink":"/en/blog/buy-a-new-computer"}}')}}]);